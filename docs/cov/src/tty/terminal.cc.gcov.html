<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - main_coverage.info - src/tty/terminal.cc</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/tty</a> - terminal.cc<span style="font-size: 80%;"> (source / <a href="terminal.cc.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">main_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">744</td>
            <td class="headerCovTableEntry">776</td>
            <td class="headerCovTableEntryHi">95.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2022-06-15 20:16:21</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">72</td>
            <td class="headerCovTableEntry">80</td>
            <td class="headerCovTableEntryHi">90.0 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">431</td>
            <td class="headerCovTableEntry">640</td>
            <td class="headerCovTableEntryLo">67.3 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : #ifdef RUN_TESTS</a>
<a name="2"><span class="lineNum">       2 </span>                :            : # include &lt;gtest/gtest.h&gt;</a>
<a name="3"><span class="lineNum">       3 </span>                :            : #endif</a>
<a name="4"><span class="lineNum">       4 </span>                :            : /** @file tty/terminal.cc</a>
<a name="5"><span class="lineNum">       5 </span>                :            :  * @brief Defines TerminalWindow, the bulk of the terminal emulator. Its main purpose is to render anything that is printed by the subprocess.</a>
<a name="6"><span class="lineNum">       6 </span>                :            :  */</a>
<a name="7"><span class="lineNum">       7 </span>                :            : </a>
<a name="8"><span class="lineNum">       8 </span>                :            : #include &lt;array&gt;</a>
<a name="9"><span class="lineNum">       9 </span>                :            : #include &lt;cstdio&gt; // sprintf</a>
<a name="10"><span class="lineNum">      10 </span>                :            : </a>
<a name="11"><span class="lineNum">      11 </span>                :            : #include &lt;SDL.h&gt; // for window title</a>
<a name="12"><span class="lineNum">      12 </span>                :            : </a>
<a name="13"><span class="lineNum">      13 </span>                :            : #include &quot;terminal.hh&quot;</a>
<a name="14"><span class="lineNum">      14 </span>                :            : #include &quot;ctype.hh&quot;</a>
<a name="15"><span class="lineNum">      15 </span>                :            : #include &quot;256color.hh&quot;</a>
<a name="16"><span class="lineNum">      16 </span>                :            : #include &quot;color.hh&quot;</a>
<a name="17"><span class="lineNum">      17 </span>                :            : #include &quot;ui.hh&quot;</a>
<a name="18"><span class="lineNum">      18 </span>                :            : </a>
<a name="19"><span class="lineNum">      19 </span>                :<span class="lineCov">        403 : void TerminalWindow::ResetAttr()</span></a>
<a name="20"><span class="lineNum">      20 </span>                :            : {</a>
<a name="21"><span class="lineNum">      21 </span>                :<span class="lineCov">        403 :     bool prot = wnd.blank.protect;</span></a>
<a name="22"><span class="lineNum">      22 </span>                :<span class="lineCov">        403 :     wnd.blank = Cell{};</span></a>
<a name="23"><span class="lineNum">      23 </span>                :<span class="lineCov">        403 :     wnd.blank.protect = prot;</span></a>
<a name="24"><span class="lineNum">      24 </span>                :<span class="lineCov">        403 : }</span></a>
<a name="25"><span class="lineNum">      25 </span>                :<span class="lineCov">        401 : void TerminalWindow::Reset(bool full)</span></a>
<a name="26"><span class="lineNum">      26 </span>                :            : {</a>
<a name="27"><span class="lineNum">      27 </span>                :<span class="lineCov">        401 :     top    = 0;</span></a>
<a name="28"><span class="lineNum">      28 </span>                :<span class="lineCov">        401 :     bottom = wnd.ysize-1;</span></a>
<a name="29"><span class="lineNum">      29 </span>                :            : </a>
<a name="30"><span class="lineNum">      30 </span>                :<span class="lineCov">        401 :     gset = {0,0,0,0}; activeset = 0; scs = 0;</span></a>
<a name="31"><span class="lineNum">      31 </span>                :<span class="lineCov">        401 :     utfmode = 0;</span></a>
<a name="32"><span class="lineNum">      32 </span>                :<span class="lineCov">        401 :     lastch = U' ';</span></a>
<a name="33"><span class="lineNum">      33 </span>                :            : </a>
<a name="34"><span class="lineNum">      34 </span>                :<span class="lineCov">        401 :     state = 0;</span></a>
<a name="35"><span class="lineNum">      35 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 401 times"> + </span>]:<span class="lineCov">        401 :     p.clear();</span></a>
<a name="36"><span class="lineNum">      36 </span>                :            : </a>
<a name="37"><span class="lineNum">      37 </span>                :<span class="lineCov">        401 :     wnd.inverse   = false;</span></a>
<a name="38"><span class="lineNum">      38 </span>                :<span class="lineCov">        401 :     wnd.cursorvis = true;</span></a>
<a name="39"><span class="lineNum">      39 </span>        [<span class="branchCov" title="Branch 0 was taken 400 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">        401 :     if(full)</span></a>
<a name="40"><span class="lineNum">      40 </span>                :            :     {</a>
<a name="41"><span class="lineNum">      41 </span>                :<span class="lineCov">        400 :         edgeflag = false;</span></a>
<a name="42"><span class="lineNum">      42 </span>                :<span class="lineCov">        400 :         wnd.cursx = 0;</span></a>
<a name="43"><span class="lineNum">      43 </span>                :<span class="lineCov">        400 :         wnd.cursy = 0;</span></a>
<a name="44"><span class="lineNum">      44 </span>                :<span class="lineCov">        400 :         wnd.FillBox(0,0, wnd.xsize,wnd.ysize, wnd.blank); // Clear screen</span></a>
<a name="45"><span class="lineNum">      45 </span>                :            :     }</a>
<a name="46"><span class="lineNum">      46 </span>                :<span class="lineCov">        401 : }</span></a>
<a name="47"><span class="lineNum">      47 </span>                :            : </a>
<a name="48"><span class="lineNum">      48 </span>                :<span class="lineCov">          2 : void TerminalWindow::YScrollDown(unsigned y1, unsigned y2, int amount) const</span></a>
<a name="49"><span class="lineNum">      49 </span>                :            : {</a>
<a name="50"><span class="lineNum">      50 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :     if(amount &lt;= 0) return;</span></a>
<a name="51"><span class="lineNum">      51 </span>                :<span class="lineCov">          2 :     unsigned hei = y2-y1+1;</span></a>
<a name="52"><span class="lineNum">      52 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :     if(unsigned(amount) &gt; hei) amount = hei;</span></a>
<a name="53"><span class="lineNum">      53 </span>                :            :     //fprintf(stderr, &quot;Height=%d, amount=%d, scrolling DOWN by %d lines\n&quot;, hei,amount, hei-amount);</a>
<a name="54"><span class="lineNum">      54 </span>                :<span class="lineCov">          2 :     wnd.CopyText(0,y1+amount, 0,y1, wnd.xsize,hei-amount);</span></a>
<a name="55"><span class="lineNum">      55 </span>                :<span class="lineCov">          2 :     wnd.FillBox(0,y1, wnd.xsize,amount);</span></a>
<a name="56"><span class="lineNum">      56 </span>                :            : }</a>
<a name="57"><span class="lineNum">      57 </span>                :            : </a>
<a name="58"><span class="lineNum">      58 </span>                :<span class="lineCov">         25 : void TerminalWindow::YScrollUp(unsigned y1, unsigned y2, int amount) const</span></a>
<a name="59"><span class="lineNum">      59 </span>                :            : {</a>
<a name="60"><span class="lineNum">      60 </span>        [<span class="branchCov" title="Branch 0 was taken 25 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         25 :     if(amount &lt;= 0) return;</span></a>
<a name="61"><span class="lineNum">      61 </span>                :<span class="lineCov">         25 :     unsigned hei = y2-y1+1;</span></a>
<a name="62"><span class="lineNum">      62 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 25 times"> + </span>]:<span class="lineCov">         25 :     if(unsigned(amount) &gt; hei) amount = hei;</span></a>
<a name="63"><span class="lineNum">      63 </span>                :            :     //fprintf(stderr, &quot;Height=%d, amount=%d, scrolling UP by %d lines\n&quot;, hei,amount, hei-amount);</a>
<a name="64"><span class="lineNum">      64 </span>                :<span class="lineCov">         25 :     wnd.CopyText(0,y1, 0,y1+amount, wnd.xsize,hei-amount);</span></a>
<a name="65"><span class="lineNum">      65 </span>                :<span class="lineCov">         25 :     wnd.FillBox(0,y2-amount+1, wnd.xsize,amount);</span></a>
<a name="66"><span class="lineNum">      66 </span>                :            : }</a>
<a name="67"><span class="lineNum">      67 </span>                :            : </a>
<a name="68"><span class="lineNum">      68 </span>                :<span class="lineCov">        773 : void TerminalWindow::Write(std::u32string_view s)</span></a>
<a name="69"><span class="lineNum">      69 </span>                :            : {</a>
<a name="70"><span class="lineNum">      70 </span>                :<span class="lineCov">        773 :     unsigned color = 0;</span></a>
<a name="71"><span class="lineNum">      71 </span>                :            :     /** Repositions cursor horizontally and ensures the new location is within allowed range. */</a>
<a name="72"><span class="lineNum">      72 </span>                :<span class="lineCov">        970 :     auto ClampedMoveX = [&amp;](int tgtx)</span></a>
<a name="73"><span class="lineNum">      73 </span>                :            :     {</a>
<a name="74"><span class="lineNum">      74 </span>  [<span class="branchCov" title="Branch 0 was taken 161 times"> + </span><span class="branchCov" title="Branch 1 was taken 36 times"> + </span><span class="branchCov" title="Branch 2 was taken 90 times"> + </span><span class="branchCov" title="Branch 3 was taken 107 times"> + </span>]:<span class="lineCov">        358 :         wnd.cursx = std::min(std::size_t(std::max(0,tgtx)), wnd.xsize-1);</span></a>
<a name="75"><span class="lineNum">      75 </span>                :<span class="lineCov">        197 :         edgeflag = false;</span></a>
<a name="76"><span class="lineNum">      76 </span>                :<span class="lineCov">        970 :     };</span></a>
<a name="77"><span class="lineNum">      77 </span>                :            :     /** Repositions cursor vertically and ensures the new location is within allowed range.</a>
<a name="78"><span class="lineNum">      78 </span>                :            :      * param tgty = Target y coordinate</a>
<a name="79"><span class="lineNum">      79 </span>                :            :      * param strict = If set, only permits moving inside current window; otherwise permits moving anywhere on screen.</a>
<a name="80"><span class="lineNum">      80 </span>                :            :      */</a>
<a name="81"><span class="lineNum">      81 </span>                :<span class="lineCov">        966 :     auto ClampedMoveY = [&amp;](int tgty, bool strict = true)</span></a>
<a name="82"><span class="lineNum">      82 </span>                :            :     {</a>
<a name="83"><span class="lineNum">      83 </span>  [<span class="branchCov" title="Branch 0 was taken 193 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 193 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">        193 :         if(wnd.cursy &gt;= top &amp;&amp; wnd.cursy &lt;= bottom &amp;&amp; strict)</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 145 times"> + </span><span class="branchCov" title="Branch 5 was taken 48 times"> + </span>]
<a name="84"><span class="lineNum">      84 </span>                :            :         {</a>
<a name="85"><span class="lineNum">      85 </span>                :            :             // Only permit moving inside window</a>
<a name="86"><span class="lineNum">      86 </span>  [<span class="branchCov" title="Branch 0 was taken 142 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 144 times"> + </span>]:<span class="lineCov">        288 :             wnd.cursy = std::min(std::size_t(std::max(int(top), tgty)), bottom);</span></a>
<a name="87"><span class="lineNum">      87 </span>                :            :         }</a>
<a name="88"><span class="lineNum">      88 </span>                :            :         else</a>
<a name="89"><span class="lineNum">      89 </span>                :            :         {</a>
<a name="90"><span class="lineNum">      90 </span>                :            :             // Permit moving anywhere</a>
<a name="91"><span class="lineNum">      91 </span>  [<span class="branchCov" title="Branch 0 was taken 28 times"> + </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 46 times"> + </span>]:<span class="lineCov">         78 :             wnd.cursy = std::min(std::size_t(std::max(0,tgty)), wnd.ysize-1);</span></a>
<a name="92"><span class="lineNum">      92 </span>                :            :         }</a>
<a name="93"><span class="lineNum">      93 </span>                :<span class="lineCov">        966 :     };</span></a>
<a name="94"><span class="lineNum">      94 </span>                :            :     /** Combination of ClampedMoveX and ClampedMoveY. */</a>
<a name="95"><span class="lineNum">      95 </span>                :<span class="lineCov">        820 :     auto ClampedMove = [&amp;](int tgtx, int tgty, bool strict = true)</span></a>
<a name="96"><span class="lineNum">      96 </span>                :            :     {</a>
<a name="97"><span class="lineNum">      97 </span>                :<span class="lineCov">         47 :         ClampedMoveX(tgtx);</span></a>
<a name="98"><span class="lineNum">      98 </span>                :<span class="lineCov">         47 :         ClampedMoveY(tgty, strict);</span></a>
<a name="99"><span class="lineNum">      99 </span>                :<span class="lineCov">        820 :     };</span></a>
<a name="100"><span class="lineNum">     100 </span>                :            :     /** Performs line feed. */</a>
<a name="101"><span class="lineNum">     101 </span>                :<span class="lineCov">        924 :     auto Lf = [&amp;]</span></a>
<a name="102"><span class="lineNum">     102 </span>                :            :     {</a>
<a name="103"><span class="lineNum">     103 </span>        [<span class="branchCov" title="Branch 0 was taken 23 times"> + </span><span class="branchCov" title="Branch 1 was taken 128 times"> + </span>]:<span class="lineCov">        151 :         if(wnd.cursy == bottom)</span></a>
<a name="104"><span class="lineNum">     104 </span>                :<span class="lineCov">         23 :             YScrollUp(top, bottom, 1);</span></a>
<a name="105"><span class="lineNum">     105 </span>                :            :         else</a>
<a name="106"><span class="lineNum">     106 </span>                :<span class="lineCov">        128 :             ClampedMoveY(wnd.cursy+1);</span></a>
<a name="107"><span class="lineNum">     107 </span>                :<span class="lineCov">        924 :     };</span></a>
<a name="108"><span class="lineNum">     108 </span>                :            :     /** Performs typewriter write for one character. */</a>
<a name="109"><span class="lineNum">     109 </span>                :<span class="lineCov">       6862 :     auto PutC = [&amp;](char32_t c, bool doublewidth)</span></a>
<a name="110"><span class="lineNum">     110 </span>                :            :     {</a>
<a name="111"><span class="lineNum">     111 </span>        [<span class="branchCov" title="Branch 0 was taken 135 times"> + </span><span class="branchCov" title="Branch 1 was taken 5954 times"> + </span>]:<span class="lineCov">       6089 :         if(edgeflag)</span></a>
<a name="112"><span class="lineNum">     112 </span>                :            :         {</a>
<a name="113"><span class="lineNum">     113 </span>        [<span class="branchCov" title="Branch 0 was taken 135 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        135 :             if(wnd.cursx == wnd.xsize-1)</span></a>
<a name="114"><span class="lineNum">     114 </span>                :            :             {</a>
<a name="115"><span class="lineNum">     115 </span>                :<span class="lineCov">        135 :                 Lf();</span></a>
<a name="116"><span class="lineNum">     116 </span>                :<span class="lineCov">        135 :                 wnd.cursx = 0;</span></a>
<a name="117"><span class="lineNum">     117 </span>                :            :             }</a>
<a name="118"><span class="lineNum">     118 </span>                :<span class="lineCov">        135 :             edgeflag = false;</span></a>
<a name="119"><span class="lineNum">     119 </span>                :            :         }</a>
<a name="120"><span class="lineNum">     120 </span>                :<span class="lineCov">       6089 :         wnd.PutCh(wnd.cursx,wnd.cursy, c, gset[activeset]);</span></a>
<a name="121"><span class="lineNum">     121 </span>        [<span class="branchCov" title="Branch 0 was taken 138 times"> + </span><span class="branchCov" title="Branch 1 was taken 5951 times"> + </span>]:<span class="lineCov">       6089 :         if(wnd.cursx == wnd.xsize-1) edgeflag = true;</span></a>
<a name="122"><span class="lineNum">     122 </span>                :<span class="lineCov">       5951 :         else                         ++wnd.cursx;</span></a>
<a name="123"><span class="lineNum">     123 </span>                :            : </a>
<a name="124"><span class="lineNum">     124 </span>        [<span class="branchCov" title="Branch 0 was taken 32 times"> + </span><span class="branchCov" title="Branch 1 was taken 6057 times"> + </span>]:<span class="lineCov">       6089 :         if(doublewidth)</span></a>
<a name="125"><span class="lineNum">     125 </span>                :            :         {</a>
<a name="126"><span class="lineNum">     126 </span>                :            :             // If this character was double-width,</a>
<a name="127"><span class="lineNum">     127 </span>                :            :             // skip the next column but mark it also dirty.</a>
<a name="128"><span class="lineNum">     128 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 32 times"> + </span>]:<span class="lineCov">         32 :             wnd.Dirtify(wnd.cursx,wnd.cursy);</span></a>
<a name="129"><span class="lineNum">     129 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 32 times"> + </span>]:<span class="lineCov">         32 :             if(wnd.cursx == wnd.xsize-1) edgeflag = true;</span></a>
<a name="130"><span class="lineNum">     130 </span>                :<span class="lineCov">         32 :             else                         ++wnd.cursx;</span></a>
<a name="131"><span class="lineNum">     131 </span>                :            :         }</a>
<a name="132"><span class="lineNum">     132 </span>                :<span class="lineCov">       6862 :     };</span></a>
<a name="133"><span class="lineNum">     133 </span>                :            : </a>
<a name="134"><span class="lineNum">     134 </span>                :<span class="lineCov">        773 :     enum : unsigned {</span></a>
<a name="135"><span class="lineNum">     135 </span>                :            :         MODE38_2 = 70,  MODE38_2_x1, MODE38_2_x2, MODE_38_x = 108,</a>
<a name="136"><span class="lineNum">     136 </span>                :            :         MODE38_3 = 80,  MODE38_3_x1, MODE38_3_x2, MODE38_5 = 56,</a>
<a name="137"><span class="lineNum">     137 </span>                :            :         MODE48_2 = 87,  MODE48_2_x1, MODE48_2_x2, MODE_48_x = 109,</a>
<a name="138"><span class="lineNum">     138 </span>                :            :         MODE48_3 = 111, MODE48_3_x1, MODE48_3_x2, MODE48_5 = 57,</a>
<a name="139"><span class="lineNum">     139 </span>                :            :         MODE58_2 = 114, MODE58_2_x1, MODE58_2_x2, MODE_58_x = 110,</a>
<a name="140"><span class="lineNum">     140 </span>                :            :         MODE58_3 = 117, MODE58_3_x1, MODE58_3_x2, MODE58_5 = 99,</a>
<a name="141"><span class="lineNum">     141 </span>                :            :         MODE38_4 = 66,  MODE38_4_x1, MODE38_4_x2, MODE38_4_x3,</a>
<a name="142"><span class="lineNum">     142 </span>                :            :         MODE48_4 = 76,  MODE48_4_x1, MODE48_4_x2, MODE48_4_x3,</a>
<a name="143"><span class="lineNum">     143 </span>                :            :         MODE58_4 = 83,  MODE58_4_x1, MODE58_4_x2, MODE58_4_x3,</a>
<a name="144"><span class="lineNum">     144 </span>                :            :     };</a>
<a name="145"><span class="lineNum">     145 </span>                :<span class="lineCov">        773 :     static_assert(MODE38_4_x1 == MODE38_4+1);    static_assert(MODE38_3_x1 == MODE38_3+1);    static_assert(MODE38_2_x1 == MODE38_2+1);</span></a>
<a name="146"><span class="lineNum">     146 </span>                :<span class="lineCov">        773 :     static_assert(MODE48_4_x1 == MODE48_4+1);    static_assert(MODE48_3_x1 == MODE48_3+1);    static_assert(MODE48_2_x1 == MODE48_2+1);</span></a>
<a name="147"><span class="lineNum">     147 </span>                :<span class="lineCov">        773 :     static_assert(MODE58_4_x1 == MODE58_4+1);    static_assert(MODE58_3_x1 == MODE58_3+1);    static_assert(MODE58_2_x1 == MODE58_2+1);</span></a>
<a name="148"><span class="lineNum">     148 </span>                :<span class="lineCov">        773 :     static_assert(MODE38_4_x2 == MODE38_4_x1+1); static_assert(MODE38_3_x2 == MODE38_3_x1+1); static_assert(MODE38_2_x2 == MODE38_2_x1+1);</span></a>
<a name="149"><span class="lineNum">     149 </span>                :<span class="lineCov">        773 :     static_assert(MODE48_4_x2 == MODE48_4_x1+1); static_assert(MODE48_3_x2 == MODE48_3_x1+1); static_assert(MODE48_2_x2 == MODE48_2_x1+1);</span></a>
<a name="150"><span class="lineNum">     150 </span>                :<span class="lineCov">        773 :     static_assert(MODE58_4_x2 == MODE58_4_x1+1); static_assert(MODE58_3_x2 == MODE58_3_x1+1); static_assert(MODE58_2_x2 == MODE58_2_x1+1);</span></a>
<a name="151"><span class="lineNum">     151 </span>                :<span class="lineCov">        773 :     static_assert(MODE38_4_x3 == MODE38_4_x2+1);</span></a>
<a name="152"><span class="lineNum">     152 </span>                :<span class="lineCov">        773 :     static_assert(MODE48_4_x3 == MODE48_4_x2+1);</span></a>
<a name="153"><span class="lineNum">     153 </span>                :<span class="lineCov">        773 :     static_assert(MODE58_4_x3 == MODE58_4_x2+1);</span></a>
<a name="154"><span class="lineNum">     154 </span>                :<span class="lineCov">        773 :     static_assert(MODE_48_x == MODE_38_x+1); static_assert(MODE_58_x == MODE_48_x+1);</span></a>
<a name="155"><span class="lineNum">     155 </span>                :            :     /* Translation maps for ProcessSGR for a smaller jump table */</a>
<a name="156"><span class="lineNum">     156 </span>                :<span class="lineCov">        773 :     auto M = [](unsigned n) constexpr -&gt; unsigned char</span></a>
<a name="157"><span class="lineNum">     157 </span>                :            :     {</a>
<a name="158"><span class="lineNum">     158 </span>                :            :         // 16? 36, 37?</a>
<a name="159"><span class="lineNum">     159 </span>                :            :         unsigned char result = 0;</a>
<a name="160"><span class="lineNum">     160 </span>                :            :         // SKIP the following, as they are not implemented:</a>
<a name="161"><span class="lineNum">     161 </span>                :            :         //   8 (conceal)</a>
<a name="162"><span class="lineNum">     162 </span>                :            :         //  20 (fraktur)</a>
<a name="163"><span class="lineNum">     163 </span>                :            :         //  26 (proportional)</a>
<a name="164"><span class="lineNum">     164 </span>                :            :         //  28 (clear conceal)</a>
<a name="165"><span class="lineNum">     165 </span>                :            :         //  50 (clear proportional)</a>
<a name="166"><span class="lineNum">     166 </span>                :            :         //  51-52 (framed &amp; encircled)</a>
<a name="167"><span class="lineNum">     167 </span>                :            :         //  54 (clear framed &amp; encircled)</a>
<a name="168"><span class="lineNum">     168 </span>                :            :         //  59 (default underline color)</a>
<a name="169"><span class="lineNum">     169 </span>                :            :         //  60-65 (ideogram settings)</a>
<a name="170"><span class="lineNum">     170 </span>                :            :         //  73-75 (superscript &amp; subscript settings)</a>
<a name="171"><span class="lineNum">     171 </span>                :            :         // This makes the code smaller. They can be enabled when implemented.</a>
<a name="172"><span class="lineNum">     172 </span>                :            :         //</a>
<a name="173"><span class="lineNum">     173 </span>                :            :         // Put most common things first</a>
<a name="174"><span class="lineNum">     174 </span>                :            :         if(/*n &gt;= 0 &amp;&amp;*/ n &lt;= 1) return result+n-0; else result += 2;</a>
<a name="175"><span class="lineNum">     175 </span>                :            :         //</a>
<a name="176"><span class="lineNum">     176 </span>                :            :         if(n &gt;= 30 &amp;&amp; n &lt;= 37) return result; else result+=1; // 2 -- handled by a single case</a>
<a name="177"><span class="lineNum">     177 </span>                :            :         if(n &gt;= 90 &amp;&amp; n &lt;= 97) return result; else result+=1; // 3 -- handled by a single case</a>
<a name="178"><span class="lineNum">     178 </span>                :            :         if(n == MODE38_5)      return result; else result+=1; // 4 -- fallback from above</a>
<a name="179"><span class="lineNum">     179 </span>                :            :         if(n == MODE38_2_x2)   return result; else result+=1; // 5 -- uncommon, but works as fallback from MODE38_5</a>
<a name="180"><span class="lineNum">     180 </span>                :            :         if(n == MODE38_3_x2)   return result; else result+=1; // 6</a>
<a name="181"><span class="lineNum">     181 </span>                :            :         if(n == MODE38_4_x3)   return result; else result+=1; // 7</a>
<a name="182"><span class="lineNum">     182 </span>                :            :         //</a>
<a name="183"><span class="lineNum">     183 </span>                :            :         if(n &gt;= 40 &amp;&amp; n &lt;= 47) return result; else result+=1; // 8 -- handled by a single case</a>
<a name="184"><span class="lineNum">     184 </span>                :            :         if(n &gt;=100 &amp;&amp; n &lt;=107) return result; else result+=1; // 9 -- handled by a single case</a>
<a name="185"><span class="lineNum">     185 </span>                :            :         if(n == MODE48_5)      return result; else result+=1; // 10 -- fallback from above</a>
<a name="186"><span class="lineNum">     186 </span>                :            :         if(n == MODE48_2_x2)   return result; else result+=1; // 11 -- uncommon, but works as fallback from MODE48_5</a>
<a name="187"><span class="lineNum">     187 </span>                :            :         if(n == MODE48_3_x2)   return result; else result+=1; // 12</a>
<a name="188"><span class="lineNum">     188 </span>                :            :         if(n == MODE48_4_x3)   return result; else result+=1; // 13</a>
<a name="189"><span class="lineNum">     189 </span>                :            :         //</a>
<a name="190"><span class="lineNum">     190 </span>                :            :         if(n == 38)            return result; else result+=1; // 14 -- sets MODE_38_x</a>
<a name="191"><span class="lineNum">     191 </span>                :            :         if(n == 48)            return result; else result+=1; // 15 -- sets MODE_48_x</a>
<a name="192"><span class="lineNum">     192 </span>                :            :         if(n == 58)            return result; else result+=1; // 16 -- sets MODE_58_x</a>
<a name="193"><span class="lineNum">     193 </span>                :            :         if(n == MODE_38_x</a>
<a name="194"><span class="lineNum">     194 </span>                :            :         || n == MODE_48_x</a>
<a name="195"><span class="lineNum">     195 </span>                :            :         || n == MODE_58_x)     return result; else result+=1; // 17 -- handled by a single case</a>
<a name="196"><span class="lineNum">     196 </span>                :            :         //</a>
<a name="197"><span class="lineNum">     197 </span>                :            :         if((n &gt;= MODE38_4 &amp;&amp; n &lt;= MODE38_4_x2)</a>
<a name="198"><span class="lineNum">     198 </span>                :            :         || (n &gt;= MODE38_3 &amp;&amp; n &lt;= MODE38_3_x1)</a>
<a name="199"><span class="lineNum">     199 </span>                :            :         || (n &gt;= MODE38_2 &amp;&amp; n &lt;= MODE38_2_x1)</a>
<a name="200"><span class="lineNum">     200 </span>                :            :         || (n &gt;= MODE48_4 &amp;&amp; n &lt;= MODE48_4_x2)</a>
<a name="201"><span class="lineNum">     201 </span>                :            :         || (n &gt;= MODE48_3 &amp;&amp; n &lt;= MODE48_3_x1)</a>
<a name="202"><span class="lineNum">     202 </span>                :            :         || (n &gt;= MODE48_2 &amp;&amp; n &lt;= MODE48_2_x1)</a>
<a name="203"><span class="lineNum">     203 </span>                :            :         || (n &gt;= MODE58_4 &amp;&amp; n &lt;= MODE58_4_x2)</a>
<a name="204"><span class="lineNum">     204 </span>                :            :         || (n &gt;= MODE58_3 &amp;&amp; n &lt;= MODE58_3_x1)</a>
<a name="205"><span class="lineNum">     205 </span>                :            :         || (n &gt;= MODE58_2 &amp;&amp; n &lt;= MODE58_2_x1)) return result; else result+=1; // 18 -- handled by a single case</a>
<a name="206"><span class="lineNum">     206 </span>                :            :         // Skip these, as they are not implemented:</a>
<a name="207"><span class="lineNum">     207 </span>                :            :         //if(n == MODE58_4_x3)                  return result; else result+=1;</a>
<a name="208"><span class="lineNum">     208 </span>                :            :         //if(n == MODE58_3_x2)                  return result; else result+=1;</a>
<a name="209"><span class="lineNum">     209 </span>                :            :         //if(n == MODE58_2_x2)                  return result; else result+=1;</a>
<a name="210"><span class="lineNum">     210 </span>                :            :         //if(n == MODE58_5)                     return result; else result+=1;</a>
<a name="211"><span class="lineNum">     211 </span>                :            :         //</a>
<a name="212"><span class="lineNum">     212 </span>                :            :         if(n == 39)            return result; else result+=1; // 19</a>
<a name="213"><span class="lineNum">     213 </span>                :            :         if(n == 49)            return result; else result+=1; // 20</a>
<a name="214"><span class="lineNum">     214 </span>                :            :         //</a>
<a name="215"><span class="lineNum">     215 </span>                :            :         if(n == 9)             return result; else result+=1; // 21</a>
<a name="216"><span class="lineNum">     216 </span>                :            :         if(n &gt;= 2 &amp;&amp; n &lt;= 7)   return result+n-2; else result += 6; // 22..27</a>
<a name="217"><span class="lineNum">     217 </span>                :            :         //</a>
<a name="218"><span class="lineNum">     218 </span>                :            :         if(n == 27)            return result; else result+=1; // 28</a>
<a name="219"><span class="lineNum">     219 </span>                :            :         if(n == 29)            return result; else result+=1; // 29</a>
<a name="220"><span class="lineNum">     220 </span>                :            :         if(n == 53)            return result; else result+=1; // 30</a>
<a name="221"><span class="lineNum">     221 </span>                :            :         if(n &gt;= 21 &amp;&amp; n &lt;= 25) return result+n-21; else result+=5; // 31..35</a>
<a name="222"><span class="lineNum">     222 </span>                :            :         if(n == 55)            return result; else result+=1; // 36</a>
<a name="223"><span class="lineNum">     223 </span>                :            :         //</a>
<a name="224"><span class="lineNum">     224 </span>                :            :         return result;</a>
<a name="225"><span class="lineNum">     225 </span>                :            :     };</a>
<a name="226"><span class="lineNum">     226 </span>                :<span class="lineCov">        773 :     static constexpr unsigned char __ = M(~0u);</span></a>
<a name="227"><span class="lineNum">     227 </span>                :<span class="lineCov">        773 :     static constexpr unsigned char translate[] =</span></a>
<a name="228"><span class="lineNum">     228 </span>                :            :     {</a>
<a name="229"><span class="lineNum">     229 </span>                :            :         #define a(n) M(n+0),M(n+1),M(n+2),M(n+3),M(n+4),M(n+5),M(n+6),M(n+7),M(n+8),M(n+9),</a>
<a name="230"><span class="lineNum">     230 </span>                :            :         a(0)a(10)a(20)a(30)a(40)a(50)a(60)a(70)a(80)a(90)a(100)a(110)</a>
<a name="231"><span class="lineNum">     231 </span>                :            :         #undef a</a>
<a name="232"><span class="lineNum">     232 </span>                :            :     };</a>
<a name="233"><span class="lineNum">     233 </span>                :<span class="lineCov">        773 :     static constexpr unsigned char modetab[] = {MODE38_2,MODE38_3,MODE38_4,MODE38_5,</span></a>
<a name="234"><span class="lineNum">     234 </span>                :            :                                                 MODE48_2,MODE48_3,MODE48_4,MODE48_5,</a>
<a name="235"><span class="lineNum">     235 </span>                :            :                                                 MODE58_2,MODE58_3,MODE58_4,MODE58_5};</a>
<a name="236"><span class="lineNum">     236 </span>                :            : </a>
<a name="237"><span class="lineNum">     237 </span>                :            :     /** ProcessSGR processes a SGR command. */</a>
<a name="238"><span class="lineNum">     238 </span>                :<span class="lineCov">       5042 :     auto ProcessSGR = [&amp;](char32_t&amp; c, unsigned a,</span></a>
<a name="239"><span class="lineNum">     239 </span>                :            :                           auto&amp;&amp; reset_attr,</a>
<a name="240"><span class="lineNum">     240 </span>                :            :                           auto&amp;&amp; change_attr)</a>
<a name="241"><span class="lineNum">     241 </span>                :            :     {</a>
<a name="242"><span class="lineNum">     242 </span>                :            :         /* c is a state code internal to this function, a is the input number from the SGR code.</a>
<a name="243"><span class="lineNum">     243 </span>                :            :          * Codes:</a>
<a name="244"><span class="lineNum">     244 </span>                :            :          *   0 = default state -- Will parse &quot;a&quot; (input number) as verbatim</a>
<a name="245"><span class="lineNum">     245 </span>                :            :          *   Other, see below:</a>
<a name="246"><span class="lineNum">     246 </span>                :            :          * Switch-case map (* = regular use, _ = UDEFINED, # = internal use):</a>
<a name="247"><span class="lineNum">     247 </span>                :            :          *     0-9     **********</a>
<a name="248"><span class="lineNum">     248 </span>                :            :          *    10-19    __________ (font commands, 0=default, 1-9=alt font)</a>
<a name="249"><span class="lineNum">     249 </span>                :            :          *    20-29    **********</a>
<a name="250"><span class="lineNum">     250 </span>                :            :          *    30-39    **********</a>
<a name="251"><span class="lineNum">     251 </span>                :            :          *    40-49    **********</a>
<a name="252"><span class="lineNum">     252 </span>                :            :          *    50-59    ******##**    56: MODE38_5[1]  57: MODE48_5[1]</a>
<a name="253"><span class="lineNum">     253 </span>                :            :          *    60-69    ******####    66: MODE38_4[4]</a>
<a name="254"><span class="lineNum">     254 </span>                :            :          *    70-79    ###***####    70: MODE38_2[3]  76: MODE48_4[4]</a>
<a name="255"><span class="lineNum">     255 </span>                :            :          *    80-89    ##########    80: MODE38_3[3]  83: MODE58_4[4] 87: MODE48_2[3]</a>
<a name="256"><span class="lineNum">     256 </span>                :            :          *    90-99    ********_#    99: MODE58_5[1]</a>
<a name="257"><span class="lineNum">     257 </span>                :            :          *   100-109   ********##    108: MODE_38_x[3]</a>
<a name="258"><span class="lineNum">     258 </span>                :            :          *   110-119   ##########    111: MODE48_3[3] 114: MODE58_2[3] 117: MODE58_3[3]</a>
<a name="259"><span class="lineNum">     259 </span>                :            :          *</a>
<a name="260"><span class="lineNum">     260 </span>                :            :          * Detailed layout on internal use codes --- what happens if &quot;a&quot; has that same value:</a>
<a name="261"><span class="lineNum">     261 </span>                :            :          *    56               mistakenly interpreted as 38;5;56</a>
<a name="262"><span class="lineNum">     262 </span>                :            :          *    57               mistakenly interpreted as 48;5;57</a>
<a name="263"><span class="lineNum">     263 </span>                :            :          *    99               mistakenly interpreted as 58;5;99</a>
<a name="264"><span class="lineNum">     264 </span>                :            :          *    72               mistakenly interpreted as 38;2;?;?;72</a>
<a name="265"><span class="lineNum">     265 </span>                :            :          *    82               mistakenly interpreted as 38;3;?;?;82</a>
<a name="266"><span class="lineNum">     266 </span>                :            :          *    89               mistakenly interpreted as 48;2;?;?;89</a>
<a name="267"><span class="lineNum">     267 </span>                :            :          *   113               mistakenly interpreted as 48;3;?;?;113</a>
<a name="268"><span class="lineNum">     268 </span>                :            :          *   116               mistakenly interpreted as 58;2;?;?;116</a>
<a name="269"><span class="lineNum">     269 </span>                :            :          *   119               mistakenly interpreted as 58;3;?;?;119</a>
<a name="270"><span class="lineNum">     270 </span>                :            :          *    69               mistakenly interpreted as 38;4;?;?;?;69</a>
<a name="271"><span class="lineNum">     271 </span>                :            :          *    79               mistakenly interpreted as 48;4;?;?;?;79</a>
<a name="272"><span class="lineNum">     272 </span>                :            :          *    86               mistakenly interpreted as 58;4;?;?;?;86</a>
<a name="273"><span class="lineNum">     273 </span>                :            :          *   108               mistakenly interpreted as 38;108 -- does nothing</a>
<a name="274"><span class="lineNum">     274 </span>                :            :          *   109               mistakenly interpreted as 48;109 -- does nothing</a>
<a name="275"><span class="lineNum">     275 </span>                :            :          *   110               mistakenly interpreted as 58;110 -- does nothing</a>
<a name="276"><span class="lineNum">     276 </span>                :            :          *   Anything else:    ignores 1 parameter and sets bold mode (as in 1)</a>
<a name="277"><span class="lineNum">     277 </span>                :            :          */</a>
<a name="278"><span class="lineNum">     278 </span>        [<span class="branchCov" title="Branch 0 was taken 2637 times"> + </span><span class="branchCov" title="Branch 1 was taken 1632 times"> + </span>]:<span class="lineCov">       4269 :         unsigned switchval = c ? c : a;</span></a>
<a name="279"><span class="lineNum">     279 </span>                :<span class="lineCov">       4269 :         auto m = [](unsigned n) constexpr</span></a>
<a name="280"><span class="lineNum">     280 </span>                :            :         {</a>
<a name="281"><span class="lineNum">     281 </span>        [<span class="branchCov" title="Branch 0 was taken 4133 times"> + </span><span class="branchCov" title="Branch 1 was taken 136 times"> + </span>]:<span class="lineCov">       4269 :             return (n &lt; sizeof(translate)) ? translate[n] : __;</span></a>
<a name="282"><span class="lineNum">     282 </span>                :            :         };</a>
<a name="283"><span class="lineNum">     283 </span>  [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 23 times"> + </span><span class="branchCov" title="Branch 2 was taken 9 times"> + </span><span class="branchCov" title="Branch 3 was taken 7 times"> + </span> :<span class="lineCov">       4133 :         switch(m(switchval))</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 8 times"> + </span><span class="branchCov" title="Branch 5 was taken 3 times"> + </span><span class="branchCov" title="Branch 6 was taken 2 times"> + </span><span class="branchCov" title="Branch 7 was taken 8 times"> + </span><span class="branchCov" title="Branch 8 was taken 3 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 9 was taken 8 times"> + </span><span class="branchCov" title="Branch 10 was taken 2 times"> + </span><span class="branchCov" title="Branch 11 was taken 2 times"> + </span><span class="branchCov" title="Branch 12 was taken 2 times"> + </span><span class="branchCov" title="Branch 13 was taken 2 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 14 was taken 2 times"> + </span><span class="branchCov" title="Branch 15 was taken 2 times"> + </span><span class="branchCov" title="Branch 16 was taken 1 time"> + </span><span class="branchCov" title="Branch 17 was taken 1 time"> + </span><span class="branchCov" title="Branch 18 was taken 3 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 19 was taken 2 times"> + </span><span class="branchCov" title="Branch 20 was taken 518 times"> + </span><span class="branchCov" title="Branch 21 was taken 518 times"> + </span><span class="branchCov" title="Branch 22 was taken 259 times"> + </span><span class="branchCov" title="Branch 23 was taken 1298 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 24 was taken 47 times"> + </span><span class="branchCov" title="Branch 25 was taken 20 times"> + </span><span class="branchCov" title="Branch 26 was taken 16 times"> + </span><span class="branchCov" title="Branch 27 was taken 513 times"> + </span><span class="branchCov" title="Branch 28 was taken 3 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 29 was taken 3 times"> + </span><span class="branchCov" title="Branch 30 was taken 2 times"> + </span><span class="branchCov" title="Branch 31 was taken 16 times"> + </span><span class="branchCov" title="Branch 32 was taken 16 times"> + </span><span class="branchCov" title="Branch 33 was taken 513 times"> + </span> 
<span class="lineNum">         </span>   <span class="branchCov" title="Branch 34 was taken 3 times"> + </span><span class="branchCov" title="Branch 35 was taken 3 times"> + </span><span class="branchCov" title="Branch 36 was taken 2 times"> + </span><span class="branchCov" title="Branch 37 was taken 291 times"> + </span>]
<a name="284"><span class="lineNum">     284 </span>                :            :         {</a>
<a name="285"><span class="lineNum">     285 </span>                :            :             #define set(what, v) change_attr([&amp;](Cell&amp; c, auto x){c.what = x;}, \</a>
<a name="286"><span class="lineNum">     286 </span>                :            :                                              [&amp;](const Cell&amp; c) { return c.what; }, \</a>
<a name="287"><span class="lineNum">     287 </span>                :            :                                              v)</a>
<a name="288"><span class="lineNum">     288 </span>                :<span class="lineCov">          2 :             case m(0): reset_attr(); c = 0; break;</span></a>
<a name="289"><span class="lineNum">     289 </span>                :<span class="lineCov">         26 :             case m(1): set(bold, true); c = 0; break;</span></a>
<a name="290"><span class="lineNum">     290 </span>                :<span class="lineCov">          9 :             case m(2): set(dim, true); c = 0; break;</span></a>
<a name="291"><span class="lineNum">     291 </span>                :<span class="lineCov">          7 :             case m(3): set(italic, true); c = 0; break;</span></a>
<a name="292"><span class="lineNum">     292 </span>                :<span class="lineCov">          8 :             case m(4): set(underline, true); c = 0; break;</span></a>
<a name="293"><span class="lineNum">     293 </span>                :<span class="lineCov">          3 :             case m(5): set(blink, 1); c = 0; break;</span></a>
<a name="294"><span class="lineNum">     294 </span>                :<span class="lineCov">          2 :             case m(6): set(blink, 2); c = 0; break;</span></a>
<a name="295"><span class="lineNum">     295 </span>                :<span class="lineCov">          8 :             case m(7): set(inverse, true); c = 0; break;</span></a>
<a name="296"><span class="lineNum">     296 </span>                :            :             //case m(8): set(conceal, true); c = 0; break;</a>
<a name="297"><span class="lineNum">     297 </span>                :<span class="lineCov">          3 :             case m(9): set(overstrike, true); c = 0; break;</span></a>
<a name="298"><span class="lineNum">     298 </span>                :            :             //case m(20): set(fraktur, true); c = 0; break;</a>
<a name="299"><span class="lineNum">     299 </span>                :<span class="lineCov">          8 :             case m(21): set(underline2, true); c = 0; break;</span></a>
<a name="300"><span class="lineNum">     300 </span>                :<span class="lineCov">          2 :             case m(22): set(dim, false); set(bold, false); c = 0; break;</span></a>
<a name="301"><span class="lineNum">     301 </span>                :<span class="lineCov">          2 :             case m(23): set(italic, false); set(fraktur, false); c = 0; break;</span></a>
<a name="302"><span class="lineNum">     302 </span>                :<span class="lineCov">          2 :             case m(24): set(underline, false); set(underline2, false); c = 0; break;</span></a>
<a name="303"><span class="lineNum">     303 </span>                :<span class="lineCov">          2 :             case m(25): set(blink, 0); c = 0; break;</span></a>
<a name="304"><span class="lineNum">     304 </span>                :            :             //case m(26): set(proportional, true); c = 0; break;</a>
<a name="305"><span class="lineNum">     305 </span>                :<span class="lineCov">          2 :             case m(27): set(inverse, false); c = 0; break;</span></a>
<a name="306"><span class="lineNum">     306 </span>                :            :             //case m(28): set(conceal, false); c = 0; break;</a>
<a name="307"><span class="lineNum">     307 </span>                :<span class="lineCov">          2 :             case m(29): set(overstrike, false); c = 0; break;</span></a>
<a name="308"><span class="lineNum">     308 </span>                :<span class="lineCov">          1 :             case m(39): set(underline, false); set(underline2, false);</span></a>
<a name="309"><span class="lineNum">     309 </span>                :<span class="lineCov">          2 :                         set(fgcolor, Cell{}.fgcolor); c = 0; break; // Set default foreground color</span></a>
<a name="310"><span class="lineNum">     310 </span>                :<span class="lineCov">          1 :             case m(49): set(bgcolor, Cell{}.bgcolor); c = 0; break; // Set default background color</span></a>
<a name="311"><span class="lineNum">     311 </span>                :            :             //case m(59): c = 0; break; // Set default underline color</a>
<a name="312"><span class="lineNum">     312 </span>                :            :             //case m(50): set(proportional, false); c = 0; break;</a>
<a name="313"><span class="lineNum">     313 </span>                :            :             //case m(51): set(framed, true); c = 0; break;</a>
<a name="314"><span class="lineNum">     314 </span>                :            :             //case m(52): set(encircled, true); c = 0; break;</a>
<a name="315"><span class="lineNum">     315 </span>                :<span class="lineCov">          3 :             case m(53): set(overlined, true); c = 0; break;</span></a>
<a name="316"><span class="lineNum">     316 </span>                :            :             //case m(54): set(framed, false); set(encircled, false); c = 0; break;</a>
<a name="317"><span class="lineNum">     317 </span>                :<span class="lineCov">          2 :             case m(55): set(overlined, false); c = 0; break;</span></a>
<a name="318"><span class="lineNum">     318 </span>                :            :             //case m(60): set(ideo_underline, true); c = 0; break;</a>
<a name="319"><span class="lineNum">     319 </span>                :            :             //case m(61): set(ideo_underline2, true); c = 0; break;</a>
<a name="320"><span class="lineNum">     320 </span>                :            :             //case m(62): set(ideo_overline, true); c = 0; break;</a>
<a name="321"><span class="lineNum">     321 </span>                :            :             //case m(63): set(ideo_overline2, true); c = 0; break;</a>
<a name="322"><span class="lineNum">     322 </span>                :            :             //case m(64): set(ideo_stress, true); c = 0; break;</a>
<a name="323"><span class="lineNum">     323 </span>                :            :             //case m(65): set(ideo_underline, false); set(ideo_underline2, false);</a>
<a name="324"><span class="lineNum">     324 </span>                :            :             //            set(ideo_overline, false); set(ideo_overline2, false);</a>
<a name="325"><span class="lineNum">     325 </span>                :            :             //            set(ideo_stress, false); c = 0; break;</a>
<a name="326"><span class="lineNum">     326 </span>                :            :             //case m(73): set(scriptsize, 1); c = 0; break;</a>
<a name="327"><span class="lineNum">     327 </span>                :            :             //case m(74): set(scriptsize, 2); c = 0; break;</a>
<a name="328"><span class="lineNum">     328 </span>                :            :             //case m(75): set(scriptsize, 0); c = 0; break;</a>
<a name="329"><span class="lineNum">     329 </span>                :<span class="lineCov">        518 :             case m(38): c = MODE_38_x; break;</span></a>
<a name="330"><span class="lineNum">     330 </span>                :<span class="lineCov">        518 :             case m(48): c = MODE_48_x; break;</span></a>
<a name="331"><span class="lineNum">     331 </span>                :<span class="lineCov">        259 :             case m(58): c = MODE_58_x; break;</span></a>
<a name="332"><span class="lineNum">     332 </span>                :            : </a>
<a name="333"><span class="lineNum">     333 </span>                :            :             // MODE_38_x, MODE_48_x, MODE_58_x are handled by single case.</a>
<a name="334"><span class="lineNum">     334 </span>                :<span class="lineCov">       1298 :             case m(MODE_38_x):/*</span></a>
<a name="335"><span class="lineNum">     335 </span>                :            :             case m(MODE_48_x):</a>
<a name="336"><span class="lineNum">     336 </span>                :            :             case m(MODE_58_x):*/</a>
<a name="337"><span class="lineNum">     337 </span>                :            :             {</a>
<a name="338"><span class="lineNum">     338 </span>                :<span class="lineCov">       3549 :                 color = 0;</span></a>
<a name="339"><span class="lineNum">     339 </span>        [<span class="branchCov" title="Branch 0 was taken 1295 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">       1298 :                 if(a &gt;= 2 &amp;&amp; a &lt;= 5) { c = modetab[(c-MODE_38_x)*4 + a - 2]; break; }</span></a>
<a name="340"><span class="lineNum">     340 </span>                :<span class="lineCov">          3 :                 c     = 0;</span></a>
<a name="341"><span class="lineNum">     341 </span>                :<span class="lineCov">          3 :                 break;</span></a>
<a name="342"><span class="lineNum">     342 </span>                :            :             }</a>
<a name="343"><span class="lineNum">     343 </span>                :            : </a>
<a name="344"><span class="lineNum">     344 </span>                :            :             // All of these are handled by a single case. They update color and increment mode number.</a>
<a name="345"><span class="lineNum">     345 </span>                :<span class="lineCov">         47 :             case m(MODE38_4): /*//color = (color &lt;&lt; 8) + a; c+=1; break; // 38;4;n</span></a>
<a name="346"><span class="lineNum">     346 </span>                :            :             case m(MODE38_3): //color = (color &lt;&lt; 8) + a; c+=1; break; // 38;3;n</a>
<a name="347"><span class="lineNum">     347 </span>                :            :             case m(MODE38_2): //color = (color &lt;&lt; 8) + a; c+=1; break; // 38;2;n</a>
<a name="348"><span class="lineNum">     348 </span>                :            :             case m(MODE48_4): //color = (color &lt;&lt; 8) + a; c+=1; break; // 48;4;n</a>
<a name="349"><span class="lineNum">     349 </span>                :            :             case m(MODE48_3): //color = (color &lt;&lt; 8) + a; c+=1; break; // 48;3;n</a>
<a name="350"><span class="lineNum">     350 </span>                :            :             case m(MODE48_2): //color = (color &lt;&lt; 8) + a; c+=1; break; // 48;2;n</a>
<a name="351"><span class="lineNum">     351 </span>                :            :             case m(MODE58_4): //color = (color &lt;&lt; 8) + a; c+=1; break; // 58;4;n</a>
<a name="352"><span class="lineNum">     352 </span>                :            :             case m(MODE58_3): //color = (color &lt;&lt; 8) + a; c+=1; break; // 58;3;n</a>
<a name="353"><span class="lineNum">     353 </span>                :            :             case m(MODE58_2): //color = (color &lt;&lt; 8) + a; c+=1; break; // 58;2;n</a>
<a name="354"><span class="lineNum">     354 </span>                :            :             case m(MODE38_4_x1): //color = (color &lt;&lt; 8) + a; c+=1; break; // 38;4;#;n</a>
<a name="355"><span class="lineNum">     355 </span>                :            :             case m(MODE38_3_x1)://color = (color &lt;&lt; 8) + a; c+=1; break; // 38;3;#;n</a>
<a name="356"><span class="lineNum">     356 </span>                :            :             case m(MODE38_2_x1)://color = (color &lt;&lt; 8) + a; c+=1; break; // 38;2;#;n</a>
<a name="357"><span class="lineNum">     357 </span>                :            :             case m(MODE48_4_x1)://color = (color &lt;&lt; 8) + a; c+=1; break; // 48;4;#;n</a>
<a name="358"><span class="lineNum">     358 </span>                :            :             case m(MODE48_3_x1)://color = (color &lt;&lt; 8) + a; c+=1; break; // 48;3;#;n</a>
<a name="359"><span class="lineNum">     359 </span>                :            :             case m(MODE48_2_x1)://color = (color &lt;&lt; 8) + a; c+=1; break; // 48;2;#;n</a>
<a name="360"><span class="lineNum">     360 </span>                :            :             case m(MODE58_4_x1)://color = (color &lt;&lt; 8) + a; c+=1; break; // 58;4;#;n</a>
<a name="361"><span class="lineNum">     361 </span>                :            :             case m(MODE58_3_x1)://color = (color &lt;&lt; 8) + a; c+=1; break; // 58;3;#;n</a>
<a name="362"><span class="lineNum">     362 </span>                :            :             case m(MODE58_2_x1)://color = (color &lt;&lt; 8) + a; c+=1; break; // 58;2;#;n</a>
<a name="363"><span class="lineNum">     363 </span>                :            :             case m(MODE38_4_x2)://color = (color &lt;&lt; 8) + a; c+=1; break; // 38;4;#;#;n</a>
<a name="364"><span class="lineNum">     364 </span>                :            :             case m(MODE48_4_x2)://color = (color &lt;&lt; 8) + a; c+=1; break; // 48;4;#;#;n</a>
<a name="365"><span class="lineNum">     365 </span>                :<span class="lineCov">         47 :             case m(MODE58_4_x2):*/color = (color &lt;&lt; 8) + a; c+=1; break; // 58;4;#;#;n</span></a>
<a name="366"><span class="lineNum">     366 </span>                :            : </a>
<a name="367"><span class="lineNum">     367 </span>                :            :             // Foreground colors. 30..37 are handled by a single case, likewise 90..97</a>
<a name="368"><span class="lineNum">     368 </span>                :<span class="lineCov">         20 :             case m(30):/*case m(31):case m(32):case m(33):</span></a>
<a name="369"><span class="lineNum">     369 </span>                :<span class="lineCov">         20 :             case m(34):case m(35):case m(36):case m(37):*/     a -= 30; a += 90-8;  [[fallthrough]];</span></a>
<a name="370"><span class="lineNum">     370 </span>                :<span class="lineCov">         36 :             case m(90):/*case m(91):case m(92):case m(93):</span></a>
<a name="371"><span class="lineNum">     371 </span>                :<span class="lineCov">         36 :             case m(94):case m(95):case m(96):case m(97):*/     a -= 90-8;           [[fallthrough]];</span></a>
<a name="372"><span class="lineNum">     372 </span>                :<span class="lineCov">        549 :             case m(MODE38_5):     color = 0; a = xterm256table[a &amp; 0xFF];           [[fallthrough]];     // 38;5;n</span></a>
<a name="373"><span class="lineNum">     373 </span>                :<span class="lineCov">        552 :             case m(MODE38_2_x2):  color = (color &lt;&lt; 8) + a; set(fgcolor, color); c = 0; break;           // 38;2;#;#;n   (RGB24)</span></a>
<a name="374"><span class="lineNum">     374 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineCov">          3 :             case m(MODE38_3_x2):  color = (color &lt;&lt; 8) + a; set(fgcolor, cmy2rgb(color));  c = 0; break; // 38;3;#;#;n   (CMY-&gt;RGB)</span></a>
<a name="375"><span class="lineNum">     375 </span>                :<span class="lineCov">          2 :             case m(MODE38_4_x3):  color = (color &lt;&lt; 8) + a; set(fgcolor, cmyk2rgb(color)); c = 0; break; // 38;4;#;#;#;n (CMYK-&gt;RGB)</span></a>
<a name="376"><span class="lineNum">     376 </span>                :            : </a>
<a name="377"><span class="lineNum">     377 </span>                :            :             // Background colors. 40..47 are handled by a single case, likewise 100..107</a>
<a name="378"><span class="lineNum">     378 </span>                :<span class="lineCov">         16 :             case m(40):/*case m(41):case m(42):case m(43):</span></a>
<a name="379"><span class="lineNum">     379 </span>                :<span class="lineCov">         16 :             case m(44):case m(45):case m(46):case m(47):*/     a -= 40; a += 100-8; [[fallthrough]];</span></a>
<a name="380"><span class="lineNum">     380 </span>                :<span class="lineCov">         32 :             case m(100):/*case m(101):case m(102):case m(103):</span></a>
<a name="381"><span class="lineNum">     381 </span>                :<span class="lineCov">         32 :             case m(104):case m(105):case m(106):case m(107):*/ a -= 100-8;          [[fallthrough]];</span></a>
<a name="382"><span class="lineNum">     382 </span>                :<span class="lineCov">        545 :             case m(MODE48_5):     color = 0; a = xterm256table[a &amp; 0xFF];           [[fallthrough]];     // 48;5;n</span></a>
<a name="383"><span class="lineNum">     383 </span>                :<span class="lineCov">        548 :             case m(MODE48_2_x2):  color = (color &lt;&lt; 8) + a; set(bgcolor, color);           c = 0; break; // 48;2;#;#;n   (RGB24)</span></a>
<a name="384"><span class="lineNum">     384 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineCov">          3 :             case m(MODE48_3_x2):  color = (color &lt;&lt; 8) + a; set(bgcolor, cmy2rgb(color));  c = 0; break; // 48;3;#;#;n   (CMY-&gt;RGB)</span></a>
<a name="385"><span class="lineNum">     385 </span>                :<span class="lineCov">          2 :             case m(MODE48_4_x3):  color = (color &lt;&lt; 8) + a; set(bgcolor, cmyk2rgb(color)); c = 0; break; // 48;4;#;#;#;n (CMYK-&gt;RGB)</span></a>
<a name="386"><span class="lineNum">     386 </span>                :            : </a>
<a name="387"><span class="lineNum">     387 </span>                :            :             // These don't do anything, so we just ignore them and reset the mode number c.</a>
<a name="388"><span class="lineNum">     388 </span>                :            :             //</a>
<a name="389"><span class="lineNum">     389 </span>                :            :             //case m(MODE58_5):  color = 0; a = xterm256table[a &amp; 0xFF]; [[fallthrough]];           // 58;5;n</a>
<a name="390"><span class="lineNum">     390 </span>                :            :             //case m(MODE58_4_x3)://color = (color &lt;&lt; 8) + a; /*IGNORED*/ c = 0; break;             // 58;4;#;#;#;n (TODO CMYK-&gt;RGB)</a>
<a name="391"><span class="lineNum">     391 </span>                :            :             //case m(MODE58_3_x2)://color = (color &lt;&lt; 8) + a; /*IGNORED*/ c = 0; break;             // 58;3;#;#;n   (TODO CMY-&gt;RGB)</a>
<a name="392"><span class="lineNum">     392 </span>                :            :             //case m(MODE58_2_x2):  color = (color &lt;&lt; 8) + a; /*IGNORED*/ c = 0; break;             // 58;2;#;#;n   (RGB24)</a>
<a name="393"><span class="lineNum">     393 </span>                :            : </a>
<a name="394"><span class="lineNum">     394 </span>                :<span class="lineCov">        427 :             default: case m(~0u): c = 0; break; // undefined</span></a>
<a name="395"><span class="lineNum">     395 </span>                :            :             #undef set</a>
<a name="396"><span class="lineNum">     396 </span>                :            :         }</a>
<a name="397"><span class="lineNum">     397 </span>                :<span class="lineCov">       5042 :     };</span></a>
<a name="398"><span class="lineNum">     398 </span>                :            : </a>
<a name="399"><span class="lineNum">     399 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 773 times"> + </span>]:<span class="lineCov">        773 :     if(bottom &gt;= wnd.ysize) bottom = wnd.ysize-1;</span></a>
<a name="400"><span class="lineNum">     400 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 773 times"> + </span>]:<span class="lineCov">        773 :     if(top    &gt; bottom)     top = bottom;</span></a>
<a name="401"><span class="lineNum">     401 </span>                :            : </a>
<a name="402"><span class="lineNum">     402 </span>                :<span class="lineCov">        773 :     enum States: unsigned</span></a>
<a name="403"><span class="lineNum">     403 </span>                :            :     {</a>
<a name="404"><span class="lineNum">     404 </span>                :            :         st_default,</a>
<a name="405"><span class="lineNum">     405 </span>                :            :         st_esc,</a>
<a name="406"><span class="lineNum">     406 </span>                :            :         st_scs,         // esc ()*+-./</a>
<a name="407"><span class="lineNum">     407 </span>                :            :         st_scr,         // esc #</a>
<a name="408"><span class="lineNum">     408 </span>                :            :         st_esc_percent, // esc %</a>
<a name="409"><span class="lineNum">     409 </span>                :            :         st_csi,         // esc [</a>
<a name="410"><span class="lineNum">     410 </span>                :            :         st_csi_dec,     // csi ?</a>
<a name="411"><span class="lineNum">     411 </span>                :            :         st_csi_dec2,    // csi &gt;</a>
<a name="412"><span class="lineNum">     412 </span>                :            :         st_csi_dec3,    // csi =</a>
<a name="413"><span class="lineNum">     413 </span>                :            :         st_csi_ex,      // csi !</a>
<a name="414"><span class="lineNum">     414 </span>                :            :         st_csi_quo,     // csi &quot;</a>
<a name="415"><span class="lineNum">     415 </span>                :            :         st_csi_dol,     // csi $</a>
<a name="416"><span class="lineNum">     416 </span>                :            :         st_csi_star,    // csi *</a>
<a name="417"><span class="lineNum">     417 </span>                :            :         st_csi_dec_dol, // csi ? $</a>
<a name="418"><span class="lineNum">     418 </span>                :            :         st_string,</a>
<a name="419"><span class="lineNum">     419 </span>                :            :         st_string_str,</a>
<a name="420"><span class="lineNum">     420 </span>                :            :         //</a>
<a name="421"><span class="lineNum">     421 </span>                :            :         st_num_states</a>
<a name="422"><span class="lineNum">     422 </span>                :            :     };</a>
<a name="423"><span class="lineNum">     423 </span>                :<span class="lineCov">      23260 :     auto State = [](char32_t c, unsigned st) constexpr</span></a>
<a name="424"><span class="lineNum">     424 </span>                :            :     {</a>
<a name="425"><span class="lineNum">     425 </span>                :<span class="lineCov">      22487 :         return c*st_num_states + st;</span></a>
<a name="426"><span class="lineNum">     426 </span>                :            :     };</a>
<a name="427"><span class="lineNum">     427 </span>                :<span class="lineCov">       2120 :     auto GetParams = [&amp;](unsigned min_params, bool change_zero_to_one)</span></a>
<a name="428"><span class="lineNum">     428 </span>                :            :     {</a>
<a name="429"><span class="lineNum">     429 </span>        [<span class="branchCov" title="Branch 0 was taken 44 times"> + </span><span class="branchCov" title="Branch 1 was taken 1303 times"> + </span>]:<span class="lineCov">       1347 :         if(p.size() &lt; min_params) { p.resize(min_params); }</span></a>
<a name="430"><span class="lineNum">     430 </span>  [<span class="branchCov" title="Branch 0 was taken 191 times"> + </span><span class="branchCov" title="Branch 1 was taken 1156 times"> + </span><span class="branchCov" title="Branch 2 was taken 59 times"> + </span><span class="branchCov" title="Branch 3 was taken 200 times"> + </span> :<span class="lineCov">       1606 :         if(change_zero_to_one) for(auto&amp; v: p) if(!v) v = 1;</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 259 times"> + </span><span class="branchCov" title="Branch 5 was taken 191 times"> + </span>]
<a name="431"><span class="lineNum">     431 </span>                :<span class="lineCov">       1347 :         state = st_default;</span></a>
<a name="432"><span class="lineNum">     432 </span>                :<span class="lineCov">       2120 :     };</span></a>
<a name="433"><span class="lineNum">     433 </span>                :            : </a>
<a name="434"><span class="lineNum">     434 </span>        [<span class="branchCov" title="Branch 0 was taken 22487 times"> + </span><span class="branchCov" title="Branch 1 was taken 773 times"> + </span>]:<span class="lineCov">      23260 :     for(char32_t c: s)</span></a>
<a name="435"><span class="lineNum">     435 </span>                :            :     {</a>
<a name="436"><span class="lineNum">     436 </span>  [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span><span class="branchCov" title="Branch 2 was taken 9 times"> + </span><span class="branchCov" title="Branch 3 was taken 27 times"> + </span> :<span class="lineCov">      22487 :         switch(State(c,state))</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 27 times"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 46 times"> + </span><span class="branchCov" title="Branch 7 was taken 1446 times"> + </span><span class="branchCov" title="Branch 8 was taken 3 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 9 was taken 30 times"> + </span><span class="branchCov" title="Branch 10 was taken 3 times"> + </span><span class="branchCov" title="Branch 11 was taken 3 times"> + </span><span class="branchCov" title="Branch 12 was taken 3 times"> + </span><span class="branchCov" title="Branch 13 was taken 4 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 14 was taken 9 times"> + </span><span class="branchCov" title="Branch 15 was taken 6 times"> + </span><span class="branchCov" title="Branch 16 was taken 1325 times"> + </span><span class="branchCov" title="Branch 17 was taken 3 times"> + </span><span class="branchCov" title="Branch 18 was taken 5 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 19 was taken 2 times"> + </span><span class="branchCov" title="Branch 20 was taken 2 times"> + </span><span class="branchCov" title="Branch 21 was taken 2 times"> + </span><span class="branchCov" title="Branch 22 was taken 7 times"> + </span><span class="branchCov" title="Branch 23 was taken 8 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 24 was taken 1 time"> + </span><span class="branchCov" title="Branch 25 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 26 was not taken"> - </span><span class="branchCov" title="Branch 27 was taken 44 times"> + </span><span class="branchNoCov" title="Branch 28 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 29 was taken 26 times"> + </span><span class="branchNoCov" title="Branch 30 was not taken"> - </span><span class="branchCov" title="Branch 31 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 32 was not taken"> - </span><span class="branchCov" title="Branch 33 was taken 2 times"> + </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 34 was not taken"> - </span><span class="branchCov" title="Branch 35 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 36 was not taken"> - </span><span class="branchCov" title="Branch 37 was taken 2 times"> + </span><span class="branchCov" title="Branch 38 was taken 8506 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 39 was taken 3295 times"> + </span><span class="branchCov" title="Branch 40 was taken 3 times"> + </span><span class="branchCov" title="Branch 41 was taken 13 times"> + </span><span class="branchCov" title="Branch 42 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 43 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 44 was taken 1 time"> + </span><span class="branchCov" title="Branch 45 was taken 1 time"> + </span><span class="branchCov" title="Branch 46 was taken 2 times"> + </span><span class="branchCov" title="Branch 47 was taken 1 time"> + </span><span class="branchCov" title="Branch 48 was taken 3 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 49 was taken 3 times"> + </span><span class="branchCov" title="Branch 50 was taken 2 times"> + </span><span class="branchCov" title="Branch 51 was taken 2 times"> + </span><span class="branchCov" title="Branch 52 was taken 2 times"> + </span><span class="branchCov" title="Branch 53 was taken 2 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 54 was taken 2 times"> + </span><span class="branchCov" title="Branch 55 was taken 2 times"> + </span><span class="branchCov" title="Branch 56 was taken 2 times"> + </span><span class="branchCov" title="Branch 57 was taken 2 times"> + </span><span class="branchCov" title="Branch 58 was taken 2 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 59 was taken 2 times"> + </span><span class="branchCov" title="Branch 60 was taken 2 times"> + </span><span class="branchCov" title="Branch 61 was taken 2 times"> + </span><span class="branchCov" title="Branch 62 was taken 2 times"> + </span><span class="branchCov" title="Branch 63 was taken 2 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 64 was taken 2 times"> + </span><span class="branchCov" title="Branch 65 was taken 2 times"> + </span><span class="branchCov" title="Branch 66 was taken 2 times"> + </span><span class="branchCov" title="Branch 67 was taken 2 times"> + </span><span class="branchCov" title="Branch 68 was taken 2 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 69 was taken 2 times"> + </span><span class="branchCov" title="Branch 70 was taken 2 times"> + </span><span class="branchCov" title="Branch 71 was taken 2 times"> + </span><span class="branchCov" title="Branch 72 was taken 2 times"> + </span><span class="branchCov" title="Branch 73 was taken 2 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 74 was taken 2 times"> + </span><span class="branchCov" title="Branch 75 was taken 2 times"> + </span><span class="branchCov" title="Branch 76 was taken 2 times"> + </span><span class="branchCov" title="Branch 77 was taken 1 time"> + </span><span class="branchCov" title="Branch 78 was taken 1 time"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 79 was taken 1 time"> + </span><span class="branchCov" title="Branch 80 was taken 1 time"> + </span><span class="branchCov" title="Branch 81 was taken 1 time"> + </span><span class="branchCov" title="Branch 82 was taken 1 time"> + </span><span class="branchCov" title="Branch 83 was taken 2 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 84 was taken 1 time"> + </span><span class="branchCov" title="Branch 85 was taken 1 time"> + </span><span class="branchCov" title="Branch 86 was taken 2 times"> + </span><span class="branchCov" title="Branch 87 was taken 1 time"> + </span><span class="branchCov" title="Branch 88 was taken 2 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 89 was taken 5 times"> + </span><span class="branchCov" title="Branch 90 was taken 2 times"> + </span><span class="branchCov" title="Branch 91 was taken 7 times"> + </span><span class="branchCov" title="Branch 92 was taken 109 times"> + </span><span class="branchCov" title="Branch 93 was taken 5 times"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 94 was taken 45 times"> + </span><span class="branchCov" title="Branch 95 was taken 6 times"> + </span><span class="branchCov" title="Branch 96 was taken 6 times"> + </span><span class="branchCov" title="Branch 97 was taken 1 time"> + </span><span class="branchCov" title="Branch 98 was taken 1 time"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 99 was taken 1 time"> + </span><span class="branchCov" title="Branch 100 was taken 1 time"> + </span><span class="branchCov" title="Branch 101 was taken 1 time"> + </span><span class="branchCov" title="Branch 102 was taken 1 time"> + </span><span class="branchCov" title="Branch 103 was taken 1 time"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 104 was taken 1 time"> + </span><span class="branchCov" title="Branch 105 was taken 1 time"> + </span><span class="branchCov" title="Branch 106 was taken 3 times"> + </span><span class="branchCov" title="Branch 107 was taken 1 time"> + </span><span class="branchCov" title="Branch 108 was taken 1 time"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 109 was taken 2 times"> + </span><span class="branchCov" title="Branch 110 was taken 1 time"> + </span><span class="branchCov" title="Branch 111 was taken 3 times"> + </span><span class="branchCov" title="Branch 112 was taken 4 times"> + </span><span class="branchCov" title="Branch 113 was taken 1 time"> + </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 114 was taken 1 time"> + </span><span class="branchCov" title="Branch 115 was taken 1 time"> + </span><span class="branchCov" title="Branch 116 was taken 2 times"> + </span><span class="branchCov" title="Branch 117 was taken 1 time"> + </span><span class="branchCov" title="Branch 118 was taken 1091 times"> + </span> 
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 119 was taken 6200 times"> + </span><span class="branchCov" title="Branch 120 was taken 1 time"> + </span>]
<a name="437"><span class="lineNum">     437 </span>                :            :         {</a>
<a name="438"><span class="lineNum">     438 </span>                :            :             #define CsiState(c)      State(c,st_csi):     case State(c,st_csi_dec2): \</a>
<a name="439"><span class="lineNum">     439 </span>                :            :                                 case State(c,st_csi_dec): case State(c,st_csi_dec3): \</a>
<a name="440"><span class="lineNum">     440 </span>                :            :                                 case State(c,st_string)</a>
<a name="441"><span class="lineNum">     441 </span>                :            :                                 /* csi_quo, csi_dol, csi_dec_dol, csi_ex are excluded</a>
<a name="442"><span class="lineNum">     442 </span>                :            :                                  * from csistate because you can't have parameters</a>
<a name="443"><span class="lineNum">     443 </span>                :            :                                  * after this particular symbol.</a>
<a name="444"><span class="lineNum">     444 </span>                :            :                                  */</a>
<a name="445"><span class="lineNum">     445 </span>                :            :             #define AnyState(c)      State(c,st_default):    case State(c,st_esc): \</a>
<a name="446"><span class="lineNum">     446 </span>                :            :                                 case State(c,st_scs):        case State(c,st_csi_ex): \</a>
<a name="447"><span class="lineNum">     447 </span>                :            :                                 case State(c,st_string_str): case State(c,st_csi_quo): \</a>
<a name="448"><span class="lineNum">     448 </span>                :            :                                 case State(c,st_scr):        case State(c,st_esc_percent): \</a>
<a name="449"><span class="lineNum">     449 </span>                :            :                                 case State(c,st_csi_dol):    case State(c,st_csi_dec_dol): \</a>
<a name="450"><span class="lineNum">     450 </span>                :            :                                 case CsiState(c)</a>
<a name="451"><span class="lineNum">     451 </span>                :            : </a>
<a name="452"><span class="lineNum">     452 </span>                :            :             // Note: These escapes are recognized even in the middle of an ANSI/VT code.</a>
<a name="453"><span class="lineNum">     453 </span>                :<span class="lineCov">          2 :             case AnyState(U'\b'):  { lastch=c; ClampedMoveX(wnd.cursx-1); break; }</span></a>
<a name="454"><span class="lineNum">     454 </span>                :<span class="lineCov">         16 :             case AnyState(U'\t'):  { lastch=c; ClampedMoveX(wnd.cursx + 8 - (wnd.cursx &amp; 7)); break; }</span></a>
<a name="455"><span class="lineNum">     455 </span>                :<span class="lineCov">          9 :             case AnyState(U'\r'):  { lastch=c; ClampedMoveX(0); break; }</span></a>
<a name="456"><span class="lineNum">     456 </span>                :<span class="lineCov">         27 :             case AnyState(U'\16'): { activeset = 1; break; }</span></a>
<a name="457"><span class="lineNum">     457 </span>                :<span class="lineCov">         27 :             case AnyState(U'\17'): { activeset = 0; break; }</span></a>
<a name="458"><span class="lineNum">     458 </span>                :            :             case AnyState(U'\177'): { /* del - ignore */ break; }</a>
<a name="459"><span class="lineNum">     459 </span>                :<span class="lineCov">        149 :             case AnyState(U'\30'): [[fallthrough]];</span></a>
<a name="460"><span class="lineNum">     460 </span>                :<span class="lineCov">        149 :             case AnyState(U'\32'): [[fallthrough]];</span></a>
<a name="461"><span class="lineNum">     461 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0080'): [[fallthrough]];</span></a>
<a name="462"><span class="lineNum">     462 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0081'): [[fallthrough]];</span></a>
<a name="463"><span class="lineNum">     463 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0082'): [[fallthrough]];</span></a>
<a name="464"><span class="lineNum">     464 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0083'): [[fallthrough]];</span></a>
<a name="465"><span class="lineNum">     465 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0086'): [[fallthrough]];</span></a>
<a name="466"><span class="lineNum">     466 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0087'): [[fallthrough]];</span></a>
<a name="467"><span class="lineNum">     467 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0089'): [[fallthrough]];</span></a>
<a name="468"><span class="lineNum">     468 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u008A'): [[fallthrough]];</span></a>
<a name="469"><span class="lineNum">     469 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u008B'): [[fallthrough]];</span></a>
<a name="470"><span class="lineNum">     470 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u008C'): [[fallthrough]];</span></a>
<a name="471"><span class="lineNum">     471 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0091'): [[fallthrough]];</span></a>
<a name="472"><span class="lineNum">     472 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0092'): [[fallthrough]];</span></a>
<a name="473"><span class="lineNum">     473 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0093'): [[fallthrough]];</span></a>
<a name="474"><span class="lineNum">     474 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0094'): [[fallthrough]];</span></a>
<a name="475"><span class="lineNum">     475 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0095'): [[fallthrough]];</span></a>
<a name="476"><span class="lineNum">     476 </span>                :<span class="lineCov">        149 :             case AnyState(U'\u0099'): { Ground: scs=0; state=st_default; break; }</span></a>
<a name="477"><span class="lineNum">     477 </span>                :<span class="lineCov">         46 :             case State(U'\33', st_string): [[fallthrough]];</span></a>
<a name="478"><span class="lineNum">     478 </span>                :<span class="lineCov">         46 :             case State(U'\33', st_string_str): state = st_esc; break; // don't clear params</span></a>
<a name="479"><span class="lineNum">     479 </span>        [<span class="branchCov" title="Branch 0 was taken 987 times"> + </span><span class="branchCov" title="Branch 1 was taken 459 times"> + </span>]:<span class="lineCov">       1446 :             case State(U'\33', st_default): state = st_esc; p.clear(); break;</span></a>
<a name="480"><span class="lineNum">     480 </span>                :<span class="lineCov">          3 :             case State(U'(', st_esc): scs = 0; state = st_scs; break; // esc (</span></a>
<a name="481"><span class="lineNum">     481 </span>                :<span class="lineCov">         30 :             case State(U')', st_esc): scs = 1; state = st_scs; break; // esc )</span></a>
<a name="482"><span class="lineNum">     482 </span>                :<span class="lineCov">          3 :             case State(U'*', st_esc): scs = 2; state = st_scs; break; // esc *</span></a>
<a name="483"><span class="lineNum">     483 </span>                :<span class="lineCov">          3 :             case State(U'+', st_esc): scs = 3; state = st_scs; break; // esc +</span></a>
<a name="484"><span class="lineNum">     484 </span>                :<span class="lineCov">          3 :             case State(U'-', st_esc): scs = 1; state = st_scs; break; // esc -</span></a>
<a name="485"><span class="lineNum">     485 </span>                :<span class="lineCov">          4 :             case State(U'.', st_esc): scs = 2; state = st_scs; break; // esc .</span></a>
<a name="486"><span class="lineNum">     486 </span>                :<span class="lineCov">          9 :             case State(U'/', st_esc): scs = 3; state = st_scs; break; // esc /</span></a>
<a name="487"><span class="lineNum">     487 </span>                :<span class="lineCov">          6 :             case State(U'#', st_esc): state = st_scr; break;  // esc #</span></a>
<a name="488"><span class="lineNum">     488 </span>                :<span class="lineCov">       1325 :             case State(U'[', st_esc): state = st_csi; break;  // esc [</span></a>
<a name="489"><span class="lineNum">     489 </span>                :<span class="lineCov">          3 :             case State(U'%', st_esc): state = st_esc_percent; break; // esc %</span></a>
<a name="490"><span class="lineNum">     490 </span>                :<span class="lineCov">          5 :             case State(U'?', st_csi): state = st_csi_dec; break;  // csi ?</span></a>
<a name="491"><span class="lineNum">     491 </span>                :<span class="lineCov">          2 :             case State(U'&gt;', st_csi): state = st_csi_dec2; break; // csi &gt;</span></a>
<a name="492"><span class="lineNum">     492 </span>                :<span class="lineCov">          2 :             case State(U'=', st_csi): state = st_csi_dec3; break; // csi =</span></a>
<a name="493"><span class="lineNum">     493 </span>                :<span class="lineCov">          2 :             case State(U'!', st_csi): state = st_csi_ex; break;  // csi ! (note: after numbers)</span></a>
<a name="494"><span class="lineNum">     494 </span>                :<span class="lineCov">          7 :             case State(U'&quot;', st_csi): state = st_csi_quo; break; // csi &quot; (note: after numbers)</span></a>
<a name="495"><span class="lineNum">     495 </span>                :<span class="lineCov">          8 :             case State(U'$', st_csi): state = st_csi_dol; break; // csi $ (note: after numbers)</span></a>
<a name="496"><span class="lineNum">     496 </span>                :<span class="lineCov">          1 :             case State(U'*', st_csi): state = st_csi_star; break; // csi * (note: after numbers)</span></a>
<a name="497"><span class="lineNum">     497 </span>                :<span class="lineCov">          2 :             case State(U'$', st_csi_dec): state = st_csi_dec_dol; break; // csi ? $ (note: after numbers)</span></a>
<a name="498"><span class="lineNum">     498 </span>                :<span class="lineNoCov">          0 :             case AnyState(U'\7'):</span></a>
<a name="499"><span class="lineNum">     499 </span>                :<span class="lineNoCov">          0 :             {</span></a>
<a name="500"><span class="lineNum">     500 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(state == st_string || state == st_string_str) // Treat as ST (string termination)</span></a>
<a name="501"><span class="lineNum">     501 </span>                :            :                 {</a>
<a name="502"><span class="lineNum">     502 </span>                :<span class="lineCov">         44 :             case AnyState(U'\u009C'): [[fallthrough]];</span></a>
<a name="503"><span class="lineNum">     503 </span>                :<span class="lineCov">         44 :             case State(U'\\', st_esc): // String termination</span></a>
<a name="504"><span class="lineNum">     504 </span>     [<span class="branchCov" title="Branch 0 was taken 25 times"> + </span><span class="branchCov" title="Branch 1 was taken 13 times"> + </span><span class="branchCov" title="Branch 2 was taken 6 times"> + </span>]:<span class="lineCov">         44 :                     switch(scs)</span></a>
<a name="505"><span class="lineNum">     505 </span>                :            :                     {</a>
<a name="506"><span class="lineNum">     506 </span>                :<span class="lineCov">         25 :                         case 4: // Parse DCS</span></a>
<a name="507"><span class="lineNum">     507 </span>                :<span class="lineCov">         25 :                             GetParams(1, false);</span></a>
<a name="508"><span class="lineNum">     508 </span>        [<span class="branchCov" title="Branch 0 was taken 25 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         25 :                             if(string.empty()) break;</span></a>
<a name="509"><span class="lineNum">     509 </span>     [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">         25 :                             switch(string[0])</span></a>
<a name="510"><span class="lineNum">     510 </span>                :            :                             {</a>
<a name="511"><span class="lineNum">     511 </span>                :<span class="lineCov">          9 :                                 case U'$':</span></a>
<a name="512"><span class="lineNum">     512 </span>  [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 8 times"> + </span>]:<span class="lineCov">          9 :                                     if(string.size() &lt;= 1 || string[1] != 'q')</span></a>
<a name="513"><span class="lineNum">     513 </span>                :<span class="lineCov">          2 :                                         EchoBack(U&quot;\u0018&quot;);</span></a>
<a name="514"><span class="lineNum">     514 </span>                :            :                                     else</a>
<a name="515"><span class="lineNum">     515 </span>                :            :                                     {</a>
<a name="516"><span class="lineNum">     516 </span>                :<span class="lineCov">          8 :                                         string.erase(0,2);</span></a>
<a name="517"><span class="lineNum">     517 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span>]:<span class="lineCov">          8 :                                         std::string response;</span></a>
<a name="518"><span class="lineNum">     518 </span>                :<span class="lineCov">          8 :                                         char Buf[40];</span></a>
<a name="519"><span class="lineNum">     519 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          8 :                                         if(string == U&quot;r&quot;) response.assign(Buf, std::sprintf(Buf, &quot;%zu;%zu&quot;, top,bottom));</span></a>
<a name="520"><span class="lineNum">     520 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          7 :                                         else if(string == U&quot;m&quot;) response.assign(Buf, std::sprintf(Buf, &quot;38;2;%u;%u;%u;48;2;%u;%u;%u&quot;,</span></a>
<a name="521"><span class="lineNum">     521 </span>                :<span class="lineCov">          1 :                                                                     (wnd.blank.fgcolor &gt;&gt; 16)&amp;0xFF,</span></a>
<a name="522"><span class="lineNum">     522 </span>                :<span class="lineCov">          1 :                                                                     (wnd.blank.fgcolor &gt;&gt; 8)&amp;0xFF,</span></a>
<a name="523"><span class="lineNum">     523 </span>                :<span class="lineCov">          1 :                                                                     (wnd.blank.fgcolor &gt;&gt; 0)&amp;0xFF,</span></a>
<a name="524"><span class="lineNum">     524 </span>                :<span class="lineCov">          1 :                                                                     (wnd.blank.bgcolor &gt;&gt; 16)&amp;0xFF,</span></a>
<a name="525"><span class="lineNum">     525 </span>                :<span class="lineCov">          1 :                                                                     (wnd.blank.bgcolor &gt;&gt; 8)&amp;0xFF,</span></a>
<a name="526"><span class="lineNum">     526 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                                                                     (wnd.blank.bgcolor &gt;&gt; 0)&amp;0xFF));</span></a>
<a name="527"><span class="lineNum">     527 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span> :<span class="lineCov">          6 :                                         else if(string == U&quot;t&quot;) response = std::to_string(std::max(25u, unsigned(wnd.ysize))-1);</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<a name="528"><span class="lineNum">     528 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          5 :                                         else if(string == U&quot; q&quot;) response = &quot;1&quot;; //cursor type</span></a>
<a name="529"><span class="lineNum">     529 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          4 :                                         else if(string == U&quot;\&quot;q&quot;) response = wnd.blank.protect ? &quot;1&quot; : &quot;0&quot;; //protected mode</span></a>
<a name="530"><span class="lineNum">     530 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          3 :                                         else if(string == U&quot;\&quot;p&quot;) response = &quot;64;1&quot;; //vt index, 8-bit controls disabled</span></a>
<a name="531"><span class="lineNum">     531 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          2 :                                         else if(string == U&quot;$|&quot;) response = std::to_string(wnd.xsize); //window width</span></a>
<a name="532"><span class="lineNum">     532 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :                                         else if(string == U&quot;*|&quot;) response.assign(Buf, std::sprintf(Buf, &quot;%zu&quot;, wnd.ysize));</span></a>
<a name="533"><span class="lineNum">     533 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                         else {fprintf(stderr, &quot;Unrecognized DCS&lt;%s&gt;\n&quot;, ToUTF8(string).c_str());</span></a>
<a name="534"><span class="lineNum">     534 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                             EchoBack(U&quot;\033$P0\033\\&quot;);}</span></a>
<a name="535"><span class="lineNum">     535 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          8 :                                         if(!response.empty())</span></a>
<a name="536"><span class="lineNum">     536 </span>  [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">         16 :                                             EchoBack(U&quot;\033$P1$r&quot; + FromUTF8(response) + string + U&quot;\033\\&quot;);</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 8 times"> + </span> 
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 9 was not taken"> - </span>]
<a name="537"><span class="lineNum">     537 </span>                :<span class="lineCov">          8 :                                     }</span></a>
<a name="538"><span class="lineNum">     538 </span>                :            :                                     break;</a>
<a name="539"><span class="lineNum">     539 </span>                :<span class="lineCov">         15 :                                 case U'q': /* Sixel graphics */</span></a>
<a name="540"><span class="lineNum">     540 </span>                :<span class="lineCov">         15 :                                 {</span></a>
<a name="541"><span class="lineNum">     541 </span>                :<span class="lineCov">         15 :                                     [[maybe_unused]] unsigned pad=1, pan=2, ph=1, pv=1, rep=1, x=0, y=0, color=3;</span></a>
<a name="542"><span class="lineNum">     542 </span>                :<span class="lineCov">         15 :                                     [[maybe_unused]] bool trans=false;</span></a>
<a name="543"><span class="lineNum">     543 </span>                :            :                                     // Parse pre-q parameters</a>
<a name="544"><span class="lineNum">     544 </span>  [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         30 :                                     if(p.size()&gt;=1) pad = std::array&lt;int,10&gt;{2,2,5,4,4,3,3,2,2,1}[std::min(9u,p[0])];</span></a>
<a name="545"><span class="lineNum">     545 </span>                :<span class="lineCov">         15 :                                     if(p.size()&gt;=2) { trans=p[1]; }</span></a>
<a name="546"><span class="lineNum">     546 </span>        [<span class="branchCov" title="Branch 0 was taken 13 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">         15 :                                     if(p.size()&gt;=2) { pad = std::max(1u,pad*p[2]/10); pan = std::max(1u,pan*p[2]/10); }</span></a>
<a name="547"><span class="lineNum">     547 </span>                :<span class="lineCov">         15 :                                     if(p.size()&gt;=7) { pad=p[3]; pan=p[4]; ph=p[5]; pv=p[6]; }</span></a>
<a name="548"><span class="lineNum">     548 </span>                :<span class="lineCov">         31 :                                     for(std::size_t b=0,a=0; a&lt;string.size(); a = ++b)</span></a>
<a name="549"><span class="lineNum">     549 </span>                :            :                                     {</a>
<a name="550"><span class="lineNum">     550 </span>                :            :                                         // Parse parameters that follow the command</a>
<a name="551"><span class="lineNum">     551 </span>  [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchCov" title="Branch 3 was taken 15 times"> + </span>]:<span class="lineCov">         38 :                                         for(p.clear(); (b+1) &lt; string.size(); ++b)</span></a>
<a name="552"><span class="lineNum">     552 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          7 :                                             if(string[b+1] &gt;= U';') p.emplace_back();</span></a>
<a name="553"><span class="lineNum">     553 </span>  [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          5 :                                             else if(string[b+1] &gt;= U'0' &amp;&amp; string[b+1] &lt;= U'9')</span></a>
<a name="554"><span class="lineNum">     554 </span>                :            :                                             {</a>
<a name="555"><span class="lineNum">     555 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          4 :                                                 if(p.empty()) p.emplace_back();</span></a>
<a name="556"><span class="lineNum">     556 </span>                :<span class="lineCov">          4 :                                                 p.back() = p.back() * 10u + (string[b+1]-U'0');</span></a>
<a name="557"><span class="lineNum">     557 </span>                :            :                                             }</a>
<a name="558"><span class="lineNum">     558 </span>                :            :                                             else break;</a>
<a name="559"><span class="lineNum">     559 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 15 times"> + </span> :<span class="lineCov">         16 :                                         switch(string[a])</span></a>
<span class="lineNum">         </span>            <span class="branchCov" title="Branch 4 was taken 1 time"> + </span>]
<a name="560"><span class="lineNum">     560 </span>                :            :                                         {</a>
<a name="561"><span class="lineNum">     561 </span>                :<span class="lineNoCov">          0 :                                             case '\u0034': GetParams(4,false);</span></a>
<a name="562"><span class="lineNum">     562 </span>                :<span class="lineNoCov">          0 :                                                            pad = std::max(1u,p[0]);</span></a>
<a name="563"><span class="lineNum">     563 </span>                :<span class="lineNoCov">          0 :                                                            pan = std::max(1u,p[1]);</span></a>
<a name="564"><span class="lineNum">     564 </span>                :<span class="lineNoCov">          0 :                                                            if(p[2]) ph = p[2];</span></a>
<a name="565"><span class="lineNum">     565 </span>                :<span class="lineNoCov">          0 :                                                            if(p[3]) pv = p[3];</span></a>
<a name="566"><span class="lineNum">     566 </span>                :            :                                                            break;</a>
<a name="567"><span class="lineNum">     567 </span>                :<span class="lineNoCov">          0 :                                             case '\u0035': switch(GetParams(5,false); p[1])</span></a>
<a name="568"><span class="lineNum">     568 </span>                :            :                                                            {</a>
<a name="569"><span class="lineNum">     569 </span>                :<span class="lineCov">         31 :                                                                case 0: color=p[0]; break; // choose color p[0]</span></a>
<a name="570"><span class="lineNum">     570 </span>                :            :                                                                case 1: break; // change color p[0] into hls: p[2..4]</a>
<a name="571"><span class="lineNum">     571 </span>                :            :                                                                case 2: break; // change color p[0] into rgb: p[2..4]</a>
<a name="572"><span class="lineNum">     572 </span>                :            :                                                            }</a>
<a name="573"><span class="lineNum">     573 </span>                :            :                                                            break;</a>
<a name="574"><span class="lineNum">     574 </span>        [<span class="branchCov" title="Branch 0 was taken 16 times"> + </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span>]:<span class="lineCov">         31 :                                             case '\u002D': y+=6; [[fallthrough]]; // TODO: scroll if necessary</span></a>
<a name="575"><span class="lineNum">     575 </span>                :            :                                             case '\u0036': x=0; break;</a>
<a name="576"><span class="lineNum">     576 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                             case '\u0033': GetParams(1,false); rep = std::max(1u, p[0]); break;</span></a>
<a name="577"><span class="lineNum">     577 </span>                :<span class="lineCov">         15 :                                             default:</span></a>
<a name="578"><span class="lineNum">     578 </span>  [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         15 :                                                 if(string[a] &gt;= '\u003F' &amp;&amp; string[a] &lt;= '\u007E')</span></a>
<a name="579"><span class="lineNum">     579 </span>                :            :                                                 {</a>
<a name="580"><span class="lineNum">     580 </span>                :<span class="lineCov">         30 :                                                     unsigned bitmask = string[a] - '\u003F';</span></a>
<a name="581"><span class="lineNum">     581 </span>        [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span>]:<span class="lineCov">         30 :                                                     for(; rep-- &gt; 0; ++x)</span></a>
<a name="582"><span class="lineNum">     582 </span>        [<span class="branchCov" title="Branch 0 was taken 90 times"> + </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span>]:<span class="lineCov">        105 :                                                         for(unsigned py=0; py&lt;6; ++py)</span></a>
<a name="583"><span class="lineNum">     583 </span>                :            :                                                             if(bitmask &amp; (1u &lt;&lt; py))</a>
<a name="584"><span class="lineNum">     584 </span>                :            :                                                             {</a>
<a name="585"><span class="lineNum">     585 </span>                :            :                                                             }</a>
<a name="586"><span class="lineNum">     586 </span>                :            :                                                     rep = 1;</a>
<a name="587"><span class="lineNum">     587 </span>                :            :                                                 }</a>
<a name="588"><span class="lineNum">     588 </span>                :            :                                         }</a>
<a name="589"><span class="lineNum">     589 </span>                :            :                                     }</a>
<a name="590"><span class="lineNum">     590 </span>                :            :                                     break;</a>
<a name="591"><span class="lineNum">     591 </span>                :            :                                 }</a>
<a name="592"><span class="lineNum">     592 </span>                :            :                                 case U'p': /* ReGIS graphics */ break;</a>
<a name="593"><span class="lineNum">     593 </span>                :            :                             }</a>
<a name="594"><span class="lineNum">     594 </span>                :            :                             break;</a>
<a name="595"><span class="lineNum">     595 </span>                :<span class="lineCov">         13 :                         case 5: // Parse OSC</span></a>
<a name="596"><span class="lineNum">     596 </span>                :<span class="lineCov">         13 :                         {</span></a>
<a name="597"><span class="lineNum">     597 </span>                :<span class="lineCov">         13 :                             GetParams(2,false);</span></a>
<a name="598"><span class="lineNum">     598 </span>  [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span> :<span class="lineCov">         13 :                             bool dfl = p[0] &gt;= 100;</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span><span class="branchCov" title="Branch 7 was taken 1 time"> + </span><span class="branchCov" title="Branch 8 was taken 1 time"> + </span> 
<span class="lineNum">         </span>            <span class="branchCov" title="Branch 9 was taken 2 times"> + </span>]
<a name="599"><span class="lineNum">     599 </span>                :<span class="lineCov">         21 :                             auto DoColor = [&amp;](const char* params,unsigned idx, unsigned&amp; color, unsigned dflcolor)</span></a>
<a name="600"><span class="lineNum">     600 </span>                :            :                             {</a>
<a name="601"><span class="lineNum">     601 </span>                :<span class="lineCov">          8 :                                 char Buf[32];</span></a>
<a name="602"><span class="lineNum">     602 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">          8 :                                 if(string == U&quot;?&quot;)</span></a>
<a name="603"><span class="lineNum">     603 </span>                :            :                                 {</a>
<a name="604"><span class="lineNum">     604 </span>                :<span class="lineNoCov">          0 :                                     char st[3] = {'\33', char(c), '\0'};</span></a>
<a name="605"><span class="lineNum">     605 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                     if(c != '\\') { st[0] = char(c); st[1] = '\0'; }</span></a>
<a name="606"><span class="lineNum">     606 </span>                :            :                                     // ^ Echo back using the same ST code</a>
<a name="607"><span class="lineNum">     607 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                     EchoBack(FromUTF8({Buf, 0u+std::sprintf(Buf, &quot;\33]%s%u;#%06X%s&quot;, params,idx, color, st)}));</span></a>
<a name="608"><span class="lineNum">     608 </span>                :            :                                 }</a>
<a name="609"><span class="lineNum">     609 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">          8 :                                 else if(dfl) color = dflcolor;</span></a>
<a name="610"><span class="lineNum">     610 </span>                :<span class="lineCov">          8 :                                 else color = ParseColorName(string);</span></a>
<a name="611"><span class="lineNum">     611 </span>                :<span class="lineCov">          8 :                             };</span></a>
<a name="612"><span class="lineNum">     612 </span>  [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span> :<span class="lineCov">         13 :                             switch(unsigned p100 = p[0] % 100)</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span><span class="branchCov" title="Branch 7 was taken 1 time"> + </span><span class="branchCov" title="Branch 8 was taken 1 time"> + </span> 
<span class="lineNum">         </span>            <span class="branchCov" title="Branch 9 was taken 2 times"> + </span>]
<a name="613"><span class="lineNum">     613 </span>                :            :                             {</a>
<a name="614"><span class="lineNum">     614 </span>                :<span class="lineCov">          3 :                                 case 0:</span></a>
<a name="615"><span class="lineNum">     615 </span>                :<span class="lineCov">          3 :                                 case 1:</span></a>
<a name="616"><span class="lineNum">     616 </span>                :<span class="lineCov">          3 :                                 case 2:</span></a>
<a name="617"><span class="lineNum">     617 </span>                :<span class="lineCov">          3 :                                 {</span></a>
<a name="618"><span class="lineNum">     618 </span>                :<span class="lineCov">          3 :                                     std::string utstring = ToUTF8(string);</span></a>
<a name="619"><span class="lineNum">     619 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          3 :                                     if(!(p100 &amp; 2)) // 0 and 1: set icon name</span></a>
<a name="620"><span class="lineNum">     620 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                                         ui.SetIconName(utstring);</span></a>
<a name="621"><span class="lineNum">     621 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          3 :                                     if(!(p100 &amp; 1)) // 0 and 2: set window title</span></a>
<a name="622"><span class="lineNum">     622 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                                         ui.SetWindowTitle(utstring);</span></a>
<a name="623"><span class="lineNum">     623 </span>                :<span class="lineCov">          3 :                                     break;</span></a>
<a name="624"><span class="lineNum">     624 </span>                :<span class="lineCov">          3 :                                 }</span></a>
<a name="625"><span class="lineNum">     625 </span>                :            :                                 case 6: break; // set or clear color{BD,UL,BL,RV,IT} mode</a>
<a name="626"><span class="lineNum">     626 </span>                :<span class="lineCov">          1 :                                 case 5:  p[1] += 256; [[fallthrough]];</span></a>
<a name="627"><span class="lineNum">     627 </span>                :<span class="lineCov">          2 :                                 case 4: {unsigned v = xterm256table[p[1]&amp;0xFF];</span></a>
<a name="628"><span class="lineNum">     628 </span>                :<span class="lineCov">          2 :                                          DoColor(&quot;4;&quot;,p[1]&amp;0xFF, v, v);</span></a>
<a name="629"><span class="lineNum">     629 </span>                :<span class="lineCov">          2 :                                          break;} // change color [p[1]] to string, or if ?, report the string</span></a>
<a name="630"><span class="lineNum">     630 </span>                :<span class="lineCov">          1 :                                 case 10: DoColor(&quot;&quot;,p[0], wnd.blank.fgcolor, Cell{}.fgcolor); break; // Change text foreground color</span></a>
<a name="631"><span class="lineNum">     631 </span>                :<span class="lineCov">          1 :                                 case 11: DoColor(&quot;&quot;,p[0], wnd.blank.bgcolor, Cell{}.bgcolor); break; // Change text background color</span></a>
<a name="632"><span class="lineNum">     632 </span>                :<span class="lineCov">          1 :                                 case 12: DoColor(&quot;&quot;,p[0], wnd.cursorcolor, 0xFFFFFF); break; // Change text cursor color</span></a>
<a name="633"><span class="lineNum">     633 </span>                :<span class="lineCov">          1 :                                 case 13: DoColor(&quot;&quot;,p[0], wnd.mousecolor1, 0xFFFFFF); break; // Change mouse foreground color</span></a>
<a name="634"><span class="lineNum">     634 </span>                :<span class="lineCov">          1 :                                 case 14: DoColor(&quot;&quot;,p[0], wnd.mousecolor2, 0xFFFFFF); break; // Change mouse background color</span></a>
<a name="635"><span class="lineNum">     635 </span>                :<span class="lineCov">          1 :                                 case 17: DoColor(&quot;&quot;,p[0], wnd.mouseselectcolor, 0xFFFFFF); break; // Change mouse select-text background color</span></a>
<a name="636"><span class="lineNum">     636 </span>                :            :                                 case 50: break; // set font</a>
<a name="637"><span class="lineNum">     637 </span>                :            :                             }</a>
<a name="638"><span class="lineNum">     638 </span>                :<span class="lineCov">         13 :                             break;</span></a>
<a name="639"><span class="lineNum">     639 </span>                :            :                         }</a>
<a name="640"><span class="lineNum">     640 </span>                :            :                         default:</a>
<a name="641"><span class="lineNum">     641 </span>                :            :                             break;</a>
<a name="642"><span class="lineNum">     642 </span>                :            :                     }</a>
<a name="643"><span class="lineNum">     643 </span>                :<span class="lineCov">         44 :                     goto Ground;</span></a>
<a name="644"><span class="lineNum">     644 </span>                :            :                 }</a>
<a name="645"><span class="lineNum">     645 </span>                :<span class="lineNoCov">          0 :                 lastch=c; ui.BeepOn(); break;</span></a>
<a name="646"><span class="lineNum">     646 </span>                :            :             }</a>
<a name="647"><span class="lineNum">     647 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         26 :             case AnyState(U'\u0090'): p.clear(); [[fallthrough]];</span></a>
<a name="648"><span class="lineNum">     648 </span>                :<span class="lineCov">         26 :             case State(U'P', st_esc): state = st_string; scs = 4; string.clear(); break; // DCS</span></a>
<a name="649"><span class="lineNum">     649 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         14 :             case AnyState(U'\u009D'): p.clear(); [[fallthrough]];</span></a>
<a name="650"><span class="lineNum">     650 </span>                :<span class="lineCov">         14 :             case State(U']', st_esc): state = st_string; scs = 5; string.clear(); break; // OSC</span></a>
<a name="651"><span class="lineNum">     651 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :             case AnyState(U'\u009E'): p.clear(); [[fallthrough]];</span></a>
<a name="652"><span class="lineNum">     652 </span>                :<span class="lineCov">          2 :             case State(U'^', st_esc): state = st_string; scs = 6; string.clear(); break; // PM</span></a>
<a name="653"><span class="lineNum">     653 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :             case AnyState(U'\u009F'): p.clear(); [[fallthrough]];</span></a>
<a name="654"><span class="lineNum">     654 </span>                :<span class="lineCov">          2 :             case State(U'_', st_esc): state = st_string; scs = 7; string.clear(); break; // APC</span></a>
<a name="655"><span class="lineNum">     655 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :             case AnyState(U'\u0098'): p.clear(); [[fallthrough]];</span></a>
<a name="656"><span class="lineNum">     656 </span>                :<span class="lineCov">          2 :             case State(U'X', st_esc): state = st_string; scs = 8; string.clear(); break; // SOS</span></a>
<a name="657"><span class="lineNum">     657 </span>                :            : </a>
<a name="658"><span class="lineNum">     658 </span>                :<span class="lineCov">       8506 :             case CsiState(U'0'): case CsiState(U'1'):</span></a>
<a name="659"><span class="lineNum">     659 </span>                :<span class="lineCov">       8506 :             case CsiState(U'2'): case CsiState(U'3'):</span></a>
<a name="660"><span class="lineNum">     660 </span>                :<span class="lineCov">       8506 :             case CsiState(U'4'): case CsiState(U'5'):</span></a>
<a name="661"><span class="lineNum">     661 </span>                :<span class="lineCov">       8506 :             case CsiState(U'6'): case CsiState(U'7'):</span></a>
<a name="662"><span class="lineNum">     662 </span>                :<span class="lineCov">       8506 :             case CsiState(U'8'): case CsiState(U'9'):</span></a>
<a name="663"><span class="lineNum">     663 </span>        [<span class="branchCov" title="Branch 0 was taken 1303 times"> + </span><span class="branchCov" title="Branch 1 was taken 7203 times"> + </span>]:<span class="lineCov">       8506 :                 if(p.empty()) p.emplace_back();</span></a>
<a name="664"><span class="lineNum">     664 </span>                :<span class="lineCov">       8506 :                 p.back() = p.back() * 10u + (c - U'0');</span></a>
<a name="665"><span class="lineNum">     665 </span>                :<span class="lineCov">       8506 :                 break;</span></a>
<a name="666"><span class="lineNum">     666 </span>                :<span class="lineCov">       3295 :             case CsiState(U':'): case CsiState(U';'):</span></a>
<a name="667"><span class="lineNum">     667 </span>                :<span class="lineCov">       3295 :                 p.emplace_back();</span></a>
<a name="668"><span class="lineNum">     668 </span>                :            :                 break;</a>
<a name="669"><span class="lineNum">     669 </span>                :            : </a>
<a name="670"><span class="lineNum">     670 </span>                :            :             //case AnyState(U'\u0085'): // CASE_NEL</a>
<a name="671"><span class="lineNum">     671 </span>                :<span class="lineCov">          3 :             case State(U'E', st_esc): // esc E = CR+LF</span></a>
<a name="672"><span class="lineNum">     672 </span>                :<span class="lineCov">          3 :                 ClampedMoveX(0);</span></a>
<a name="673"><span class="lineNum">     673 </span>                :<span class="lineCov">          3 :                 state = st_default;</span></a>
<a name="674"><span class="lineNum">     674 </span>                :<span class="lineCov">         16 :                 [[fallthrough]];</span></a>
<a name="675"><span class="lineNum">     675 </span>                :<span class="lineCov">         16 :             case AnyState(10):</span></a>
<a name="676"><span class="lineNum">     676 </span>                :<span class="lineCov">         16 :             case AnyState(11):</span></a>
<a name="677"><span class="lineNum">     677 </span>                :<span class="lineCov">         16 :             case AnyState(12):</span></a>
<a name="678"><span class="lineNum">     678 </span>                :            :             //case AnyState(U'\u0084'):</a>
<a name="679"><span class="lineNum">     679 </span>                :<span class="lineCov">         16 :             case State(U'D', st_esc): // esc D = CASE_IND</span></a>
<a name="680"><span class="lineNum">     680 </span>                :<span class="lineCov">         16 :                 lastch = U'\n';</span></a>
<a name="681"><span class="lineNum">     681 </span>                :            :                 /* Within window: move cursor down; scroll the window up if at bottom */</a>
<a name="682"><span class="lineNum">     682 </span>                :<span class="lineCov">         16 :                 Lf();</span></a>
<a name="683"><span class="lineNum">     683 </span>                :<span class="lineCov">         16 :                 goto Ground;</span></a>
<a name="684"><span class="lineNum">     684 </span>                :            : </a>
<a name="685"><span class="lineNum">     685 </span>                :            :             //case AnyState(U'\u008D'):</a>
<a name="686"><span class="lineNum">     686 </span>                :<span class="lineCov">          1 :             case State(U'M', st_esc): // esc M = CASE_RI</span></a>
<a name="687"><span class="lineNum">     687 </span>                :            :                 /* Within window: move cursor up; scroll the window down if at top */</a>
<a name="688"><span class="lineNum">     688 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if(wnd.cursy == top)</span></a>
<a name="689"><span class="lineNum">     689 </span>                :<span class="lineNoCov">          0 :                     YScrollDown(top, bottom, 1);</span></a>
<a name="690"><span class="lineNum">     690 </span>                :            :                 else</a>
<a name="691"><span class="lineNum">     691 </span>                :<span class="lineCov">          1 :                     ClampedMoveY(wnd.cursy-1);</span></a>
<a name="692"><span class="lineNum">     692 </span>                :<span class="lineCov">          1 :                 goto Ground;</span></a>
<a name="693"><span class="lineNum">     693 </span>                :<span class="lineNoCov">          0 :             case State(U'q', st_csi_quo): // DECSCA: if param0=1, do CASE_SPA; if 0 or 2, do CASE_EPA. Otherwise ignore.</span></a>
<a name="694"><span class="lineNum">     694 </span>                :<span class="lineNoCov">          0 :             {</span></a>
<a name="695"><span class="lineNum">     695 </span>                :<span class="lineNoCov">          0 :                 GetParams(1,false);</span></a>
<a name="696"><span class="lineNum">     696 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if(p[0]==1)</span></a>
<a name="697"><span class="lineNum">     697 </span>                :            :                 {</a>
<a name="698"><span class="lineNum">     698 </span>                :            :             //case AnyState(U'\u0096'):</a>
<a name="699"><span class="lineNum">     699 </span>                :<span class="lineCov">          1 :             case State(U'V', st_esc): // esc V = SPA: start protected area</span></a>
<a name="700"><span class="lineNum">     700 </span>                :<span class="lineCov">          1 :                     wnd.blank.protect = true;</span></a>
<a name="701"><span class="lineNum">     701 </span>                :            :                 }</a>
<a name="702"><span class="lineNum">     702 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 else if(p[0]==0 || p[0]==2)</span></a>
<a name="703"><span class="lineNum">     703 </span>                :            :                 {</a>
<a name="704"><span class="lineNum">     704 </span>                :            :             //case AnyState(U'\u0097'):</a>
<a name="705"><span class="lineNum">     705 </span>                :<span class="lineCov">          1 :             case State(U'W', st_esc): // esc W = EPA: end protected area</span></a>
<a name="706"><span class="lineNum">     706 </span>                :<span class="lineCov">          1 :                     wnd.blank.protect = false;</span></a>
<a name="707"><span class="lineNum">     707 </span>                :            :                 }</a>
<a name="708"><span class="lineNum">     708 </span>                :<span class="lineCov">          2 :                 goto Ground;</span></a>
<a name="709"><span class="lineNum">     709 </span>                :            :             }</a>
<a name="710"><span class="lineNum">     710 </span>                :            :             /*//case AnyState(U'\u0088'): [[fallthrough]];</a>
<a name="711"><span class="lineNum">     711 </span>                :            :             case State(U'H', st_esc): // esc H = CASE_HTS: horizontal tab set</a>
<a name="712"><span class="lineNum">     712 </span>                :            :                 goto Ground;</a>
<a name="713"><span class="lineNum">     713 </span>                :            :             //case AnyState(U'\u0090'): [[fallthrough]];</a>
<a name="714"><span class="lineNum">     714 </span>                :            :             case State(U'P', st_esc): // esc P = CASE_DCS (starts string)</a>
<a name="715"><span class="lineNum">     715 </span>                :            :                 goto Ground;</a>
<a name="716"><span class="lineNum">     716 </span>                :            :             //case AnyState(U'\u009D'): [[fallthrough]];</a>
<a name="717"><span class="lineNum">     717 </span>                :            :             case State(U']', st_esc): // esc ] = CASE_OSC (starts string)</a>
<a name="718"><span class="lineNum">     718 </span>                :            :                 goto Ground;</a>
<a name="719"><span class="lineNum">     719 </span>                :            :             //case AnyState(U'\u009E'): [[fallthrough]];</a>
<a name="720"><span class="lineNum">     720 </span>                :            :             case State(U'^', st_esc): // esc ^ = CASE_PM (starts string)</a>
<a name="721"><span class="lineNum">     721 </span>                :            :                 goto Ground;</a>
<a name="722"><span class="lineNum">     722 </span>                :            :             //case AnyState(U'\u009F'): [[fallthrough]];</a>
<a name="723"><span class="lineNum">     723 </span>                :            :             case State(U'_', st_esc): // esc _ = CASE_APC (starts string)</a>
<a name="724"><span class="lineNum">     724 </span>                :            :                 goto Ground;</a>
<a name="725"><span class="lineNum">     725 </span>                :            :             //case AnyState(U'\u0098'): [[fallthrough]];</a>
<a name="726"><span class="lineNum">     726 </span>                :            :             case State(U'X', st_esc): // esc X = CASE_SOS: start of string</a>
<a name="727"><span class="lineNum">     727 </span>                :            :                 goto Ground;</a>
<a name="728"><span class="lineNum">     728 </span>                :            :             //case AnyState(U'\u009C'): [[fallthrough]];</a>
<a name="729"><span class="lineNum">     729 </span>                :            :             case State(U'\\', st_esc):// esc \\ = CASE_ST: end of string</a>
<a name="730"><span class="lineNum">     730 </span>                :            :                 goto Ground;*/</a>
<a name="731"><span class="lineNum">     731 </span>                :            : </a>
<a name="732"><span class="lineNum">     732 </span>                :<span class="lineCov">          2 :             case State(U'c', st_esc): ResetAttr(); Reset(); goto Ground;         // esc c   (RI - full reset)</span></a>
<a name="733"><span class="lineNum">     733 </span>                :<span class="lineCov">          1 :             case State(U'p', st_csi_ex): ResetAttr(); Reset(false); goto Ground; // CSI ! p (DECSTR - CSI reset)</span></a>
<a name="734"><span class="lineNum">     734 </span>                :            : </a>
<a name="735"><span class="lineNum">     735 </span>                :<span class="lineCov">          3 :             case State(U'7', st_esc): [[fallthrough]]; // esc 7 (DECSC), csi s (ANSI_SC)</span></a>
<a name="736"><span class="lineNum">     736 </span>                :<span class="lineCov">          3 :             case State(U's', st_csi): SaveCur(); goto Ground;</span></a>
<a name="737"><span class="lineNum">     737 </span>                :<span class="lineCov">          3 :             case State(U'8', st_esc): [[fallthrough]]; // esc 8 (DECRC), csi u (ANSI_RC)</span></a>
<a name="738"><span class="lineNum">     738 </span>                :<span class="lineCov">          3 :             case State(U'u', st_csi): RestoreCur(); goto Ground;</span></a>
<a name="739"><span class="lineNum">     739 </span>                :<span class="lineCov">          2 :             case State(U'0', st_scs): gset[scs&amp;3] = 1; goto Ground; // DEC graphics (TODO)</span></a>
<a name="740"><span class="lineNum">     740 </span>                :<span class="lineCov">          2 :             case State(U'1', st_scs): gset[scs&amp;3] = 0; goto Ground; // DEC alt chars?</span></a>
<a name="741"><span class="lineNum">     741 </span>                :<span class="lineCov">          2 :             case State(U'2', st_scs): gset[scs&amp;3] = 0; goto Ground; // DEC alt gfx?</span></a>
<a name="742"><span class="lineNum">     742 </span>                :<span class="lineCov">          2 :             case State(U'`', st_scs): gset[scs&amp;3] = 0; goto Ground; // nor/dan?</span></a>
<a name="743"><span class="lineNum">     743 </span>                :<span class="lineCov">          2 :             case State(U'4', st_scs): gset[scs&amp;3] = 0; goto Ground; // dut?</span></a>
<a name="744"><span class="lineNum">     744 </span>                :<span class="lineCov">          2 :             case State(U'5', st_scs): gset[scs&amp;3] = 0; goto Ground; // fin?</span></a>
<a name="745"><span class="lineNum">     745 </span>                :<span class="lineCov">          2 :             case State(U'6', st_scs): gset[scs&amp;3] = 0; goto Ground; // nor/dan3?</span></a>
<a name="746"><span class="lineNum">     746 </span>                :<span class="lineCov">          2 :             case State(U'7', st_scs): gset[scs&amp;3] = 0; goto Ground; // swe?</span></a>
<a name="747"><span class="lineNum">     747 </span>                :<span class="lineCov">          2 :             case State(U'9', st_scs): gset[scs&amp;3] = 0; goto Ground; // fre/can2?</span></a>
<a name="748"><span class="lineNum">     748 </span>                :<span class="lineCov">          2 :             case State(U'A', st_scs): gset[scs&amp;3] = 0; goto Ground; // british?</span></a>
<a name="749"><span class="lineNum">     749 </span>                :<span class="lineCov">          2 :             case State(U'B', st_scs): gset[scs&amp;3] = 0; goto Ground; // ASCII (TODO)</span></a>
<a name="750"><span class="lineNum">     750 </span>                :<span class="lineCov">          2 :             case State(U'C', st_scs): gset[scs&amp;3] = 0; goto Ground; // fin2?</span></a>
<a name="751"><span class="lineNum">     751 </span>                :<span class="lineCov">          2 :             case State(U'E', st_scs): gset[scs&amp;3] = 0; goto Ground; // nor/dan2?</span></a>
<a name="752"><span class="lineNum">     752 </span>                :<span class="lineCov">          2 :             case State(U'f', st_scs): gset[scs&amp;3] = 0; goto Ground; // fre2?</span></a>
<a name="753"><span class="lineNum">     753 </span>                :<span class="lineCov">          2 :             case State(U'F', st_scs): gset[scs&amp;3] = 0; goto Ground; // iso greek supp?</span></a>
<a name="754"><span class="lineNum">     754 </span>                :<span class="lineCov">          2 :             case State(U'H', st_scs): gset[scs&amp;3] = 0; goto Ground; // swe2? iso hebrew supp?</span></a>
<a name="755"><span class="lineNum">     755 </span>                :<span class="lineCov">          2 :             case State(U'K', st_scs): gset[scs&amp;3] = 0; goto Ground; // ger?</span></a>
<a name="756"><span class="lineNum">     756 </span>                :<span class="lineCov">          2 :             case State(U'L', st_scs): gset[scs&amp;3] = 0; goto Ground; // iso cyr?</span></a>
<a name="757"><span class="lineNum">     757 </span>                :<span class="lineCov">          2 :             case State(U'M', st_scs): gset[scs&amp;3] = 0; goto Ground; // iso5 supp?</span></a>
<a name="758"><span class="lineNum">     758 </span>                :<span class="lineCov">          2 :             case State(U'Q', st_scs): gset[scs&amp;3] = 0; goto Ground; // fre/can?</span></a>
<a name="759"><span class="lineNum">     759 </span>                :<span class="lineCov">          2 :             case State(U'R', st_scs): gset[scs&amp;3] = 0; goto Ground; // fre?</span></a>
<a name="760"><span class="lineNum">     760 </span>                :<span class="lineCov">          2 :             case State(U'&lt;', st_scs): gset[scs&amp;3] = 0; goto Ground; // DEC supp?</span></a>
<a name="761"><span class="lineNum">     761 </span>                :<span class="lineCov">          2 :             case State(U'=', st_scs): gset[scs&amp;3] = 0; goto Ground; // swiss?</span></a>
<a name="762"><span class="lineNum">     762 </span>                :<span class="lineCov">          2 :             case State(U'&gt;', st_scs): gset[scs&amp;3] = 0; goto Ground; // DEC technical</span></a>
<a name="763"><span class="lineNum">     763 </span>                :<span class="lineCov">          2 :             case State(U'U', st_scs): gset[scs&amp;3] = 0; goto Ground; // linux pc?</span></a>
<a name="764"><span class="lineNum">     764 </span>                :<span class="lineCov">          2 :             case State(U'Y', st_scs): gset[scs&amp;3] = 0; goto Ground; // ita?</span></a>
<a name="765"><span class="lineNum">     765 </span>                :<span class="lineCov">          2 :             case State(U'Z', st_scs): gset[scs&amp;3] = 0; goto Ground; // spa?</span></a>
<a name="766"><span class="lineNum">     766 </span>                :<span class="lineCov">          1 :             case State(U'3', st_scr): wnd.LineSetRenderSize(2); goto Ground; // DECDHL top</span></a>
<a name="767"><span class="lineNum">     767 </span>                :<span class="lineCov">          1 :             case State(U'4', st_scr): wnd.LineSetRenderSize(3); goto Ground; // DECDHL bottom</span></a>
<a name="768"><span class="lineNum">     768 </span>                :<span class="lineCov">          1 :             case State(U'5', st_scr): wnd.LineSetRenderSize(0); goto Ground; // DECSWL</span></a>
<a name="769"><span class="lineNum">     769 </span>                :<span class="lineCov">          1 :             case State(U'6', st_scr): wnd.LineSetRenderSize(1); goto Ground; // DECDWL</span></a>
<a name="770"><span class="lineNum">     770 </span>                :<span class="lineCov">          1 :             case State(U'8', st_scr): // clear screen with 'E' // esc # 8</span></a>
<a name="771"><span class="lineNum">     771 </span>                :<span class="lineCov">          1 :                 wnd.blank.ch = U'E';</span></a>
<a name="772"><span class="lineNum">     772 </span>                :<span class="lineCov">          1 :                 wnd.FillBox(0,0, wnd.xsize,wnd.ysize);</span></a>
<a name="773"><span class="lineNum">     773 </span>                :<span class="lineCov">          1 :                 wnd.blank.ch = U' ';</span></a>
<a name="774"><span class="lineNum">     774 </span>                :<span class="lineCov">          1 :                 wnd.cursx = wnd.cursy = 0;</span></a>
<a name="775"><span class="lineNum">     775 </span>                :<span class="lineCov">          1 :                 goto Ground;</span></a>
<a name="776"><span class="lineNum">     776 </span>                :<span class="lineCov">          1 :             case State(U'@', st_esc_percent): utfmode = 0; goto Ground; // esc % @</span></a>
<a name="777"><span class="lineNum">     777 </span>                :<span class="lineCov">          2 :             case State(U'G', st_esc_percent): [[fallthrough]];          // esc % G</span></a>
<a name="778"><span class="lineNum">     778 </span>                :<span class="lineCov">          2 :             case State(U'8', st_esc_percent): utfmode = 1; goto Ground; // esc % 8</span></a>
<a name="779"><span class="lineNum">     779 </span>                :<span class="lineCov">          1 :             case State(U'g', st_csi): /* TODO: set tab stops */ goto Ground;</span></a>
<a name="780"><span class="lineNum">     780 </span>                :<span class="lineCov">          1 :             case State(U'q', st_csi): /* TODO: set leds */ goto Ground;</span></a>
<a name="781"><span class="lineNum">     781 </span>                :<span class="lineCov">          2 :             case State(U'G', st_csi): [[fallthrough]];</span></a>
<a name="782"><span class="lineNum">     782 </span>                :<span class="lineCov">          2 :             case State(U'`', st_csi): { GetParams(1,true); ClampedMoveX(p[0]-1);        break; } // absolute hpos</span></a>
<a name="783"><span class="lineNum">     783 </span>                :<span class="lineCov">          1 :             case State(U'd', st_csi): { GetParams(1,true); ClampedMoveY(p[0]-1, false); break; } // absolute vpos</span></a>
<a name="784"><span class="lineNum">     784 </span>                :<span class="lineCov">          2 :             case State(U'F', st_csi): ClampedMoveX(0); [[fallthrough]];</span></a>
<a name="785"><span class="lineNum">     785 </span>                :<span class="lineCov">          7 :             case State(U'A', st_csi): { GetParams(1,true); ClampedMoveY(wnd.cursy-p[0]); break; }</span></a>
<a name="786"><span class="lineNum">     786 </span>                :<span class="lineCov">          2 :             case State(U'E', st_csi): ClampedMoveX(0); [[fallthrough]];</span></a>
<a name="787"><span class="lineNum">     787 </span>                :<span class="lineCov">          9 :             case State(U'e', st_csi): [[fallthrough]];</span></a>
<a name="788"><span class="lineNum">     788 </span>                :<span class="lineCov">          9 :             case State(U'B', st_csi): { GetParams(1,true); ClampedMoveY(wnd.cursy+p[0]); break; }</span></a>
<a name="789"><span class="lineNum">     789 </span>                :<span class="lineCov">        109 :             case State(U'a', st_csi): [[fallthrough]];</span></a>
<a name="790"><span class="lineNum">     790 </span>                :<span class="lineCov">        109 :             case State(U'C', st_csi): { GetParams(1,true); ClampedMoveX(wnd.cursx+p[0]); break; }</span></a>
<a name="791"><span class="lineNum">     791 </span>                :<span class="lineCov">          5 :             case State(U'D', st_csi): { GetParams(1,true); ClampedMoveX(wnd.cursx-p[0]); break; }</span></a>
<a name="792"><span class="lineNum">     792 </span>                :<span class="lineCov">         45 :             case State(U'H', st_csi): [[fallthrough]];</span></a>
<a name="793"><span class="lineNum">     793 </span>                :<span class="lineCov">         45 :             case State(U'f', st_csi): { GetParams(2,true); ClampedMove(p[1]-1, p[0]-1, false); break; }</span></a>
<a name="794"><span class="lineNum">     794 </span>                :<span class="lineCov">          6 :             case State(U'J', st_csi):</span></a>
<a name="795"><span class="lineNum">     795 </span>                :<span class="lineCov">          6 :             case State(U'J', st_csi_quo):</span></a>
<a name="796"><span class="lineNum">     796 </span>                :<span class="lineCov">          6 :                 GetParams(1,false);</span></a>
<a name="797"><span class="lineNum">     797 </span>  [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                 switch(p[0])</span></a>
<a name="798"><span class="lineNum">     798 </span>                :            :                 {</a>
<a name="799"><span class="lineNum">     799 </span>                :<span class="lineCov">          2 :                     case 0: // erase from cursor to end of display</span></a>
<a name="800"><span class="lineNum">     800 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                         if(wnd.cursy &lt; wnd.ysize-1)</span></a>
<a name="801"><span class="lineNum">     801 </span>                :<span class="lineCov">          2 :                             wnd.FillBox(0,wnd.cursy+1, wnd.xsize, wnd.ysize-wnd.cursy-1, wnd.blank);</span></a>
<a name="802"><span class="lineNum">     802 </span>                :<span class="lineCov">          2 :                         goto clreol;</span></a>
<a name="803"><span class="lineNum">     803 </span>                :<span class="lineCov">          2 :                     case 1: // erase from start to cursor</span></a>
<a name="804"><span class="lineNum">     804 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                         if(wnd.cursy &gt; 0) wnd.FillBox(0,0, wnd.xsize,wnd.cursy, wnd.blank);</span></a>
<a name="805"><span class="lineNum">     805 </span>                :<span class="lineCov">          2 :                         goto clrbol;</span></a>
<a name="806"><span class="lineNum">     806 </span>                :<span class="lineCov">          2 :                     case 2: // erase whole display</span></a>
<a name="807"><span class="lineNum">     807 </span>                :<span class="lineCov">          2 :                         wnd.FillBox(0,0, wnd.xsize,wnd.ysize, wnd.blank);</span></a>
<a name="808"><span class="lineNum">     808 </span>                :            :                         break;</a>
<a name="809"><span class="lineNum">     809 </span>                :            :                 }</a>
<a name="810"><span class="lineNum">     810 </span>                :            :                 break;</a>
<a name="811"><span class="lineNum">     811 </span>                :<span class="lineCov">          6 :             case State(U'K', st_csi):</span></a>
<a name="812"><span class="lineNum">     812 </span>                :<span class="lineCov">          6 :             case State(U'K', st_csi_quo):</span></a>
<a name="813"><span class="lineNum">     813 </span>                :<span class="lineCov">          6 :                 GetParams(1,false);</span></a>
<a name="814"><span class="lineNum">     814 </span>                :            :                 // 0: erase from cursor to end of line</a>
<a name="815"><span class="lineNum">     815 </span>                :            :                 // 1: erase from start of line to cursor</a>
<a name="816"><span class="lineNum">     816 </span>                :            :                 // 2: erase whole line</a>
<a name="817"><span class="lineNum">     817 </span>  [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :                 switch(p[0])</span></a>
<a name="818"><span class="lineNum">     818 </span>                :            :                 {</a>
<a name="819"><span class="lineNum">     819 </span>                :<span class="lineCov">          4 :                     case 0: clreol: wnd.FillBox(wnd.cursx,wnd.cursy, wnd.xsize-wnd.cursx, 1, wnd.blank); break;</span></a>
<a name="820"><span class="lineNum">     820 </span>                :<span class="lineCov">          4 :                     case 1: clrbol: wnd.FillBox(0,        wnd.cursy, wnd.cursx+1,  1, wnd.blank); break;</span></a>
<a name="821"><span class="lineNum">     821 </span>                :<span class="lineCov">          2 :                     case 2: wnd.FillBox(0, wnd.cursy, wnd.xsize,    1, wnd.blank); break;</span></a>
<a name="822"><span class="lineNum">     822 </span>                :            :                 }</a>
<a name="823"><span class="lineNum">     823 </span>                :            :                 break;</a>
<a name="824"><span class="lineNum">     824 </span>                :<span class="lineCov">          1 :             case State(U'M', st_csi):</span></a>
<a name="825"><span class="lineNum">     825 </span>                :<span class="lineCov">          1 :                 GetParams(1,true);</span></a>
<a name="826"><span class="lineNum">     826 </span>                :<span class="lineCov">          1 :                 YScrollUp(wnd.cursy, bottom, p[0]);</span></a>
<a name="827"><span class="lineNum">     827 </span>                :            :                 break;</a>
<a name="828"><span class="lineNum">     828 </span>                :<span class="lineCov">          1 :             case State(U'L', st_csi):</span></a>
<a name="829"><span class="lineNum">     829 </span>                :<span class="lineCov">          1 :                 GetParams(1,true);</span></a>
<a name="830"><span class="lineNum">     830 </span>                :            :                 // scroll the rest of window c lines down,</a>
<a name="831"><span class="lineNum">     831 </span>                :            :                 // including where cursor is. Don't move cursor.</a>
<a name="832"><span class="lineNum">     832 </span>                :<span class="lineCov">          1 :                 YScrollDown(wnd.cursy, bottom, p[0]);</span></a>
<a name="833"><span class="lineNum">     833 </span>                :            :                 break;</a>
<a name="834"><span class="lineNum">     834 </span>                :<span class="lineCov">          1 :             case State(U'S', st_csi): // xterm version?</span></a>
<a name="835"><span class="lineNum">     835 </span>                :<span class="lineCov">          1 :                 GetParams(1,true);</span></a>
<a name="836"><span class="lineNum">     836 </span>                :<span class="lineCov">          1 :                 YScrollUp(top, bottom, p[0]);</span></a>
<a name="837"><span class="lineNum">     837 </span>                :            :                 break;</a>
<a name="838"><span class="lineNum">     838 </span>                :<span class="lineCov">          1 :             case State(U'T', st_csi): // csi T, track mouse</span></a>
<a name="839"><span class="lineNum">     839 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span> :<span class="lineCov">          1 :                 if(p.size() &gt; 1 || p.empty() || p[0]==0)</span></a>
<span class="lineNum">         </span>         <span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<a name="840"><span class="lineNum">     840 </span>                :            :                 {</a>
<a name="841"><span class="lineNum">     841 </span>                :            :                     // mouse track</a>
<a name="842"><span class="lineNum">     842 </span>                :<span class="lineCov">          1 :                     goto Ground;</span></a>
<a name="843"><span class="lineNum">     843 </span>                :            :                 }</a>
<a name="844"><span class="lineNum">     844 </span>                :<span class="lineCov">          1 :                 [[fallthrough]];</span></a>
<a name="845"><span class="lineNum">     845 </span>                :<span class="lineCov">          1 :             case State(U'^', st_csi): // csi ^ , scroll down</span></a>
<a name="846"><span class="lineNum">     846 </span>                :<span class="lineCov">          1 :                 GetParams(1,true);</span></a>
<a name="847"><span class="lineNum">     847 </span>                :            :                 // Reverse scrolling by N lines</a>
<a name="848"><span class="lineNum">     848 </span>                :            :                 // scroll the entire of window c lines down. Don't move cursor.</a>
<a name="849"><span class="lineNum">     849 </span>                :<span class="lineCov">          1 :                 YScrollDown(top, bottom, p[0]);</span></a>
<a name="850"><span class="lineNum">     850 </span>                :            :                 break;</a>
<a name="851"><span class="lineNum">     851 </span>                :<span class="lineCov">          1 :             case State(U'P', st_csi):</span></a>
<a name="852"><span class="lineNum">     852 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 GetParams(1,true); c = std::min(p[0], unsigned(wnd.xsize-wnd.cursx));</span></a>
<a name="853"><span class="lineNum">     853 </span>                :            :                 // insert c black holes at cursor (eat c characters</a>
<a name="854"><span class="lineNum">     854 </span>                :            :                 // and scroll line horizontally to left)</a>
<a name="855"><span class="lineNum">     855 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                 if(c)</span></a>
<a name="856"><span class="lineNum">     856 </span>                :            :                 {</a>
<a name="857"><span class="lineNum">     857 </span>                :<span class="lineCov">          1 :                     unsigned remain = wnd.xsize - (wnd.cursx+c);</span></a>
<a name="858"><span class="lineNum">     858 </span>                :<span class="lineCov">          1 :                     wnd.CopyText(wnd.cursx,wnd.cursy, wnd.xsize-remain,wnd.cursy, remain,1);</span></a>
<a name="859"><span class="lineNum">     859 </span>                :<span class="lineCov">          1 :                     wnd.FillBox(wnd.xsize-c,wnd.cursy, c,1);</span></a>
<a name="860"><span class="lineNum">     860 </span>                :            :                 }</a>
<a name="861"><span class="lineNum">     861 </span>                :            :                 break;</a>
<a name="862"><span class="lineNum">     862 </span>                :<span class="lineCov">          1 :             case State(U'X', st_csi): // (ECH)</span></a>
<a name="863"><span class="lineNum">     863 </span>                :<span class="lineCov">          1 :                 GetParams(1,true);</span></a>
<a name="864"><span class="lineNum">     864 </span>                :            :                 // write c spaces at cursor (overwrite)</a>
<a name="865"><span class="lineNum">     865 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 wnd.FillBox(wnd.cursx,wnd.cursy, std::min(std::size_t(p[0]), wnd.xsize-wnd.cursx), 1);</span></a>
<a name="866"><span class="lineNum">     866 </span>                :<span class="lineCov">          1 :                 break;</span></a>
<a name="867"><span class="lineNum">     867 </span>                :<span class="lineCov">          1 :             case State(U'@', st_csi):</span></a>
<a name="868"><span class="lineNum">     868 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 GetParams(1,true); c = std::min(p[0], unsigned(wnd.xsize-wnd.cursx));</span></a>
<a name="869"><span class="lineNum">     869 </span>                :            :                 // insert c spaces at cursor</a>
<a name="870"><span class="lineNum">     870 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                 if(c)</span></a>
<a name="871"><span class="lineNum">     871 </span>                :            :                 {</a>
<a name="872"><span class="lineNum">     872 </span>                :<span class="lineCov">          1 :                     unsigned remain = wnd.xsize - (wnd.cursx+c);</span></a>
<a name="873"><span class="lineNum">     873 </span>                :<span class="lineCov">          1 :                     wnd.CopyText(wnd.cursx+c,wnd.cursy, wnd.cursx,wnd.cursy, remain,1);</span></a>
<a name="874"><span class="lineNum">     874 </span>                :<span class="lineCov">          1 :                     wnd.FillBox(wnd.cursx,wnd.cursy, c,1);</span></a>
<a name="875"><span class="lineNum">     875 </span>                :            :                 }</a>
<a name="876"><span class="lineNum">     876 </span>                :            :                 break;</a>
<a name="877"><span class="lineNum">     877 </span>                :<span class="lineCov">          1 :             case State(U'r', st_csi): // CSI r</span></a>
<a name="878"><span class="lineNum">     878 </span>                :<span class="lineCov">          1 :                 GetParams(2,false);</span></a>
<a name="879"><span class="lineNum">     879 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                 if(!p[0]) p[0]=1;</span></a>
<a name="880"><span class="lineNum">     880 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                 if(!p[1]) p[1]=wnd.ysize;</span></a>
<a name="881"><span class="lineNum">     881 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :                 if(p[0] &lt; p[1] &amp;&amp; p[1] &lt;= wnd.ysize)</span></a>
<a name="882"><span class="lineNum">     882 </span>                :            :                 {</a>
<a name="883"><span class="lineNum">     883 </span>                :<span class="lineCov">          1 :                     top = p[0]-1; bottom = p[1]-1;</span></a>
<a name="884"><span class="lineNum">     884 </span>                :            :                     //fprintf(stderr, &quot;Creating a window with top=%zu, bottom=%zu\n&quot;, top,bottom);</a>
<a name="885"><span class="lineNum">     885 </span>                :<span class="lineCov">          1 :                     ClampedMove(0, top, false);</span></a>
<a name="886"><span class="lineNum">     886 </span>                :            :                 }</a>
<a name="887"><span class="lineNum">     887 </span>                :            :                 break;</a>
<a name="888"><span class="lineNum">     888 </span>                :<span class="lineCov">          3 :             case State(U'n', st_csi):</span></a>
<a name="889"><span class="lineNum">     889 </span>                :<span class="lineCov">          3 :                 GetParams(1,false);</span></a>
<a name="890"><span class="lineNum">     890 </span>     [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          3 :                 switch(p[0])</span></a>
<a name="891"><span class="lineNum">     891 </span>                :            :                 {</a>
<a name="892"><span class="lineNum">     892 </span>                :<span class="lineCov">          1 :                     char Buf[32];</span></a>
<a name="893"><span class="lineNum">     893 </span>                :<span class="lineCov">          2 :                     case 5: EchoBack(U&quot;\33[0n&quot;); break;</span></a>
<a name="894"><span class="lineNum">     894 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                     case 6: EchoBack(FromUTF8(std::string_view{Buf, (std::size_t)std::sprintf(Buf, &quot;\33[%zu;%zuR&quot;, wnd.cursy+1, wnd.cursx+1)})); break;</span></a>
<a name="895"><span class="lineNum">     895 </span>                :            :                 }</a>
<a name="896"><span class="lineNum">     896 </span>                :            :                 break;</a>
<a name="897"><span class="lineNum">     897 </span>                :<span class="lineCov">          1 :             case State(U'c', st_csi_dec3): // csi = 0 c, Tertiary device attributes (printer?)</span></a>
<a name="898"><span class="lineNum">     898 </span>                :<span class="lineCov">          1 :                 GetParams(1,false); // Tertiary device attributes (printer?)</span></a>
<a name="899"><span class="lineNum">     899 </span>                :            :                 // Example response: &lt;ESC&gt; P ! | 0 &lt;ST&gt;</a>
<a name="900"><span class="lineNum">     900 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                 if(!p[0]) EchoBack(U&quot;\33P!|00000000\x9C&quot;); // Note: DCS response</span></a>
<a name="901"><span class="lineNum">     901 </span>                :            :                 break;</a>
<a name="902"><span class="lineNum">     902 </span>                :<span class="lineCov">          1 :             case State(U'c', st_csi_dec2): // csi &gt; 0 c, Secondary device attributes (terminal)</span></a>
<a name="903"><span class="lineNum">     903 </span>                :<span class="lineCov">          1 :                 GetParams(1,false);</span></a>
<a name="904"><span class="lineNum">     904 </span>                :            :                 // Example response: ^[[&gt;41;344;0c  (middle=firmware version)</a>
<a name="905"><span class="lineNum">     905 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                 if(!p[0]) EchoBack(U&quot;\33[&gt;1;1;0c&quot;);</span></a>
<a name="906"><span class="lineNum">     906 </span>                :            :                 break;</a>
<a name="907"><span class="lineNum">     907 </span>                :<span class="lineCov">          2 :             case State(U'c', st_csi): // csi 0 c // Primary device attributes (host computer)</span></a>
<a name="908"><span class="lineNum">     908 </span>                :<span class="lineCov">          2 :                 GetParams(1,false);</span></a>
<a name="909"><span class="lineNum">     909 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                 if(!p[0])</span></a>
<a name="910"><span class="lineNum">     910 </span>                :            :                 {</a>
<a name="911"><span class="lineNum">     911 </span>                :            :             //case AnyState(U'\u009A'): [[fallthrough]];</a>
<a name="912"><span class="lineNum">     912 </span>                :<span class="lineCov">          3 :             case State(U'Z', st_esc): // esc Z = CASE_DECID</span></a>
<a name="913"><span class="lineNum">     913 </span>                :<span class="lineCov">          6 :                     EchoBack(U&quot;\33[?65;1;6;8;15;22c&quot;);</span></a>
<a name="914"><span class="lineNum">     914 </span>                :            :                 }</a>
<a name="915"><span class="lineNum">     915 </span>                :            :                 // Example response: ^[[?64;1;2;6;9;15;18;21;22c</a>
<a name="916"><span class="lineNum">     916 </span>                :            :                 //  1=132 columns, 2=printer port, 4=sixel extension</a>
<a name="917"><span class="lineNum">     917 </span>                :            :                 //  6=selective erase, 7=DRCS, 8=user-defines keys</a>
<a name="918"><span class="lineNum">     918 </span>                :            :                 //  9=national replacement charsets, 12=SCS extension</a>
<a name="919"><span class="lineNum">     919 </span>                :            :                 // 15=technical charset, 18=windowing capability, 21=horiz scrolling,</a>
<a name="920"><span class="lineNum">     920 </span>                :            :                 // 22=ansi color/vt525, 29=ansi text locator</a>
<a name="921"><span class="lineNum">     921 </span>                :            :                 // 23=greek ext, 24=turkish ext, 42=latin2 cset, 44=pcterm,</a>
<a name="922"><span class="lineNum">     922 </span>                :            :                 // 45=softkeymap, 46=ascii emulation</a>
<a name="923"><span class="lineNum">     923 </span>                :            :                 // 62..69 = VT level (62=VT200, 63=VT300, 64=VT400)</a>
<a name="924"><span class="lineNum">     924 </span>                :            :                 break;</a>
<a name="925"><span class="lineNum">     925 </span>                :<span class="lineCov">          3 :             case State(U'h', st_csi_dec): // csi ? h, misc modes on</span></a>
<a name="926"><span class="lineNum">     926 </span>                :<span class="lineCov">          3 :             case State(U'l', st_csi_dec): // csi ? l, misc modes off</span></a>
<a name="927"><span class="lineNum">     927 </span>                :<span class="lineCov">          3 :             case State(U'p', st_csi_dec_dol): // csi ? $p, query</span></a>
<a name="928"><span class="lineNum">     928 </span>                :<span class="lineCov">          3 :             {</span></a>
<a name="929"><span class="lineNum">     929 </span>                :<span class="lineCov">          3 :                 bool set = c == U'h', query = c == U'p';</span></a>
<a name="930"><span class="lineNum">     930 </span>                :<span class="lineCov">          3 :                 char Buf[32];</span></a>
<a name="931"><span class="lineNum">     931 </span>                :            :                 // 1=CKM, 2=ANM, 3=COLM, 4=SCLM, 5=SCNM, 6=OM, 7=AWM, 8=ARM,</a>
<a name="932"><span class="lineNum">     932 </span>                :            :                 // 18=PFF, 19=PEX, 25=TCEM, 40=132COLS, 42=NRCM,</a>
<a name="933"><span class="lineNum">     933 </span>                :            :                 // 44=MARGINBELL, ...</a>
<a name="934"><span class="lineNum">     934 </span>                :            :                 //   6 puts cursor at (0,0) both set,clear</a>
<a name="935"><span class="lineNum">     935 </span>                :            :                 //  25 enables/disables cursor visibility</a>
<a name="936"><span class="lineNum">     936 </span>                :            :                 //  40 enables/disables 80/132 mode (note: if enabled, RESET changes to one of these)</a>
<a name="937"><span class="lineNum">     937 </span>                :            :                 //   3 sets width at 132(enable), 80(disable) if &quot;40&quot; is enabled</a>
<a name="938"><span class="lineNum">     938 </span>                :            :                 //   5 = screenwide inverse color</a>
<a name="939"><span class="lineNum">     939 </span>                :<span class="lineCov">          3 :                 GetParams(0, false);</span></a>
<a name="940"><span class="lineNum">     940 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          6 :                 for(auto a: p)</span></a>
<a name="941"><span class="lineNum">     941 </span>                :            :                 {</a>
<a name="942"><span class="lineNum">     942 </span>                :<span class="lineCov">          3 :                     unsigned value = 0; // unsupported</span></a>
<a name="943"><span class="lineNum">     943 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          3 :                     switch(a)</span></a>
<a name="944"><span class="lineNum">     944 </span>                :            :                     {</a>
<a name="945"><span class="lineNum">     945 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                         case 6:  if(query) value = 2; else ClampedMove(0, top, false); break;</span></a>
<a name="946"><span class="lineNum">     946 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                         case 25: if(query) value = wnd.cursorvis?1:2; else wnd.cursorvis = set; break;</span></a>
<a name="947"><span class="lineNum">     947 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :                         case 5:  if(query) value = wnd.inverse?1:2;   else wnd.inverse   = set; break;</span></a>
<a name="948"><span class="lineNum">     948 </span>                :            :                     }</a>
<a name="949"><span class="lineNum">     949 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          3 :                     if(query)</span></a>
<a name="950"><span class="lineNum">     950 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                         EchoBack(FromUTF8(std::string_view{Buf, (std::size_t)</span></a>
<a name="951"><span class="lineNum">     951 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                             std::sprintf(Buf, &quot;\33[?%u;%u$y&quot;, a, value)}));</span></a>
<a name="952"><span class="lineNum">     952 </span>                :            :                 }</a>
<a name="953"><span class="lineNum">     953 </span>                :<span class="lineCov">          3 :                 break;</span></a>
<a name="954"><span class="lineNum">     954 </span>                :            :             }</a>
<a name="955"><span class="lineNum">     955 </span>                :<span class="lineCov">          4 :             case State(U'h', st_csi): // csi h, ansi modes on</span></a>
<a name="956"><span class="lineNum">     956 </span>                :<span class="lineCov">          4 :             case State(U'l', st_csi): // csi l, ansi modes off</span></a>
<a name="957"><span class="lineNum">     957 </span>                :<span class="lineCov">          4 :             case State(U'p', st_csi_dol): // csi $p, query</span></a>
<a name="958"><span class="lineNum">     958 </span>                :<span class="lineCov">          4 :             {</span></a>
<a name="959"><span class="lineNum">     959 </span>                :<span class="lineCov">          4 :                 bool /*set = c == U'h',*/ query = c == U'p';</span></a>
<a name="960"><span class="lineNum">     960 </span>                :<span class="lineCov">          4 :                 char Buf[32];</span></a>
<a name="961"><span class="lineNum">     961 </span>                :            :                 // 2 = keyboard locked</a>
<a name="962"><span class="lineNum">     962 </span>                :            :                 // 4 = insert mode</a>
<a name="963"><span class="lineNum">     963 </span>                :            :                 // 12 = no local echo</a>
<a name="964"><span class="lineNum">     964 </span>                :            :                 // 20 = auto linefeed</a>
<a name="965"><span class="lineNum">     965 </span>                :<span class="lineCov">          4 :                 GetParams(0, false);</span></a>
<a name="966"><span class="lineNum">     966 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          8 :                 for(auto a: p)</span></a>
<a name="967"><span class="lineNum">     967 </span>                :            :                 {</a>
<a name="968"><span class="lineNum">     968 </span>                :<span class="lineCov">          4 :                     unsigned value = 0; // unsupported</span></a>
<a name="969"><span class="lineNum">     969 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span> :<span class="lineCov">          4 :                     switch(a)</span></a>
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 4 was not taken"> - </span>]
<a name="970"><span class="lineNum">     970 </span>                :            :                     {</a>
<a name="971"><span class="lineNum">     971 </span>                :<span class="lineCov">          1 :                         case 2: value = 4; break; // permanently unset</span></a>
<a name="972"><span class="lineNum">     972 </span>                :<span class="lineCov">          1 :                         case 4: value = 4; break; // permanently unset</span></a>
<a name="973"><span class="lineNum">     973 </span>                :<span class="lineCov">          1 :                         case 12: value = 4; break; // permanently unset</span></a>
<a name="974"><span class="lineNum">     974 </span>                :<span class="lineCov">          1 :                         case 20: value = 4; break; // permanently unset</span></a>
<a name="975"><span class="lineNum">     975 </span>                :            :                     }</a>
<a name="976"><span class="lineNum">     976 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          4 :                     if(query)</span></a>
<a name="977"><span class="lineNum">     977 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          4 :                         EchoBack(FromUTF8(std::string_view{Buf, (std::size_t)</span></a>
<a name="978"><span class="lineNum">     978 </span>                :<span class="lineCov">          2 :                             std::sprintf(Buf, &quot;\33[%u;%u$y&quot;, a, value)}));</span></a>
<a name="979"><span class="lineNum">     979 </span>                :            :                 }</a>
<a name="980"><span class="lineNum">     980 </span>                :<span class="lineCov">          4 :                 break;</span></a>
<a name="981"><span class="lineNum">     981 </span>                :            :             }</a>
<a name="982"><span class="lineNum">     982 </span>                :<span class="lineCov">          1 :             case State(U'v', st_csi_dol): // csi $v (DECCRA): copy rectangular area</span></a>
<a name="983"><span class="lineNum">     983 </span>                :<span class="lineCov">          1 :             {</span></a>
<a name="984"><span class="lineNum">     984 </span>                :<span class="lineCov">          1 :                 GetParams(7,true);</span></a>
<a name="985"><span class="lineNum">     985 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 unsigned pts=p[0], pls=p[1], pbs=p[2], prs=p[3], ptd=p[5], pld=p[6];</span></a>
<a name="986"><span class="lineNum">     986 </span>                :            :                 // Ignores [4] = source page number, [7] = target page number.</a>
<a name="987"><span class="lineNum">     987 </span>                :            :                 // Note: Xterm parses params from right to left, meaning that</a>
<a name="988"><span class="lineNum">     988 </span>                :            :                 //       for xterm, our [3] is actually [n-5]</a>
<a name="989"><span class="lineNum">     989 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if(pbs &gt; wnd.ysize) pbs = wnd.ysize;</span></a>
<a name="990"><span class="lineNum">     990 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if(prs &gt; wnd.xsize) prs = wnd.xsize;</span></a>
<a name="991"><span class="lineNum">     991 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if(ptd &gt; wnd.ysize) ptd = wnd.ysize;</span></a>
<a name="992"><span class="lineNum">     992 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if(pld &gt; wnd.xsize) pld = wnd.ysize;</span></a>
<a name="993"><span class="lineNum">     993 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                 if(pts &lt;= pbs &amp;&amp; pls &lt;= prs)</span></a>
<a name="994"><span class="lineNum">     994 </span>                :            :                 {</a>
<a name="995"><span class="lineNum">     995 </span>                :<span class="lineCov">          1 :                     unsigned width = prs-pls+1, height = pbs-pts+1;</span></a>
<a name="996"><span class="lineNum">     996 </span>                :<span class="lineCov">          1 :                     --pld;--ptd;--pls;--pts;</span></a>
<a name="997"><span class="lineNum">     997 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                     if(pld+width &gt; wnd.xsize) width = wnd.xsize-pld;</span></a>
<a name="998"><span class="lineNum">     998 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                     if(ptd+height &gt; wnd.ysize) height = wnd.ysize-ptd;</span></a>
<a name="999"><span class="lineNum">     999 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                     if(width &amp;&amp; height)</span></a>
<a name="1000"><span class="lineNum">    1000 </span>                :<span class="lineCov">          1 :                         wnd.CopyText(pld,ptd, pls,pts, width,height);</span></a>
<a name="1001"><span class="lineNum">    1001 </span>                :            :                 }</a>
<a name="1002"><span class="lineNum">    1002 </span>                :            :                 break;</a>
<a name="1003"><span class="lineNum">    1003 </span>                :            :             }</a>
<a name="1004"><span class="lineNum">    1004 </span>                :<span class="lineCov">          1 :             case State(U'z', st_csi_dol): // csi $z: fill rectangular area with space</span></a>
<a name="1005"><span class="lineNum">    1005 </span>                :<span class="lineCov">          1 :             {                             //         but don't touch attributes.</span></a>
<a name="1006"><span class="lineNum">    1006 </span>                :<span class="lineCov">          1 :                 GetParams(4,true);</span></a>
<a name="1007"><span class="lineNum">    1007 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 unsigned pts=p[0], pls=p[1], pbs=p[2], prs=p[3];</span></a>
<a name="1008"><span class="lineNum">    1008 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if(pbs &gt; wnd.ysize) pbs = wnd.ysize;</span></a>
<a name="1009"><span class="lineNum">    1009 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if(prs &gt; wnd.xsize) prs = wnd.xsize;</span></a>
<a name="1010"><span class="lineNum">    1010 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :                 for(unsigned y=pts; y&lt;=pbs; ++y)</span></a>
<a name="1011"><span class="lineNum">    1011 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :                     for(unsigned x=pls; x&lt;=prs; ++x)</span></a>
<a name="1012"><span class="lineNum">    1012 </span>                :<span class="lineCov">          1 :                         wnd.PutCh_KeepAttr(x-1, y-1, U' ', false);</span></a>
<a name="1013"><span class="lineNum">    1013 </span>                :            :                 break;</a>
<a name="1014"><span class="lineNum">    1014 </span>                :            :             }</a>
<a name="1015"><span class="lineNum">    1015 </span>                :<span class="lineCov">          1 :             case State(U'x', st_csi_dol): // csi $x: fill rectangular area with given char</span></a>
<a name="1016"><span class="lineNum">    1016 </span>                :<span class="lineCov">          1 :             {</span></a>
<a name="1017"><span class="lineNum">    1017 </span>                :<span class="lineCov">          1 :                 GetParams(5,true);</span></a>
<a name="1018"><span class="lineNum">    1018 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 unsigned ch=p[0], pts=p[1], pls=p[2], pbs=p[3], prs=p[4];</span></a>
<a name="1019"><span class="lineNum">    1019 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if(pbs &gt; wnd.ysize) pbs = wnd.ysize;</span></a>
<a name="1020"><span class="lineNum">    1020 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if(prs &gt; wnd.xsize) prs = wnd.xsize;</span></a>
<a name="1021"><span class="lineNum">    1021 </span>                :<span class="lineCov">          1 :                 bool dbl = isdouble(ch);</span></a>
<a name="1022"><span class="lineNum">    1022 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :                 for(unsigned y=pts; y&lt;=pbs; ++y)</span></a>
<a name="1023"><span class="lineNum">    1023 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          2 :                     for(unsigned x=pls; x&lt;=prs; ++x)</span></a>
<a name="1024"><span class="lineNum">    1024 </span>                :<span class="lineCov">          1 :                         wnd.PutCh(x-1, y-1, ch, dbl);</span></a>
<a name="1025"><span class="lineNum">    1025 </span>                :            :                 break;</a>
<a name="1026"><span class="lineNum">    1026 </span>                :            :             }</a>
<a name="1027"><span class="lineNum">    1027 </span>                :<span class="lineCov">          2 :             case State(U'r', st_csi_dol): // csi $r: DECCARA: change attributes in rectangular area</span></a>
<a name="1028"><span class="lineNum">    1028 </span>                :<span class="lineCov">          2 :             case State(U't', st_csi_dol): // csi $t: DECRARA: toggle attributes in rectangular area</span></a>
<a name="1029"><span class="lineNum">    1029 </span>                :<span class="lineCov">          2 :             {</span></a>
<a name="1030"><span class="lineNum">    1030 </span>                :<span class="lineCov">          2 :                 bool toggle = (c == U't');</span></a>
<a name="1031"><span class="lineNum">    1031 </span>                :<span class="lineCov">          2 :                 GetParams(5, true); // Make sure there is at least 1 SGR param</span></a>
<a name="1032"><span class="lineNum">    1032 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                 unsigned pts=p[0], pls=p[1], pbs=p[2], prs=p[3];</span></a>
<a name="1033"><span class="lineNum">    1033 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                 if(pbs &gt; wnd.ysize) pbs = wnd.ysize;</span></a>
<a name="1034"><span class="lineNum">    1034 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                 if(prs &gt; wnd.xsize) prs = wnd.xsize;</span></a>
<a name="1035"><span class="lineNum">    1035 </span>                :<span class="lineCov">          2 :                 --pts;--pbs;--pls;--prs;</span></a>
<a name="1036"><span class="lineNum">    1036 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          4 :                 for(unsigned y=pts; y&lt;=pbs; ++y)</span></a>
<a name="1037"><span class="lineNum">    1037 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          4 :                     for(unsigned x=pls; x&lt;=prs; ++x)</span></a>
<a name="1038"><span class="lineNum">    1038 </span>                :            :                     {</a>
<a name="1039"><span class="lineNum">    1039 </span>                :<span class="lineCov">          2 :                         auto&amp; cell = wnd.cells[y*wnd.xsize+x];</span></a>
<a name="1040"><span class="lineNum">    1040 </span>                :<span class="lineCov">          2 :                         auto temp = cell;</span></a>
<a name="1041"><span class="lineNum">    1041 </span>                :<span class="lineCov">          2 :                         c=0;</span></a>
<a name="1042"><span class="lineNum">    1042 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          4 :                         for(auto ai = std::next(p.cbegin(), 4); ai != p.end(); ++ai)</span></a>
<a name="1043"><span class="lineNum">    1043 </span>                :<span class="lineCov">          2 :                             ProcessSGR(c, *ai,</span></a>
<a name="1044"><span class="lineNum">    1044 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 [&amp;]() { if(!toggle) temp = Cell{}; },</span></a>
<a name="1045"><span class="lineNum">    1045 </span>                :<span class="lineCov">          2 :                                 [&amp;](auto&amp;&amp; setter, auto&amp;&amp; getter, auto newvalue)</span></a>
<a name="1046"><span class="lineNum">    1046 </span>                :            :                                 {</a>
<a name="1047"><span class="lineNum">    1047 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">          2 :                                     if(toggle)</span></a>
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span><span class="branchNoCov" title="Branch 13 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 14 was not taken"> - </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span><span class="branchNoCov" title="Branch 16 was not taken"> - </span><span class="branchNoCov" title="Branch 17 was not taken"> - </span><span class="branchNoCov" title="Branch 18 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 19 was not taken"> - </span><span class="branchNoCov" title="Branch 20 was not taken"> - </span><span class="branchNoCov" title="Branch 21 was not taken"> - </span><span class="branchNoCov" title="Branch 22 was not taken"> - </span><span class="branchNoCov" title="Branch 23 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 24 was not taken"> - </span><span class="branchNoCov" title="Branch 25 was not taken"> - </span><span class="branchNoCov" title="Branch 26 was not taken"> - </span><span class="branchNoCov" title="Branch 27 was not taken"> - </span><span class="branchNoCov" title="Branch 28 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 29 was not taken"> - </span><span class="branchNoCov" title="Branch 30 was not taken"> - </span><span class="branchNoCov" title="Branch 31 was not taken"> - </span><span class="branchNoCov" title="Branch 32 was not taken"> - </span><span class="branchNoCov" title="Branch 33 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 34 was not taken"> - </span><span class="branchNoCov" title="Branch 35 was not taken"> - </span><span class="branchNoCov" title="Branch 36 was not taken"> - </span><span class="branchNoCov" title="Branch 37 was not taken"> - </span><span class="branchNoCov" title="Branch 38 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 39 was not taken"> - </span><span class="branchNoCov" title="Branch 40 was not taken"> - </span><span class="branchNoCov" title="Branch 41 was not taken"> - </span><span class="branchNoCov" title="Branch 42 was not taken"> - </span><span class="branchNoCov" title="Branch 43 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 44 was not taken"> - </span><span class="branchNoCov" title="Branch 45 was not taken"> - </span><span class="branchNoCov" title="Branch 46 was not taken"> - </span><span class="branchNoCov" title="Branch 47 was not taken"> - </span><span class="branchNoCov" title="Branch 48 was not taken"> - </span> 
<span class="lineNum">         </span>      <span class="branchNoCov" title="Branch 49 was not taken"> - </span><span class="branchNoCov" title="Branch 50 was not taken"> - </span><span class="branchNoCov" title="Branch 51 was not taken"> - </span>]
<a name="1048"><span class="lineNum">    1048 </span>                :            :                                     {</a>
<a name="1049"><span class="lineNum">    1049 </span>                :            :                                         // Note: toggling using a SGR command</a>
<a name="1050"><span class="lineNum">    1050 </span>                :            :                                         //       that clears the attribute does nothing,</a>
<a name="1051"><span class="lineNum">    1051 </span>                :            :                                         //       because value XOR 0 is value.</a>
<a name="1052"><span class="lineNum">    1052 </span>                :            :                                         //       This matches what XTerm does.</a>
<a name="1053"><span class="lineNum">    1053 </span>                :<span class="lineCov">          1 :                                         newvalue ^= getter(temp);</span></a>
<a name="1054"><span class="lineNum">    1054 </span>                :            :                                     }</a>
<a name="1055"><span class="lineNum">    1055 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">          2 :                                     setter(temp, newvalue);</span></a>
<span class="lineNum">         </span>   <span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<a name="1056"><span class="lineNum">    1056 </span>                :            :                                 }</a>
<a name="1057"><span class="lineNum">    1057 </span>                :            :                                       );</a>
<a name="1058"><span class="lineNum">    1058 </span>                :<span class="lineCov">          2 :                         temp.ch = cell.ch;</span></a>
<a name="1059"><span class="lineNum">    1059 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                         if(temp != cell)</span></a>
<a name="1060"><span class="lineNum">    1060 </span>                :            :                         {</a>
<a name="1061"><span class="lineNum">    1061 </span>                :<span class="lineCov">          2 :                             cell       = temp;</span></a>
<a name="1062"><span class="lineNum">    1062 </span>                :<span class="lineCov">          2 :                             cell.dirty = true;</span></a>
<a name="1063"><span class="lineNum">    1063 </span>                :            :                         }</a>
<a name="1064"><span class="lineNum">    1064 </span>                :            :                     }</a>
<a name="1065"><span class="lineNum">    1065 </span>                :<span class="lineCov">          2 :                 break;</span></a>
<a name="1066"><span class="lineNum">    1066 </span>                :            :             }</a>
<a name="1067"><span class="lineNum">    1067 </span>                :<span class="lineCov">          1 :             case State(U'b', st_csi):</span></a>
<a name="1068"><span class="lineNum">    1068 </span>                :<span class="lineCov">          1 :             {</span></a>
<a name="1069"><span class="lineNum">    1069 </span>                :<span class="lineCov">          1 :                 GetParams(1,true);</span></a>
<a name="1070"><span class="lineNum">    1070 </span>                :            :                 // Repeat last printed character n times</a>
<a name="1071"><span class="lineNum">    1071 </span>                :<span class="lineCov">          1 :                 bool dbl = isdouble(lastch);</span></a>
<a name="1072"><span class="lineNum">    1072 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 5 times"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">          6 :                 for(unsigned m = std::min(p[0], unsigned(wnd.xsize*wnd.ysize)), c=0; c&lt;m; ++c)</span></a>
<a name="1073"><span class="lineNum">    1073 </span>                :            :                 {</a>
<a name="1074"><span class="lineNum">    1074 </span>                :<span class="lineCov">          5 :                     PutC(lastch, dbl);</span></a>
<a name="1075"><span class="lineNum">    1075 </span>                :            :                 }</a>
<a name="1076"><span class="lineNum">    1076 </span>                :            :                 break;</a>
<a name="1077"><span class="lineNum">    1077 </span>                :            :             }</a>
<a name="1078"><span class="lineNum">    1078 </span>                :<span class="lineCov">       1091 :             case State(U'm', st_csi): // csi m (SGR)</span></a>
<a name="1079"><span class="lineNum">    1079 </span>                :<span class="lineCov">       1091 :             {</span></a>
<a name="1080"><span class="lineNum">    1080 </span>                :<span class="lineCov">       1091 :                 GetParams(1, false); // Make sure there is at least 1 param</span></a>
<a name="1081"><span class="lineNum">    1081 </span>                :<span class="lineCov">       1091 :                 c=0;</span></a>
<a name="1082"><span class="lineNum">    1082 </span>        [<span class="branchCov" title="Branch 0 was taken 4267 times"> + </span><span class="branchCov" title="Branch 1 was taken 1091 times"> + </span>]:<span class="lineCov">       5358 :                 for(auto a: p)</span></a>
<a name="1083"><span class="lineNum">    1083 </span>                :<span class="lineCov">       4267 :                     ProcessSGR(c,a,</span></a>
<a name="1084"><span class="lineNum">    1084 </span>                :<span class="lineCov">          2 :                         [&amp;]() { ResetAttr(); },</span></a>
<a name="1085"><span class="lineNum">    1085 </span>                :<span class="lineCov">       1199 :                         [&amp;](auto&amp;&amp; setter, auto&amp;&amp; /*getter*/, auto newvalue)</span></a>
<a name="1086"><span class="lineNum">    1086 </span>                :<span class="lineCov">       1198 :                             { setter(wnd.blank, newvalue); }</span></a>
<a name="1087"><span class="lineNum">    1087 </span>                :            :                               );</a>
<a name="1088"><span class="lineNum">    1088 </span>                :<span class="lineCov">       1091 :                 break;</span></a>
<a name="1089"><span class="lineNum">    1089 </span>                :            :             }</a>
<a name="1090"><span class="lineNum">    1090 </span>                :            : </a>
<a name="1091"><span class="lineNum">    1091 </span>                :<span class="lineCov">       6200 :             default:</span></a>
<a name="1092"><span class="lineNum">    1092 </span>        [<span class="branchCov" title="Branch 0 was taken 38 times"> + </span><span class="branchCov" title="Branch 1 was taken 6162 times"> + </span>]:<span class="lineCov">       6200 :                 if(state == st_string) state = st_string_str;</span></a>
<a name="1093"><span class="lineNum">    1093 </span>        [<span class="branchCov" title="Branch 0 was taken 105 times"> + </span><span class="branchCov" title="Branch 1 was taken 6095 times"> + </span>]:<span class="lineCov">       6200 :                 if(state == st_string_str)</span></a>
<a name="1094"><span class="lineNum">    1094 </span>                :            :                 {</a>
<a name="1095"><span class="lineNum">    1095 </span>                :<span class="lineCov">      22592 :                     string += c;</span></a>
<a name="1096"><span class="lineNum">    1096 </span>                :            :                     break;</a>
<a name="1097"><span class="lineNum">    1097 </span>                :            :                 }</a>
<a name="1098"><span class="lineNum">    1098 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 6084 times"> + </span>]:<span class="lineCov">       6095 :                 if(state != st_default) goto Ground;</span></a>
<a name="1099"><span class="lineNum">    1099 </span>                :<span class="lineCov">       6084 :                 PutC(lastch = c, isdouble(c));</span></a>
<a name="1100"><span class="lineNum">    1100 </span>                :            :                 break;</a>
<a name="1101"><span class="lineNum">    1101 </span>                :            :         }</a>
<a name="1102"><span class="lineNum">    1102 </span>                :            :     }</a>
<a name="1103"><span class="lineNum">    1103 </span>                :            :     #undef AnyState</a>
<a name="1104"><span class="lineNum">    1104 </span>                :<span class="lineCov">        773 : }</span></a>
<a name="1105"><span class="lineNum">    1105 </span>                :            : </a>
<a name="1106"><span class="lineNum">    1106 </span>                :<span class="lineCov">         19 : void TerminalWindow::EchoBack(std::u32string_view buffer)</span></a>
<a name="1107"><span class="lineNum">    1107 </span>                :            : {</a>
<a name="1108"><span class="lineNum">    1108 </span>                :            :     //Write(buffer, size); // DEBUGGING</a>
<a name="1109"><span class="lineNum">    1109 </span>                :<span class="lineCov">         19 :     OutBuffer.insert(OutBuffer.end(), buffer.begin(), buffer.end());</span></a>
<a name="1110"><span class="lineNum">    1110 </span>                :<span class="lineCov">         19 : }</span></a>
<a name="1111"><span class="lineNum">    1111 </span>                :            : </a>
<a name="1112"><span class="lineNum">    1112 </span>                :<span class="lineCov">        401 : void TerminalWindow::SaveCur()</span></a>
<a name="1113"><span class="lineNum">    1113 </span>                :            : {</a>
<a name="1114"><span class="lineNum">    1114 </span>                :<span class="lineCov">        401 :     backup.cx = wnd.cursx;</span></a>
<a name="1115"><span class="lineNum">    1115 </span>                :<span class="lineCov">        401 :     backup.cy = wnd.cursy;</span></a>
<a name="1116"><span class="lineNum">    1116 </span>                :<span class="lineCov">        401 :     backup.attr = wnd.blank;</span></a>
<a name="1117"><span class="lineNum">    1117 </span>                :<span class="lineCov">        401 : }</span></a>
<a name="1118"><span class="lineNum">    1118 </span>                :            : </a>
<a name="1119"><span class="lineNum">    1119 </span>                :<span class="lineCov">          3 : void TerminalWindow::RestoreCur()</span></a>
<a name="1120"><span class="lineNum">    1120 </span>                :            : {</a>
<a name="1121"><span class="lineNum">    1121 </span>                :<span class="lineCov">          3 :     wnd.cursx = backup.cx;</span></a>
<a name="1122"><span class="lineNum">    1122 </span>                :<span class="lineCov">          3 :     wnd.cursy = backup.cy;</span></a>
<a name="1123"><span class="lineNum">    1123 </span>                :<span class="lineCov">          3 :     wnd.blank = backup.attr;</span></a>
<a name="1124"><span class="lineNum">    1124 </span>                :<span class="lineCov">          3 : }</span></a>
<a name="1125"><span class="lineNum">    1125 </span>                :            : </a>
<a name="1126"><span class="lineNum">    1126 </span>                :<span class="lineCov">          1 : void TerminalWindow::Resize(std::size_t newsx, std::size_t newsy)</span></a>
<a name="1127"><span class="lineNum">    1127 </span>                :            : {</a>
<a name="1128"><span class="lineNum">    1128 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     if(bottom == wnd.ysize-1)</span></a>
<a name="1129"><span class="lineNum">    1129 </span>                :            :     {</a>
<a name="1130"><span class="lineNum">    1130 </span>                :<span class="lineCov">          1 :         bottom = newsy-1;</span></a>
<a name="1131"><span class="lineNum">    1131 </span>                :            :         //fprintf(stderr, &quot;Creating a window with top=%zu, bottom=%zu\n&quot;, top,bottom);</a>
<a name="1132"><span class="lineNum">    1132 </span>                :            :     }</a>
<a name="1133"><span class="lineNum">    1133 </span>                :<span class="lineCov">          1 :     wnd.Resize(newsx, newsy);</span></a>
<a name="1134"><span class="lineNum">    1134 </span>                :<span class="lineCov">          1 : }</span></a>
<a name="1135"><span class="lineNum">    1135 </span>                :            : </a>
<a name="1136"><span class="lineNum">    1136 </span>                :            : #ifdef RUN_TESTS</a>
<a name="1137"><span class="lineNum">    1137 </span>                :            : template&lt;typename F&gt;</a>
<a name="1138"><span class="lineNum">    1138 </span>                :<span class="lineCov">        397 : static auto TerminalTest(int w, int h, std::u32string_view sample, F&amp;&amp; test)</span></a>
<a name="1139"><span class="lineNum">    1139 </span>                :            : {</a>
<a name="1140"><span class="lineNum">    1140 </span>                :<span class="lineCov">        397 :     Window wnd(w, h);</span></a>
<a name="1141"><span class="lineNum">    1141 </span>        [<span class="branchCov" title="Branch 0 was taken 397 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        397 :     TerminalWindow term(wnd);</span></a>
<a name="1142"><span class="lineNum">    1142 </span>        [<span class="branchCov" title="Branch 0 was taken 397 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        397 :     term.Write(sample);</span></a>
<a name="1143"><span class="lineNum">    1143 </span>                :<span class="lineCov">        741 :     return test(wnd);</span></a>
<a name="1144"><span class="lineNum">    1144 </span>                :<span class="lineCov">        397 : }</span></a>
<a name="1145"><span class="lineNum">    1145 </span>                :            : template&lt;typename F&gt;</a>
<a name="1146"><span class="lineNum">    1146 </span>                :<span class="lineCov">        345 : static auto TerminalTest(std::u32string_view sample, F&amp;&amp; test)</span></a>
<a name="1147"><span class="lineNum">    1147 </span>                :            : {</a>
<a name="1148"><span class="lineNum">    1148 </span>                :<span class="lineCov">        345 :     return TerminalTest(80, 25, sample, test);</span></a>
<a name="1149"><span class="lineNum">    1149 </span>                :            : }</a>
<a name="1150"><span class="lineNum">    1150 </span>                :<span class="lineCov">        309 : static auto TerminalTestSGR(std::u32string_view sample)</span></a>
<a name="1151"><span class="lineNum">    1151 </span>                :            : {</a>
<a name="1152"><span class="lineNum">    1152 </span>                :<span class="lineCov">        618 :     return TerminalTest(sample, [&amp;](auto&amp; wnd) { return wnd.blank; });</span></a>
<a name="1153"><span class="lineNum">    1153 </span>                :            : }</a>
<a name="1154"><span class="lineNum">    1154 </span>                :<span class="lineCov">         52 : static auto TerminalTestCursor(int w, int h, std::u32string_view sample)</span></a>
<a name="1155"><span class="lineNum">    1155 </span>                :            : {</a>
<a name="1156"><span class="lineNum">    1156 </span>                :<span class="lineCov">         52 :     return TerminalTest(w,h, sample, [&amp;](auto&amp; wnd)</span></a>
<a name="1157"><span class="lineNum">    1157 </span>                :            :     {</a>
<a name="1158"><span class="lineNum">    1158 </span>                :            :         // Return the following:</a>
<a name="1159"><span class="lineNum">    1159 </span>                :            :         // Cursor location (x, y)</a>
<a name="1160"><span class="lineNum">    1160 </span>                :            :         // Location of first symbol non-space within window</a>
<a name="1161"><span class="lineNum">    1161 </span>                :            :         // Location of last symbol non-space within window</a>
<a name="1162"><span class="lineNum">    1162 </span>                :            :         // Number of non-space symbols within window</a>
<a name="1163"><span class="lineNum">    1163 </span>                :<span class="lineCov">         52 :         std::array&lt;unsigned,5&gt; result{ (unsigned)wnd.cursx, (unsigned)wnd.cursy, ~0u, 0, 0 };</span></a>
<a name="1164"><span class="lineNum">    1164 </span>        [<span class="branchCov" title="Branch 0 was taken 1664 times"> + </span><span class="branchCov" title="Branch 1 was taken 52 times"> + </span>]:<span class="lineCov">       1716 :         for(unsigned p=0; p&lt;wnd.cells.size(); ++p)</span></a>
<a name="1165"><span class="lineNum">    1165 </span>        [<span class="branchCov" title="Branch 0 was taken 54 times"> + </span><span class="branchCov" title="Branch 1 was taken 1610 times"> + </span>]:<span class="lineCov">       1664 :             if(wnd.cells[p].ch != U' ')</span></a>
<a name="1166"><span class="lineNum">    1166 </span>                :            :             {</a>
<a name="1167"><span class="lineNum">    1167 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchCov" title="Branch 1 was taken 42 times"> + </span>]:<span class="lineCov">         54 :                 if(result[2] == ~0u) result[2] = p;</span></a>
<a name="1168"><span class="lineNum">    1168 </span>                :<span class="lineCov">         54 :                 result[3] = p;</span></a>
<a name="1169"><span class="lineNum">    1169 </span>                :<span class="lineCov">         54 :                 ++result[4];</span></a>
<a name="1170"><span class="lineNum">    1170 </span>                :            :             }</a>
<a name="1171"><span class="lineNum">    1171 </span>        [<span class="branchCov" title="Branch 0 was taken 40 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         52 :         if(result[2] == ~0u) result[2] = 0u;</span></a>
<a name="1172"><span class="lineNum">    1172 </span>                :<span class="lineCov">         52 :         return result;</span></a>
<a name="1173"><span class="lineNum">    1173 </span>                :<span class="lineCov">         52 :     });</span></a>
<a name="1174"><span class="lineNum">    1174 </span>                :            : }</a>
<a name="1175"><span class="lineNum">    1175 </span>                :            : </a>
<a name="1176"><span class="lineNum">    1176 </span>                :            : </a>
<a name="1177"><span class="lineNum">    1177 </span>                :<span class="lineCov">          3 : TEST(terminal, text_rendering_works)</span></a>
<a name="1178"><span class="lineNum">    1178 </span>                :            : {</a>
<a name="1179"><span class="lineNum">    1179 </span>                :<span class="lineCov">          2 :     EXPECT_TRUE(TerminalTest(U&quot;&quot;, [&amp;](auto&amp; wnd)</span></a>
<a name="1180"><span class="lineNum">    1180 </span>                :            :     {</a>
<a name="1181"><span class="lineNum">    1181 </span>                :            :         return wnd.cells[0].ch == U' ';</a>
<a name="1182"><span class="lineNum">    1182 </span>                :<span class="lineNoCov">          0 :     }));</span></a>
<a name="1183"><span class="lineNum">    1183 </span>                :<span class="lineCov">          3 :     EXPECT_TRUE(TerminalTest(U&quot;OK&quot;, [&amp;](auto&amp; wnd)</span></a>
<a name="1184"><span class="lineNum">    1184 </span>                :            :     {</a>
<a name="1185"><span class="lineNum">    1185 </span>                :            :         return wnd.cells[0].ch == U'O' &amp;&amp; wnd.cells[1].ch == U'K' &amp;&amp; wnd.cells[2].ch == U' ';</a>
<a name="1186"><span class="lineNum">    1186 </span>                :<span class="lineNoCov">          0 :     }));</span></a>
<a name="1187"><span class="lineNum">    1187 </span>                :<span class="lineCov">          3 :     EXPECT_TRUE(TerminalTest(U&quot;O\rK&quot;, [&amp;](auto&amp; wnd)</span></a>
<a name="1188"><span class="lineNum">    1188 </span>                :            :     {</a>
<a name="1189"><span class="lineNum">    1189 </span>                :            :         return wnd.cells[0].ch == U'K' &amp;&amp; wnd.cells[1].ch == U' ';</a>
<a name="1190"><span class="lineNum">    1190 </span>                :<span class="lineNoCov">          0 :     }));</span></a>
<a name="1191"><span class="lineNum">    1191 </span>                :<span class="lineCov">          3 :     EXPECT_TRUE(TerminalTest(U&quot;OK\b!&quot;, [&amp;](auto&amp; wnd)</span></a>
<a name="1192"><span class="lineNum">    1192 </span>                :            :     {</a>
<a name="1193"><span class="lineNum">    1193 </span>                :            :         return wnd.cells[0].ch == U'O' &amp;&amp; wnd.cells[1].ch == U'!';</a>
<a name="1194"><span class="lineNum">    1194 </span>                :<span class="lineNoCov">          0 :     }));</span></a>
<a name="1195"><span class="lineNum">    1195 </span>                :<span class="lineCov">          3 :     EXPECT_TRUE(TerminalTest(U&quot;O\tK&quot;, [&amp;](auto&amp; wnd)</span></a>
<a name="1196"><span class="lineNum">    1196 </span>                :            :     {</a>
<a name="1197"><span class="lineNum">    1197 </span>                :            :         return wnd.cells[0].ch == U'O' &amp;&amp; wnd.cells[8].ch == U'K';</a>
<a name="1198"><span class="lineNum">    1198 </span>                :<span class="lineNoCov">          0 :     }));</span></a>
<a name="1199"><span class="lineNum">    1199 </span>                :<span class="lineCov">          3 :     EXPECT_TRUE(TerminalTest(U&quot; O\tK&quot;, [&amp;](auto&amp; wnd)</span></a>
<a name="1200"><span class="lineNum">    1200 </span>                :            :     {</a>
<a name="1201"><span class="lineNum">    1201 </span>                :            :         return wnd.cells[1].ch == U'O' &amp;&amp; wnd.cells[8].ch == U'K';</a>
<a name="1202"><span class="lineNum">    1202 </span>                :<span class="lineNoCov">          0 :     }));</span></a>
<a name="1203"><span class="lineNum">    1203 </span>                :<span class="lineCov">          3 :     EXPECT_TRUE(TerminalTest(U&quot;O\nK&quot;, [&amp;](auto&amp; wnd)</span></a>
<a name="1204"><span class="lineNum">    1204 </span>                :            :     {</a>
<a name="1205"><span class="lineNum">    1205 </span>                :            :         return wnd.cells[0].ch == U'O' &amp;&amp; wnd.cells[81].ch == U'K';</a>
<a name="1206"><span class="lineNum">    1206 </span>                :<span class="lineCov">          1 :     }));</span></a>
<a name="1207"><span class="lineNum">    1207 </span>                :<span class="lineCov">          1 : }</span></a>
<a name="1208"><span class="lineNum">    1208 </span>                :<span class="lineCov">          3 : TEST(terminal, sgr_attributes)</span></a>
<a name="1209"><span class="lineNum">    1209 </span>                :            : {</a>
<a name="1210"><span class="lineNum">    1210 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[0m&quot;), []{Cell tmp; return tmp; }());</span></a>
<a name="1211"><span class="lineNum">    1211 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[1m&quot;), []{Cell tmp; tmp.bold=true; return tmp; }());</span></a>
<a name="1212"><span class="lineNum">    1212 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[2m&quot;), []{Cell tmp; tmp.dim=true; return tmp; }());</span></a>
<a name="1213"><span class="lineNum">    1213 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[3m&quot;), []{Cell tmp; tmp.italic=true; return tmp; }());</span></a>
<a name="1214"><span class="lineNum">    1214 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[4m&quot;), []{Cell tmp; tmp.underline=true; return tmp; }());</span></a>
<a name="1215"><span class="lineNum">    1215 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[5m&quot;), []{Cell tmp; tmp.blink=1; return tmp; }());</span></a>
<a name="1216"><span class="lineNum">    1216 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[6m&quot;), []{Cell tmp; tmp.blink=2; return tmp; }());</span></a>
<a name="1217"><span class="lineNum">    1217 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[7m&quot;), []{Cell tmp; tmp.inverse=true; return tmp; }());</span></a>
<a name="1218"><span class="lineNum">    1218 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[9m&quot;), []{Cell tmp; tmp.overstrike=true; return tmp; }());</span></a>
<a name="1219"><span class="lineNum">    1219 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[21m&quot;), []{Cell tmp; tmp.underline2=true; return tmp; }());</span></a>
<a name="1220"><span class="lineNum">    1220 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[53m&quot;), []{Cell tmp; tmp.overlined=true; return tmp; }());</span></a>
<a name="1221"><span class="lineNum">    1221 </span>                :            : </a>
<a name="1222"><span class="lineNum">    1222 </span>                :<span class="lineCov">          4 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[1;2;3;4;7;21;22m&quot;), []{Cell tmp; tmp.bold=tmp.dim=tmp.italic=tmp.underline=tmp.underline2=tmp.inverse=1; tmp.dim=tmp.bold=0; return tmp; }());</span></a>
<a name="1223"><span class="lineNum">    1223 </span>                :<span class="lineCov">          4 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[1;2;3;4;7;21;23m&quot;), []{Cell tmp; tmp.bold=tmp.dim=tmp.italic=tmp.underline=tmp.underline2=tmp.inverse=1; tmp.italic=tmp.fraktur=0; return tmp; }());</span></a>
<a name="1224"><span class="lineNum">    1224 </span>                :<span class="lineCov">          4 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[1;2;3;4;7;21;24m&quot;), []{Cell tmp; tmp.bold=tmp.dim=tmp.italic=tmp.underline=tmp.underline2=tmp.inverse=1; tmp.underline=tmp.underline2=0; return tmp; }());</span></a>
<a name="1225"><span class="lineNum">    1225 </span>                :<span class="lineCov">          4 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[1;2;3;4;7;21;25m&quot;), []{Cell tmp; tmp.bold=tmp.dim=tmp.italic=tmp.underline=tmp.underline2=tmp.inverse=1; tmp.blink=0; return tmp; }());</span></a>
<a name="1226"><span class="lineNum">    1226 </span>                :<span class="lineCov">          4 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[1;2;3;4;7;21;27m&quot;), []{Cell tmp; tmp.bold=tmp.dim=tmp.italic=tmp.underline=tmp.underline2=tmp.inverse=1; tmp.inverse=0; return tmp; }());</span></a>
<a name="1227"><span class="lineNum">    1227 </span>                :<span class="lineCov">          4 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[1;2;9;4;7;21;29m&quot;), []{Cell tmp; tmp.bold=tmp.dim=tmp.overstrike=tmp.underline=tmp.underline2=tmp.inverse=1; tmp.overstrike=0; return tmp; }());</span></a>
<a name="1228"><span class="lineNum">    1228 </span>                :<span class="lineCov">          4 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[1;5;53;2;55m&quot;),     []{Cell tmp; tmp.blink=tmp.bold=tmp.overlined=tmp.dim=1; tmp.overlined=0; return tmp; }());</span></a>
<a name="1229"><span class="lineNum">    1229 </span>                :<span class="lineCov">          1 : }</span></a>
<a name="1230"><span class="lineNum">    1230 </span>                :<span class="lineCov">          3 : TEST(terminal, sgr_colors)</span></a>
<a name="1231"><span class="lineNum">    1231 </span>                :            : {</a>
<a name="1232"><span class="lineNum">    1232 </span>                :<span class="lineCov">          1 :     char Buf[32];</span></a>
<a name="1233"><span class="lineNum">    1233 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          9 :     for(unsigned n=0; n&lt;8; ++n)</span></a>
<a name="1234"><span class="lineNum">    1234 </span>                :            :     {</a>
<a name="1235"><span class="lineNum">    1235 </span>                :<span class="lineCov">          8 :         std::sprintf(Buf, &quot;\33[%dm&quot;, 30+n);</span></a>
<a name="1236"><span class="lineNum">    1236 </span>                :<span class="lineCov">         24 :         EXPECT_EQ(TerminalTestSGR(FromUTF8(Buf)), [n]{Cell tmp; tmp.fgcolor=xterm256table[n]; return tmp; }());</span></a>
<a name="1237"><span class="lineNum">    1237 </span>                :<span class="lineCov">          8 :         std::sprintf(Buf, &quot;\33[%dm&quot;, 40+n);</span></a>
<a name="1238"><span class="lineNum">    1238 </span>                :<span class="lineCov">         24 :         EXPECT_EQ(TerminalTestSGR(FromUTF8(Buf)), [n]{Cell tmp; tmp.bgcolor=xterm256table[n]; return tmp; }());</span></a>
<a name="1239"><span class="lineNum">    1239 </span>                :<span class="lineCov">          8 :         std::sprintf(Buf, &quot;\33[%dm&quot;, 90+n);</span></a>
<a name="1240"><span class="lineNum">    1240 </span>                :<span class="lineCov">         24 :         EXPECT_EQ(TerminalTestSGR(FromUTF8(Buf)), [n]{Cell tmp; tmp.fgcolor=xterm256table[n+8]; return tmp; }());</span></a>
<a name="1241"><span class="lineNum">    1241 </span>                :<span class="lineCov">          8 :         std::sprintf(Buf, &quot;\33[%dm&quot;, 100+n);</span></a>
<a name="1242"><span class="lineNum">    1242 </span>                :<span class="lineCov">         32 :         EXPECT_EQ(TerminalTestSGR(FromUTF8(Buf)), [n]{Cell tmp; tmp.bgcolor=xterm256table[n+8]; return tmp; }());</span></a>
<a name="1243"><span class="lineNum">    1243 </span>                :            :     }</a>
<a name="1244"><span class="lineNum">    1244 </span>        [<span class="branchCov" title="Branch 0 was taken 256 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">        257 :     for(unsigned n=0; n&lt;256; ++n)</span></a>
<a name="1245"><span class="lineNum">    1245 </span>                :            :     {</a>
<a name="1246"><span class="lineNum">    1246 </span>                :<span class="lineCov">        256 :         std::sprintf(Buf, &quot;\33[38;5;%d;48;5;%dm&quot;, n, 255-n);</span></a>
<a name="1247"><span class="lineNum">    1247 </span>                :<span class="lineCov">        768 :         EXPECT_EQ(TerminalTestSGR(FromUTF8(Buf)), [n]{Cell tmp; tmp.fgcolor=xterm256table[n];</span></a>
<a name="1248"><span class="lineNum">    1248 </span>                :<span class="lineCov">        256 :                                                                 tmp.bgcolor=xterm256table[255-n]; return tmp; }());</span></a>
<a name="1249"><span class="lineNum">    1249 </span>                :            :     }</a>
<a name="1250"><span class="lineNum">    1250 </span>                :            :     // RGB24</a>
<a name="1251"><span class="lineNum">    1251 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[38;2;0;0;0;48;2;255;255;255m&quot;),</span></a>
<a name="1252"><span class="lineNum">    1252 </span>                :            :                                                   []{Cell tmp; tmp.fgcolor=0x000000;</a>
<a name="1253"><span class="lineNum">    1253 </span>                :<span class="lineNoCov">          0 :                                                                tmp.bgcolor=0xFFFFFF; return tmp; }());</span></a>
<a name="1254"><span class="lineNum">    1254 </span>                :            :     // CMY</a>
<a name="1255"><span class="lineNum">    1255 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[38;3;0;0;0;48;3;255;255;255m&quot;),</span></a>
<a name="1256"><span class="lineNum">    1256 </span>                :            :                                                   []{Cell tmp; tmp.fgcolor=cmy2rgb(0x000000);</a>
<a name="1257"><span class="lineNum">    1257 </span>                :<span class="lineNoCov">          0 :                                                                tmp.bgcolor=cmy2rgb(0xFFFFFF); return tmp; }());</span></a>
<a name="1258"><span class="lineNum">    1258 </span>                :            :     // CMYK</a>
<a name="1259"><span class="lineNum">    1259 </span>                :<span class="lineCov">          4 :     EXPECT_EQ(TerminalTestSGR(U&quot;\33[38;4;0;0;0;0;48;4;255;255;255;255m&quot;),</span></a>
<a name="1260"><span class="lineNum">    1260 </span>                :            :                                                   []{Cell tmp; tmp.fgcolor=cmyk2rgb(0x00000000);</a>
<a name="1261"><span class="lineNum">    1261 </span>                :<span class="lineNoCov">          0 :                                                                tmp.bgcolor=cmyk2rgb(0xFFFFFFFF); return tmp; }());</span></a>
<a name="1262"><span class="lineNum">    1262 </span>                :            :     // Make sure it gets rendered by this color</a>
<a name="1263"><span class="lineNum">    1263 </span>                :<span class="lineCov">          3 :     EXPECT_TRUE(TerminalTest(U&quot;\33[32mA&quot;, [&amp;](Window&amp; wnd)</span></a>
<a name="1264"><span class="lineNum">    1264 </span>                :            :     {</a>
<a name="1265"><span class="lineNum">    1265 </span>                :            :         return wnd.cells[0].fgcolor == xterm256table[2];</a>
<a name="1266"><span class="lineNum">    1266 </span>                :<span class="lineCov">          1 :     }));</span></a>
<a name="1267"><span class="lineNum">    1267 </span>                :<span class="lineCov">          1 : }</span></a>
<a name="1268"><span class="lineNum">    1268 </span>                :<span class="lineCov">          3 : TEST(terminal, save_restore)</span></a>
<a name="1269"><span class="lineNum">    1269 </span>                :            : {</a>
<a name="1270"><span class="lineNum">    1270 </span>                :<span class="lineCov">          3 :     EXPECT_TRUE(TerminalTest(U&quot;ABC&quot; U&quot;\33[s&quot; U&quot;\33[32mDE\33[34mF&quot; U&quot;\33[u&quot; U&quot;G\33[35mH&quot;, [&amp;](Window&amp; wnd)</span></a>
<a name="1271"><span class="lineNum">    1271 </span>                :            :     {</a>
<a name="1272"><span class="lineNum">    1272 </span>                :            :         return wnd.cells[0].ch == 'A' &amp;&amp; wnd.cells[1].ch == 'B' &amp;&amp; wnd.cells[2].ch == 'C'</a>
<a name="1273"><span class="lineNum">    1273 </span>                :            :         &amp;&amp;     wnd.cells[3].ch == 'G' &amp;&amp; wnd.cells[4].ch == 'H' &amp;&amp; wnd.cells[5].ch == 'F'</a>
<a name="1274"><span class="lineNum">    1274 </span>                :            :         &amp;&amp;     wnd.cells[3].fgcolor == Cell{}.fgcolor</a>
<a name="1275"><span class="lineNum">    1275 </span>                :            :         &amp;&amp;     wnd.cells[4].fgcolor == xterm256table[5]</a>
<a name="1276"><span class="lineNum">    1276 </span>                :            :         &amp;&amp;     wnd.cells[5].fgcolor == xterm256table[4];</a>
<a name="1277"><span class="lineNum">    1277 </span>                :<span class="lineCov">          1 :     }));</span></a>
<a name="1278"><span class="lineNum">    1278 </span>                :<span class="lineCov">          1 : }</span></a>
<a name="1279"><span class="lineNum">    1279 </span>                :<span class="lineCov">          3 : TEST(terminal, cursor_movements)</span></a>
<a name="1280"><span class="lineNum">    1280 </span>                :            : {</a>
<a name="1281"><span class="lineNum">    1281 </span>                :            :     // CR, LF....</a>
<a name="1282"><span class="lineNum">    1282 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;ABC&quot;),      (std::array{3u,0u, 0u,2u,3u}));</span></a>
<a name="1283"><span class="lineNum">    1283 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;AB\rC&quot;),    (std::array{1u,0u, 0u,1u,2u})); // CR</span></a>
<a name="1284"><span class="lineNum">    1284 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;AB\nC&quot;),    (std::array{3u,1u, 0u,10u,3u})); // LF</span></a>
<a name="1285"><span class="lineNum">    1285 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;AB\013C&quot;),  (std::array{3u,1u, 0u,10u,3u})); // LF, alias</span></a>
<a name="1286"><span class="lineNum">    1286 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;AB\014C&quot;),  (std::array{3u,1u, 0u,10u,3u})); // LF, alias</span></a>
<a name="1287"><span class="lineNum">    1287 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;AB\033DC&quot;), (std::array{3u,1u, 0u,10u,3u})); // LF, alias</span></a>
<a name="1288"><span class="lineNum">    1288 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;AB\033EC&quot;), (std::array{1u,1u, 0u,8u,3u})); // CR+LF</span></a>
<a name="1289"><span class="lineNum">    1289 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;AB\033EC&quot;), (std::array{1u,1u, 0u,8u,3u})); // CR+LF</span></a>
<a name="1290"><span class="lineNum">    1290 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;AAAAAAAA&quot;), (std::array{7u,0u, 0u,7u,8u})); // test word wrap</span></a>
<a name="1291"><span class="lineNum">    1291 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;AAAAAAAAA&quot;),(std::array{1u,1u, 0u,8u,9u})); // test word wrap+1</span></a>
<a name="1292"><span class="lineNum">    1292 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;A\r\nB\r\nC\r\nAAAAAAAA&quot;),(std::array{7u,3u, 0u,037u,11u})); // right-bottom column</span></a>
<a name="1293"><span class="lineNum">    1293 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;A\r\nB\r\nC\r\nD\r\n&quot;),   (std::array{0u,3u, 0u,020u,3u}));  // scroll down</span></a>
<a name="1294"><span class="lineNum">    1294 </span>                :            :     // Absolute</a>
<a name="1295"><span class="lineNum">    1295 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;2H&quot;),         (std::array{1u,1u, 0u,0u,0u}));</span></a>
<a name="1296"><span class="lineNum">    1296 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[1;1H&quot;),         (std::array{0u,0u, 0u,0u,0u}));</span></a>
<a name="1297"><span class="lineNum">    1297 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;2H\33[1;1H&quot;), (std::array{0u,0u, 0u,0u,0u}));</span></a>
<a name="1298"><span class="lineNum">    1298 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[8;1H&quot;),         (std::array{0u,3u, 0u,0u,0u})); // clamped</span></a>
<a name="1299"><span class="lineNum">    1299 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[1;8H&quot;),         (std::array{7u,0u, 0u,0u,0u})); // clamped</span></a>
<a name="1300"><span class="lineNum">    1300 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;4H&quot;),         (std::array{3u,1u, 0u,0u,0u}));</span></a>
<a name="1301"><span class="lineNum">    1301 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;4;5H&quot;),       (std::array{3u,1u, 0u,0u,0u})); // extra param</span></a>
<a name="1302"><span class="lineNum">    1302 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;2H\33[H&quot;),    (std::array{0u,0u, 0u,0u,0u})); // no params</span></a>
<a name="1303"><span class="lineNum">    1303 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;2H\33[0;0H&quot;), (std::array{0u,0u, 0u,0u,0u})); // zero params</span></a>
<a name="1304"><span class="lineNum">    1304 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H&quot;),         (std::array{7u,3u, 0u,0u,0u})); // bottom-right corner</span></a>
<a name="1305"><span class="lineNum">    1305 </span>                :            :     // Same set with 'f'</a>
<a name="1306"><span class="lineNum">    1306 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;2f&quot;),         (std::array{1u,1u, 0u,0u,0u}));</span></a>
<a name="1307"><span class="lineNum">    1307 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[1;1f&quot;),         (std::array{0u,0u, 0u,0u,0u}));</span></a>
<a name="1308"><span class="lineNum">    1308 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;2H\33[1;1f&quot;), (std::array{0u,0u, 0u,0u,0u}));</span></a>
<a name="1309"><span class="lineNum">    1309 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[8;1f&quot;),         (std::array{0u,3u, 0u,0u,0u})); // clamped</span></a>
<a name="1310"><span class="lineNum">    1310 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[1;8f&quot;),         (std::array{7u,0u, 0u,0u,0u})); // clamped</span></a>
<a name="1311"><span class="lineNum">    1311 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;4f&quot;),         (std::array{3u,1u, 0u,0u,0u}));</span></a>
<a name="1312"><span class="lineNum">    1312 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;4;5f&quot;),       (std::array{3u,1u, 0u,0u,0u})); // extra param</span></a>
<a name="1313"><span class="lineNum">    1313 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;2H\33[f&quot;),    (std::array{0u,0u, 0u,0u,0u})); // no params</span></a>
<a name="1314"><span class="lineNum">    1314 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;2H\33[0;0f&quot;), (std::array{0u,0u, 0u,0u,0u})); // zero params</span></a>
<a name="1315"><span class="lineNum">    1315 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8f&quot;),         (std::array{7u,3u, 0u,0u,0u})); // bottom-right corner</span></a>
<a name="1316"><span class="lineNum">    1316 </span>                :            :     // Right</a>
<a name="1317"><span class="lineNum">    1317 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[C&quot;),     (std::array{1u,0u, 0u,0u,0u}));</span></a>
<a name="1318"><span class="lineNum">    1318 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[1C&quot;),    (std::array{1u,0u, 0u,0u,0u}));</span></a>
<a name="1319"><span class="lineNum">    1319 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4C&quot;),    (std::array{4u,0u, 0u,0u,0u}));</span></a>
<a name="1320"><span class="lineNum">    1320 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[8C&quot;),    (std::array{7u,0u, 0u,0u,0u}));</span></a>
<a name="1321"><span class="lineNum">    1321 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;3H\33[2a&quot;), (std::array{4u,1u, 0u,0u,0u})); // a = alias to C</span></a>
<a name="1322"><span class="lineNum">    1322 </span>                :            :     // Down</a>
<a name="1323"><span class="lineNum">    1323 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[B&quot;),     (std::array{0u,1u, 0u,0u,0u}));</span></a>
<a name="1324"><span class="lineNum">    1324 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[1B&quot;),    (std::array{0u,1u, 0u,0u,0u}));</span></a>
<a name="1325"><span class="lineNum">    1325 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2B&quot;),    (std::array{0u,2u, 0u,0u,0u}));</span></a>
<a name="1326"><span class="lineNum">    1326 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[8B&quot;),    (std::array{0u,3u, 0u,0u,0u}));</span></a>
<a name="1327"><span class="lineNum">    1327 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;3H\33[2e&quot;), (std::array{2u,3u, 0u,0u,0u})); // e = alias to B</span></a>
<a name="1328"><span class="lineNum">    1328 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[2;3H\33[2E&quot;), (std::array{0u,3u, 0u,0u,0u})); // E = alias to e, resets X to 0</span></a>
<a name="1329"><span class="lineNum">    1329 </span>                :            :     // Up</a>
<a name="1330"><span class="lineNum">    1330 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H\33[A&quot;),     (std::array{7u,2u, 0u,0u,0u}));</span></a>
<a name="1331"><span class="lineNum">    1331 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H\33[1A&quot;),    (std::array{7u,2u, 0u,0u,0u}));</span></a>
<a name="1332"><span class="lineNum">    1332 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H\33[2A&quot;),    (std::array{7u,1u, 0u,0u,0u}));</span></a>
<a name="1333"><span class="lineNum">    1333 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H\33[8A&quot;),    (std::array{7u,0u, 0u,0u,0u}));</span></a>
<a name="1334"><span class="lineNum">    1334 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H\33[1F&quot;),    (std::array{0u,2u, 0u,0u,0u})); // F = same as A, puts X to 0</span></a>
<a name="1335"><span class="lineNum">    1335 </span>                :            :     // Left</a>
<a name="1336"><span class="lineNum">    1336 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H\33[D&quot;),     (std::array{6u,3u, 0u,0u,0u}));</span></a>
<a name="1337"><span class="lineNum">    1337 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H\33[1D&quot;),    (std::array{6u,3u, 0u,0u,0u}));</span></a>
<a name="1338"><span class="lineNum">    1338 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H\33[2D&quot;),    (std::array{5u,3u, 0u,0u,0u}));</span></a>
<a name="1339"><span class="lineNum">    1339 </span>                :<span class="lineCov">          3 :     EXPECT_EQ(TerminalTestCursor(8,4, U&quot;\33[4;8H\33[8D&quot;),    (std::array{0u,3u, 0u,0u,0u}));</span></a>
<a name="1340"><span class="lineNum">    1340 </span>                :<span class="lineCov">          1 : }</span></a>
<a name="1341"><span class="lineNum">    1341 </span>                :<span class="lineCov">          3 : TEST(terminal, scs)</span></a>
<a name="1342"><span class="lineNum">    1342 </span>                :            : {</a>
<a name="1343"><span class="lineNum">    1343 </span>                :<span class="lineCov">          1 :     char32_t pattern[] = U&quot;\033)0\016z\017&quot;;</span></a>
<a name="1344"><span class="lineNum">    1344 </span>                :<span class="lineCov">          1 :     char32_t symbols[] = U&quot;012`45679ABCEfFHKLMQR&lt;=&gt;UYZ&quot;;</span></a>
<a name="1345"><span class="lineNum">    1345 </span>        [<span class="branchCov" title="Branch 0 was taken 28 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         29 :     for(char32_t c: symbols)</span></a>
<a name="1346"><span class="lineNum">    1346 </span>                :            :     {</a>
<a name="1347"><span class="lineNum">    1347 </span>                :<span class="lineCov">         28 :         char32_t expect = 'z';</span></a>
<a name="1348"><span class="lineNum">    1348 </span>                :<span class="lineCov">         28 :         pattern[2] = c;</span></a>
<a name="1349"><span class="lineNum">    1349 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 27 times"> + </span>]:<span class="lineCov">         28 :         if(c == U'0') expect = U'\u2265';</span></a>
<a name="1350"><span class="lineNum">    1350 </span>        [<span class="branchCov" title="Branch 0 was taken 27 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         28 :         if(c)</span></a>
<a name="1351"><span class="lineNum">    1351 </span>                :            :         {</a>
<a name="1352"><span class="lineNum">    1352 </span>                :<span class="lineCov">        108 :             EXPECT_EQ(TerminalTest(pattern, [&amp;](auto&amp; wnd) { return wnd.cells[0].ch; }), expect);</span></a>
<a name="1353"><span class="lineNum">    1353 </span>                :            :         }</a>
<a name="1354"><span class="lineNum">    1354 </span>                :            :     }</a>
<a name="1355"><span class="lineNum">    1355 </span>                :<span class="lineCov">          1 : }</span></a>
<a name="1356"><span class="lineNum">    1356 </span>                :            : </a>
<a name="1357"><span class="lineNum">    1357 </span>                :            : #include &lt;fstream&gt;</a>
<a name="1358"><span class="lineNum">    1358 </span>                :<span class="lineCov">          3 : TEST(terminal, stress_test)</span></a>
<a name="1359"><span class="lineNum">    1359 </span>                :            : {</a>
<a name="1360"><span class="lineNum">    1360 </span>                :<span class="lineCov">          1 :     Window wnd(4, 4);</span></a>
<a name="1361"><span class="lineNum">    1361 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     TerminalWindow term(wnd);</span></a>
<a name="1362"><span class="lineNum">    1362 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     term.Resize(80, 25);</span></a>
<a name="1363"><span class="lineNum">    1363 </span>                :            : </a>
<a name="1364"><span class="lineNum">    1364 </span>                :            :     // Issue the patterns from the following files:</a>
<a name="1365"><span class="lineNum">    1365 </span>                :<span class="lineCov">          5 :     for(std::string s: {&quot;test/escapes.txt&quot;, &quot;test/xterm-symbols.txt&quot;, &quot;test/xterm-symbols2.txt&quot;,</span></a>
<a name="1366"><span class="lineNum">    1366 </span>  [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">          5 :                         &quot;test/ocs_dcs.txt&quot;})</span></a>
<a name="1367"><span class="lineNum">    1367 </span>                :            :     {</a>
<a name="1368"><span class="lineNum">    1368 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          4 :         std::ifstream f(s);</span></a>
<a name="1369"><span class="lineNum">    1369 </span>  [<span class="branchCov" title="Branch 0 was taken 380 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 376 times"> + </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span>]:<span class="lineCov">        380 :         for(std::string line; std::getline(f,line), f; )</span></a>
<a name="1370"><span class="lineNum">    1370 </span>  [<span class="branchCov" title="Branch 0 was taken 376 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 376 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        752 :             term.Write(FromUTF8(line));</span></a>
<a name="1371"><span class="lineNum">    1371 </span>                :<span class="lineCov">          4 :     }</span></a>
<a name="1372"><span class="lineNum">    1372 </span>  [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :     std::u32string result(term.OutBuffer.begin(), term.OutBuffer.end());</span></a>
<a name="1373"><span class="lineNum">    1373 </span>                :<span class="lineCov">          1 :     EXPECT_EQ(result,</span></a>
<a name="1374"><span class="lineNum">    1374 </span>                :            :         U&quot;\33[?65;1;6;8;15;22c\33[?65;1;6;8;15;22c\33[0n\33[1;1R\033P!|00000000\x9C\33[&gt;1;1;0c\33[?65;1;6;8;15;22c\33[?25;1$y\33[12;4$y\33[20;4$y&quot;</a>
<a name="1375"><span class="lineNum">    1375 </span>                :            :         U&quot;\x18\033$P1$r0;24r\033\\\033$P1$r38;2;204;204;204;48;2;0;0;0m\033\\\033$P1$r24t\033\\\033$P1$r1 q\033\\\033$P1$r0\&quot;q\033\\\033$P1$r64;1\&quot;p\033\\\033$P1$r80$|\033\\\033$P1$r25*|\033\\&quot;</a>
<a name="1376"><span class="lineNum">    1376 </span>                :<span class="lineCov">          1 :     );</span></a>
<a name="1377"><span class="lineNum">    1377 </span>                :<span class="lineCov">          1 : }</span></a>
<a name="1378"><span class="lineNum">    1378 </span>                :            : </a>
<a name="1379"><span class="lineNum">    1379 </span>                :            : #endif</a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="https://github.com/linux-test-project/lcov" target="_parent">LCOV version 1.16</a></td></tr>
  </table>
  <br>

</body>
</html>
